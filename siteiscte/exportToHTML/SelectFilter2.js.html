<html>
<head>
<title>SelectFilter2.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #6aab73;}
.s3 { color: #bcbec4;}
.s4 { color: #cf8e6d;}
.s5 { color: #42c3d4;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
SelectFilter2.js</font>
</center></td></tr></table>
<pre><span class="s0">/*global SelectBox, gettext, interpolate, quickElement, SelectFilter*/</span>
<span class="s0">/* 
SelectFilter2 - Turns a multiple-select box into a filter interface. 
 
Requires core.js and SelectBox.js. 
*/</span>
<span class="s2">'use strict'</span><span class="s3">;</span>
<span class="s3">{</span>
    <span class="s1">window</span><span class="s3">.</span><span class="s1">SelectFilter </span><span class="s3">= {</span>
        <span class="s1">init</span><span class="s3">: </span><span class="s4">function</span><span class="s3">(</span><span class="s1">field_id</span><span class="s3">, </span><span class="s1">field_name</span><span class="s3">, </span><span class="s1">is_stacked</span><span class="s3">) {</span>
            <span class="s4">if </span><span class="s3">(</span><span class="s1">field_id</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s5">/__prefix__/</span><span class="s3">)) {</span>
                <span class="s0">// Don't initialize on empty forms.</span>
                <span class="s4">return</span><span class="s3">;</span>
            <span class="s3">}</span>
            <span class="s4">const </span><span class="s1">from_box </span><span class="s3">= </span><span class="s1">document</span><span class="s3">.</span><span class="s1">getElementById</span><span class="s3">(</span><span class="s1">field_id</span><span class="s3">);</span>
            <span class="s1">from_box</span><span class="s3">.</span><span class="s1">id </span><span class="s3">+= </span><span class="s2">'_from'</span><span class="s3">; </span><span class="s0">// change its ID</span>
            <span class="s1">from_box</span><span class="s3">.</span><span class="s1">className </span><span class="s3">= </span><span class="s2">'filtered'</span><span class="s3">;</span>

            <span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">p of from_box</span><span class="s3">.</span><span class="s1">parentNode</span><span class="s3">.</span><span class="s1">getElementsByTagName</span><span class="s3">(</span><span class="s2">'p'</span><span class="s3">)) {</span>
                <span class="s4">if </span><span class="s3">(</span><span class="s1">p</span><span class="s3">.</span><span class="s1">classList</span><span class="s3">.</span><span class="s1">contains</span><span class="s3">(</span><span class="s2">&quot;info&quot;</span><span class="s3">)) {</span>
                    <span class="s0">// Remove &lt;p class=&quot;info&quot;&gt;, because it just gets in the way.</span>
                    <span class="s1">from_box</span><span class="s3">.</span><span class="s1">parentNode</span><span class="s3">.</span><span class="s1">removeChild</span><span class="s3">(</span><span class="s1">p</span><span class="s3">);</span>
                <span class="s3">} </span><span class="s4">else if </span><span class="s3">(</span><span class="s1">p</span><span class="s3">.</span><span class="s1">classList</span><span class="s3">.</span><span class="s1">contains</span><span class="s3">(</span><span class="s2">&quot;help&quot;</span><span class="s3">)) {</span>
                    <span class="s0">// Move help text up to the top so it isn't below the select</span>
                    <span class="s0">// boxes or wrapped off on the side to the right of the add</span>
                    <span class="s0">// button:</span>
                    <span class="s1">from_box</span><span class="s3">.</span><span class="s1">parentNode</span><span class="s3">.</span><span class="s1">insertBefore</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s1">from_box</span><span class="s3">.</span><span class="s1">parentNode</span><span class="s3">.</span><span class="s1">firstChild</span><span class="s3">);</span>
                <span class="s3">}</span>
            <span class="s3">}</span>

            <span class="s0">// &lt;div class=&quot;selector&quot;&gt; or &lt;div class=&quot;selector stacked&quot;&gt;</span>
            <span class="s4">const </span><span class="s1">selector_div </span><span class="s3">= </span><span class="s1">quickElement</span><span class="s3">(</span><span class="s2">'div'</span><span class="s3">, </span><span class="s1">from_box</span><span class="s3">.</span><span class="s1">parentNode</span><span class="s3">);</span>
            <span class="s0">// Make sure the selector div is at the beginning so that the</span>
            <span class="s0">// add link would be displayed to the right of the widget.</span>
            <span class="s1">from_box</span><span class="s3">.</span><span class="s1">parentNode</span><span class="s3">.</span><span class="s1">prepend</span><span class="s3">(</span><span class="s1">selector_div</span><span class="s3">);</span>
            <span class="s1">selector_div</span><span class="s3">.</span><span class="s1">className </span><span class="s3">= </span><span class="s1">is_stacked </span><span class="s3">? </span><span class="s2">'selector stacked' </span><span class="s3">: </span><span class="s2">'selector'</span><span class="s3">;</span>

            <span class="s0">// &lt;div class=&quot;selector-available&quot;&gt;</span>
            <span class="s4">const </span><span class="s1">selector_available </span><span class="s3">= </span><span class="s1">quickElement</span><span class="s3">(</span><span class="s2">'div'</span><span class="s3">, </span><span class="s1">selector_div</span><span class="s3">);</span>
            <span class="s1">selector_available</span><span class="s3">.</span><span class="s1">className </span><span class="s3">= </span><span class="s2">'selector-available'</span><span class="s3">;</span>
            <span class="s4">const </span><span class="s1">title_available </span><span class="s3">= </span><span class="s1">quickElement</span><span class="s3">(</span><span class="s2">'h2'</span><span class="s3">, </span><span class="s1">selector_available</span><span class="s3">, </span><span class="s1">interpolate</span><span class="s3">(</span><span class="s1">gettext</span><span class="s3">(</span><span class="s2">'Available %s'</span><span class="s3">) + </span><span class="s2">' '</span><span class="s3">, [</span><span class="s1">field_name</span><span class="s3">]));</span>
            <span class="s1">quickElement</span><span class="s3">(</span>
                <span class="s2">'span'</span><span class="s3">, </span><span class="s1">title_available</span><span class="s3">, </span><span class="s2">''</span><span class="s3">,</span>
                <span class="s2">'class'</span><span class="s3">, </span><span class="s2">'help help-tooltip help-icon'</span><span class="s3">,</span>
                <span class="s2">'title'</span><span class="s3">, </span><span class="s1">interpolate</span><span class="s3">(</span>
                    <span class="s1">gettext</span><span class="s3">(</span>
                        <span class="s2">'This is the list of available %s. You may choose some by ' </span><span class="s3">+</span>
                        <span class="s2">'selecting them in the box below and then clicking the ' </span><span class="s3">+</span>
                        <span class="s2">'&quot;Choose&quot; arrow between the two boxes.'</span>
                    <span class="s3">),</span>
                    <span class="s3">[</span><span class="s1">field_name</span><span class="s3">]</span>
                <span class="s3">)</span>
            <span class="s3">);</span>

            <span class="s4">const </span><span class="s1">filter_p </span><span class="s3">= </span><span class="s1">quickElement</span><span class="s3">(</span><span class="s2">'p'</span><span class="s3">, </span><span class="s1">selector_available</span><span class="s3">, </span><span class="s2">''</span><span class="s3">, </span><span class="s2">'id'</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_filter'</span><span class="s3">);</span>
            <span class="s1">filter_p</span><span class="s3">.</span><span class="s1">className </span><span class="s3">= </span><span class="s2">'selector-filter'</span><span class="s3">;</span>

            <span class="s4">const </span><span class="s1">search_filter_label </span><span class="s3">= </span><span class="s1">quickElement</span><span class="s3">(</span><span class="s2">'label'</span><span class="s3">, </span><span class="s1">filter_p</span><span class="s3">, </span><span class="s2">''</span><span class="s3">, </span><span class="s2">'for'</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_input'</span><span class="s3">);</span>

            <span class="s1">quickElement</span><span class="s3">(</span>
                <span class="s2">'span'</span><span class="s3">, </span><span class="s1">search_filter_label</span><span class="s3">, </span><span class="s2">''</span><span class="s3">,</span>
                <span class="s2">'class'</span><span class="s3">, </span><span class="s2">'help-tooltip search-label-icon'</span><span class="s3">,</span>
                <span class="s2">'title'</span><span class="s3">, </span><span class="s1">interpolate</span><span class="s3">(</span><span class="s1">gettext</span><span class="s3">(</span><span class="s2">&quot;Type into this box to filter down the list of available %s.&quot;</span><span class="s3">), [</span><span class="s1">field_name</span><span class="s3">])</span>
            <span class="s3">);</span>

            <span class="s1">filter_p</span><span class="s3">.</span><span class="s1">appendChild</span><span class="s3">(</span><span class="s1">document</span><span class="s3">.</span><span class="s1">createTextNode</span><span class="s3">(</span><span class="s2">' '</span><span class="s3">));</span>

            <span class="s4">const </span><span class="s1">filter_input </span><span class="s3">= </span><span class="s1">quickElement</span><span class="s3">(</span><span class="s2">'input'</span><span class="s3">, </span><span class="s1">filter_p</span><span class="s3">, </span><span class="s2">''</span><span class="s3">, </span><span class="s2">'type'</span><span class="s3">, </span><span class="s2">'text'</span><span class="s3">, </span><span class="s2">'placeholder'</span><span class="s3">, </span><span class="s1">gettext</span><span class="s3">(</span><span class="s2">&quot;Filter&quot;</span><span class="s3">));</span>
            <span class="s1">filter_input</span><span class="s3">.</span><span class="s1">id </span><span class="s3">= </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_input'</span><span class="s3">;</span>

            <span class="s1">selector_available</span><span class="s3">.</span><span class="s1">appendChild</span><span class="s3">(</span><span class="s1">from_box</span><span class="s3">);</span>
            <span class="s4">const </span><span class="s1">choose_all </span><span class="s3">= </span><span class="s1">quickElement</span><span class="s3">(</span><span class="s2">'a'</span><span class="s3">, </span><span class="s1">selector_available</span><span class="s3">, </span><span class="s1">gettext</span><span class="s3">(</span><span class="s2">'Choose all'</span><span class="s3">), </span><span class="s2">'title'</span><span class="s3">, </span><span class="s1">interpolate</span><span class="s3">(</span><span class="s1">gettext</span><span class="s3">(</span><span class="s2">'Click to choose all %s at once.'</span><span class="s3">), [</span><span class="s1">field_name</span><span class="s3">]), </span><span class="s2">'href'</span><span class="s3">, </span><span class="s2">'#'</span><span class="s3">, </span><span class="s2">'id'</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_add_all_link'</span><span class="s3">);</span>
            <span class="s1">choose_all</span><span class="s3">.</span><span class="s1">className </span><span class="s3">= </span><span class="s2">'selector-chooseall'</span><span class="s3">;</span>

            <span class="s0">// &lt;ul class=&quot;selector-chooser&quot;&gt;</span>
            <span class="s4">const </span><span class="s1">selector_chooser </span><span class="s3">= </span><span class="s1">quickElement</span><span class="s3">(</span><span class="s2">'ul'</span><span class="s3">, </span><span class="s1">selector_div</span><span class="s3">);</span>
            <span class="s1">selector_chooser</span><span class="s3">.</span><span class="s1">className </span><span class="s3">= </span><span class="s2">'selector-chooser'</span><span class="s3">;</span>
            <span class="s4">const </span><span class="s1">add_link </span><span class="s3">= </span><span class="s1">quickElement</span><span class="s3">(</span><span class="s2">'a'</span><span class="s3">, </span><span class="s1">quickElement</span><span class="s3">(</span><span class="s2">'li'</span><span class="s3">, </span><span class="s1">selector_chooser</span><span class="s3">), </span><span class="s1">gettext</span><span class="s3">(</span><span class="s2">'Choose'</span><span class="s3">), </span><span class="s2">'title'</span><span class="s3">, </span><span class="s1">gettext</span><span class="s3">(</span><span class="s2">'Choose'</span><span class="s3">), </span><span class="s2">'href'</span><span class="s3">, </span><span class="s2">'#'</span><span class="s3">, </span><span class="s2">'id'</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_add_link'</span><span class="s3">);</span>
            <span class="s1">add_link</span><span class="s3">.</span><span class="s1">className </span><span class="s3">= </span><span class="s2">'selector-add'</span><span class="s3">;</span>
            <span class="s4">const </span><span class="s1">remove_link </span><span class="s3">= </span><span class="s1">quickElement</span><span class="s3">(</span><span class="s2">'a'</span><span class="s3">, </span><span class="s1">quickElement</span><span class="s3">(</span><span class="s2">'li'</span><span class="s3">, </span><span class="s1">selector_chooser</span><span class="s3">), </span><span class="s1">gettext</span><span class="s3">(</span><span class="s2">'Remove'</span><span class="s3">), </span><span class="s2">'title'</span><span class="s3">, </span><span class="s1">gettext</span><span class="s3">(</span><span class="s2">'Remove'</span><span class="s3">), </span><span class="s2">'href'</span><span class="s3">, </span><span class="s2">'#'</span><span class="s3">, </span><span class="s2">'id'</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_remove_link'</span><span class="s3">);</span>
            <span class="s1">remove_link</span><span class="s3">.</span><span class="s1">className </span><span class="s3">= </span><span class="s2">'selector-remove'</span><span class="s3">;</span>

            <span class="s0">// &lt;div class=&quot;selector-chosen&quot;&gt;</span>
            <span class="s4">const </span><span class="s1">selector_chosen </span><span class="s3">= </span><span class="s1">quickElement</span><span class="s3">(</span><span class="s2">'div'</span><span class="s3">, </span><span class="s1">selector_div</span><span class="s3">, </span><span class="s2">''</span><span class="s3">, </span><span class="s2">'id'</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_selector_chosen'</span><span class="s3">);</span>
            <span class="s1">selector_chosen</span><span class="s3">.</span><span class="s1">className </span><span class="s3">= </span><span class="s2">'selector-chosen'</span><span class="s3">;</span>
            <span class="s4">const </span><span class="s1">title_chosen </span><span class="s3">= </span><span class="s1">quickElement</span><span class="s3">(</span><span class="s2">'h2'</span><span class="s3">, </span><span class="s1">selector_chosen</span><span class="s3">, </span><span class="s1">interpolate</span><span class="s3">(</span><span class="s1">gettext</span><span class="s3">(</span><span class="s2">'Chosen %s'</span><span class="s3">) + </span><span class="s2">' '</span><span class="s3">, [</span><span class="s1">field_name</span><span class="s3">]));</span>
            <span class="s1">quickElement</span><span class="s3">(</span>
                <span class="s2">'span'</span><span class="s3">, </span><span class="s1">title_chosen</span><span class="s3">, </span><span class="s2">''</span><span class="s3">,</span>
                <span class="s2">'class'</span><span class="s3">, </span><span class="s2">'help help-tooltip help-icon'</span><span class="s3">,</span>
                <span class="s2">'title'</span><span class="s3">, </span><span class="s1">interpolate</span><span class="s3">(</span>
                    <span class="s1">gettext</span><span class="s3">(</span>
                        <span class="s2">'This is the list of chosen %s. You may remove some by ' </span><span class="s3">+</span>
                        <span class="s2">'selecting them in the box below and then clicking the ' </span><span class="s3">+</span>
                        <span class="s2">'&quot;Remove&quot; arrow between the two boxes.'</span>
                    <span class="s3">),</span>
                    <span class="s3">[</span><span class="s1">field_name</span><span class="s3">]</span>
                <span class="s3">)</span>
            <span class="s3">);</span>
            
            <span class="s4">const </span><span class="s1">filter_selected_p </span><span class="s3">= </span><span class="s1">quickElement</span><span class="s3">(</span><span class="s2">'p'</span><span class="s3">, </span><span class="s1">selector_chosen</span><span class="s3">, </span><span class="s2">''</span><span class="s3">, </span><span class="s2">'id'</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_filter_selected'</span><span class="s3">);</span>
            <span class="s1">filter_selected_p</span><span class="s3">.</span><span class="s1">className </span><span class="s3">= </span><span class="s2">'selector-filter'</span><span class="s3">;</span>

            <span class="s4">const </span><span class="s1">search_filter_selected_label </span><span class="s3">= </span><span class="s1">quickElement</span><span class="s3">(</span><span class="s2">'label'</span><span class="s3">, </span><span class="s1">filter_selected_p</span><span class="s3">, </span><span class="s2">''</span><span class="s3">, </span><span class="s2">'for'</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_selected_input'</span><span class="s3">);</span>

            <span class="s1">quickElement</span><span class="s3">(</span>
                <span class="s2">'span'</span><span class="s3">, </span><span class="s1">search_filter_selected_label</span><span class="s3">, </span><span class="s2">''</span><span class="s3">,</span>
                <span class="s2">'class'</span><span class="s3">, </span><span class="s2">'help-tooltip search-label-icon'</span><span class="s3">,</span>
                <span class="s2">'title'</span><span class="s3">, </span><span class="s1">interpolate</span><span class="s3">(</span><span class="s1">gettext</span><span class="s3">(</span><span class="s2">&quot;Type into this box to filter down the list of selected %s.&quot;</span><span class="s3">), [</span><span class="s1">field_name</span><span class="s3">])</span>
            <span class="s3">);</span>

            <span class="s1">filter_selected_p</span><span class="s3">.</span><span class="s1">appendChild</span><span class="s3">(</span><span class="s1">document</span><span class="s3">.</span><span class="s1">createTextNode</span><span class="s3">(</span><span class="s2">' '</span><span class="s3">));</span>

            <span class="s4">const </span><span class="s1">filter_selected_input </span><span class="s3">= </span><span class="s1">quickElement</span><span class="s3">(</span><span class="s2">'input'</span><span class="s3">, </span><span class="s1">filter_selected_p</span><span class="s3">, </span><span class="s2">''</span><span class="s3">, </span><span class="s2">'type'</span><span class="s3">, </span><span class="s2">'text'</span><span class="s3">, </span><span class="s2">'placeholder'</span><span class="s3">, </span><span class="s1">gettext</span><span class="s3">(</span><span class="s2">&quot;Filter&quot;</span><span class="s3">));</span>
            <span class="s1">filter_selected_input</span><span class="s3">.</span><span class="s1">id </span><span class="s3">= </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_selected_input'</span><span class="s3">;</span>

            <span class="s4">const </span><span class="s1">to_box </span><span class="s3">= </span><span class="s1">quickElement</span><span class="s3">(</span><span class="s2">'select'</span><span class="s3">, </span><span class="s1">selector_chosen</span><span class="s3">, </span><span class="s2">''</span><span class="s3">, </span><span class="s2">'id'</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_to'</span><span class="s3">, </span><span class="s2">'multiple'</span><span class="s3">, </span><span class="s2">''</span><span class="s3">, </span><span class="s2">'size'</span><span class="s3">, </span><span class="s1">from_box</span><span class="s3">.</span><span class="s1">size</span><span class="s3">, </span><span class="s2">'name'</span><span class="s3">, </span><span class="s1">from_box</span><span class="s3">.</span><span class="s1">name</span><span class="s3">);</span>
            <span class="s1">to_box</span><span class="s3">.</span><span class="s1">className </span><span class="s3">= </span><span class="s2">'filtered'</span><span class="s3">;</span>
            
            <span class="s4">const </span><span class="s1">warning_footer </span><span class="s3">= </span><span class="s1">quickElement</span><span class="s3">(</span><span class="s2">'div'</span><span class="s3">, </span><span class="s1">selector_chosen</span><span class="s3">, </span><span class="s2">''</span><span class="s3">, </span><span class="s2">'class'</span><span class="s3">, </span><span class="s2">'list-footer-display'</span><span class="s3">);</span>
            <span class="s1">quickElement</span><span class="s3">(</span><span class="s2">'span'</span><span class="s3">, </span><span class="s1">warning_footer</span><span class="s3">, </span><span class="s2">''</span><span class="s3">, </span><span class="s2">'id'</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_list-footer-display-text'</span><span class="s3">);</span>
            <span class="s1">quickElement</span><span class="s3">(</span><span class="s2">'span'</span><span class="s3">, </span><span class="s1">warning_footer</span><span class="s3">, </span><span class="s2">' (click to clear)'</span><span class="s3">, </span><span class="s2">'class'</span><span class="s3">, </span><span class="s2">'list-footer-display__clear'</span><span class="s3">);</span>
            
            <span class="s4">const </span><span class="s1">clear_all </span><span class="s3">= </span><span class="s1">quickElement</span><span class="s3">(</span><span class="s2">'a'</span><span class="s3">, </span><span class="s1">selector_chosen</span><span class="s3">, </span><span class="s1">gettext</span><span class="s3">(</span><span class="s2">'Remove all'</span><span class="s3">), </span><span class="s2">'title'</span><span class="s3">, </span><span class="s1">interpolate</span><span class="s3">(</span><span class="s1">gettext</span><span class="s3">(</span><span class="s2">'Click to remove all chosen %s at once.'</span><span class="s3">), [</span><span class="s1">field_name</span><span class="s3">]), </span><span class="s2">'href'</span><span class="s3">, </span><span class="s2">'#'</span><span class="s3">, </span><span class="s2">'id'</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_remove_all_link'</span><span class="s3">);</span>
            <span class="s1">clear_all</span><span class="s3">.</span><span class="s1">className </span><span class="s3">= </span><span class="s2">'selector-clearall'</span><span class="s3">;</span>

            <span class="s1">from_box</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s1">from_box</span><span class="s3">.</span><span class="s1">name </span><span class="s3">+ </span><span class="s2">'_old'</span><span class="s3">;</span>

            <span class="s0">// Set up the JavaScript event handlers for the select box filter interface</span>
            <span class="s4">const </span><span class="s1">move_selection </span><span class="s3">= </span><span class="s4">function</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s1">elem</span><span class="s3">, </span><span class="s1">move_func</span><span class="s3">, </span><span class="s1">from</span><span class="s3">, </span><span class="s1">to</span><span class="s3">) {</span>
                <span class="s4">if </span><span class="s3">(</span><span class="s1">elem</span><span class="s3">.</span><span class="s1">classList</span><span class="s3">.</span><span class="s1">contains</span><span class="s3">(</span><span class="s2">'active'</span><span class="s3">)) {</span>
                    <span class="s1">move_func</span><span class="s3">(</span><span class="s1">from</span><span class="s3">, </span><span class="s1">to</span><span class="s3">);</span>
                    <span class="s1">SelectFilter</span><span class="s3">.</span><span class="s1">refresh_icons</span><span class="s3">(</span><span class="s1">field_id</span><span class="s3">);</span>
                    <span class="s1">SelectFilter</span><span class="s3">.</span><span class="s1">refresh_filtered_selects</span><span class="s3">(</span><span class="s1">field_id</span><span class="s3">);</span>
                    <span class="s1">SelectFilter</span><span class="s3">.</span><span class="s1">refresh_filtered_warning</span><span class="s3">(</span><span class="s1">field_id</span><span class="s3">);</span>
                <span class="s3">}</span>
                <span class="s1">e</span><span class="s3">.</span><span class="s1">preventDefault</span><span class="s3">();</span>
            <span class="s3">};</span>
            <span class="s1">choose_all</span><span class="s3">.</span><span class="s1">addEventListener</span><span class="s3">(</span><span class="s2">'click'</span><span class="s3">, </span><span class="s4">function</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) {</span>
                <span class="s1">move_selection</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s4">this</span><span class="s3">, </span><span class="s1">SelectBox</span><span class="s3">.</span><span class="s1">move_all</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_from'</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_to'</span><span class="s3">);</span>
            <span class="s3">});</span>
            <span class="s1">add_link</span><span class="s3">.</span><span class="s1">addEventListener</span><span class="s3">(</span><span class="s2">'click'</span><span class="s3">, </span><span class="s4">function</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) {</span>
                <span class="s1">move_selection</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s4">this</span><span class="s3">, </span><span class="s1">SelectBox</span><span class="s3">.</span><span class="s1">move</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_from'</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_to'</span><span class="s3">);</span>
            <span class="s3">});</span>
            <span class="s1">remove_link</span><span class="s3">.</span><span class="s1">addEventListener</span><span class="s3">(</span><span class="s2">'click'</span><span class="s3">, </span><span class="s4">function</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) {</span>
                <span class="s1">move_selection</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s4">this</span><span class="s3">, </span><span class="s1">SelectBox</span><span class="s3">.</span><span class="s1">move</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_to'</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_from'</span><span class="s3">);</span>
            <span class="s3">});</span>
            <span class="s1">clear_all</span><span class="s3">.</span><span class="s1">addEventListener</span><span class="s3">(</span><span class="s2">'click'</span><span class="s3">, </span><span class="s4">function</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) {</span>
                <span class="s1">move_selection</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s4">this</span><span class="s3">, </span><span class="s1">SelectBox</span><span class="s3">.</span><span class="s1">move_all</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_to'</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_from'</span><span class="s3">);</span>
            <span class="s3">});</span>
            <span class="s1">warning_footer</span><span class="s3">.</span><span class="s1">addEventListener</span><span class="s3">(</span><span class="s2">'click'</span><span class="s3">, </span><span class="s4">function</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) {</span>
                <span class="s1">filter_selected_input</span><span class="s3">.</span><span class="s1">value </span><span class="s3">= </span><span class="s2">''</span><span class="s3">;</span>
                <span class="s1">SelectBox</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_to'</span><span class="s3">, </span><span class="s2">''</span><span class="s3">);</span>
                <span class="s1">SelectFilter</span><span class="s3">.</span><span class="s1">refresh_filtered_warning</span><span class="s3">(</span><span class="s1">field_id</span><span class="s3">);</span>
                <span class="s1">SelectFilter</span><span class="s3">.</span><span class="s1">refresh_icons</span><span class="s3">(</span><span class="s1">field_id</span><span class="s3">);</span>
            <span class="s3">});</span>
            <span class="s1">filter_input</span><span class="s3">.</span><span class="s1">addEventListener</span><span class="s3">(</span><span class="s2">'keypress'</span><span class="s3">, </span><span class="s4">function</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) {</span>
                <span class="s1">SelectFilter</span><span class="s3">.</span><span class="s1">filter_key_press</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s1">field_id</span><span class="s3">, </span><span class="s2">'_from'</span><span class="s3">, </span><span class="s2">'_to'</span><span class="s3">);</span>
            <span class="s3">});</span>
            <span class="s1">filter_input</span><span class="s3">.</span><span class="s1">addEventListener</span><span class="s3">(</span><span class="s2">'keyup'</span><span class="s3">, </span><span class="s4">function</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) {</span>
                <span class="s1">SelectFilter</span><span class="s3">.</span><span class="s1">filter_key_up</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s1">field_id</span><span class="s3">, </span><span class="s2">'_from'</span><span class="s3">);</span>
            <span class="s3">});</span>
            <span class="s1">filter_input</span><span class="s3">.</span><span class="s1">addEventListener</span><span class="s3">(</span><span class="s2">'keydown'</span><span class="s3">, </span><span class="s4">function</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) {</span>
                <span class="s1">SelectFilter</span><span class="s3">.</span><span class="s1">filter_key_down</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s1">field_id</span><span class="s3">, </span><span class="s2">'_from'</span><span class="s3">, </span><span class="s2">'_to'</span><span class="s3">);</span>
            <span class="s3">});</span>
            <span class="s1">filter_selected_input</span><span class="s3">.</span><span class="s1">addEventListener</span><span class="s3">(</span><span class="s2">'keypress'</span><span class="s3">, </span><span class="s4">function</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) {</span>
                <span class="s1">SelectFilter</span><span class="s3">.</span><span class="s1">filter_key_press</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s1">field_id</span><span class="s3">, </span><span class="s2">'_to'</span><span class="s3">, </span><span class="s2">'_from'</span><span class="s3">);</span>
            <span class="s3">});</span>
            <span class="s1">filter_selected_input</span><span class="s3">.</span><span class="s1">addEventListener</span><span class="s3">(</span><span class="s2">'keyup'</span><span class="s3">, </span><span class="s4">function</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) {</span>
                <span class="s1">SelectFilter</span><span class="s3">.</span><span class="s1">filter_key_up</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s1">field_id</span><span class="s3">, </span><span class="s2">'_to'</span><span class="s3">, </span><span class="s2">'_selected_input'</span><span class="s3">);</span>
            <span class="s3">});</span>
            <span class="s1">filter_selected_input</span><span class="s3">.</span><span class="s1">addEventListener</span><span class="s3">(</span><span class="s2">'keydown'</span><span class="s3">, </span><span class="s4">function</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) {</span>
                <span class="s1">SelectFilter</span><span class="s3">.</span><span class="s1">filter_key_down</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s1">field_id</span><span class="s3">, </span><span class="s2">'_to'</span><span class="s3">, </span><span class="s2">'_from'</span><span class="s3">);</span>
            <span class="s3">});</span>
            <span class="s1">selector_div</span><span class="s3">.</span><span class="s1">addEventListener</span><span class="s3">(</span><span class="s2">'change'</span><span class="s3">, </span><span class="s4">function</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) {</span>
                <span class="s4">if </span><span class="s3">(</span><span class="s1">e</span><span class="s3">.</span><span class="s1">target</span><span class="s3">.</span><span class="s1">tagName </span><span class="s3">=== </span><span class="s2">'SELECT'</span><span class="s3">) {</span>
                    <span class="s1">SelectFilter</span><span class="s3">.</span><span class="s1">refresh_icons</span><span class="s3">(</span><span class="s1">field_id</span><span class="s3">);</span>
                <span class="s3">}</span>
            <span class="s3">});</span>
            <span class="s1">selector_div</span><span class="s3">.</span><span class="s1">addEventListener</span><span class="s3">(</span><span class="s2">'dblclick'</span><span class="s3">, </span><span class="s4">function</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) {</span>
                <span class="s4">if </span><span class="s3">(</span><span class="s1">e</span><span class="s3">.</span><span class="s1">target</span><span class="s3">.</span><span class="s1">tagName </span><span class="s3">=== </span><span class="s2">'OPTION'</span><span class="s3">) {</span>
                    <span class="s4">if </span><span class="s3">(</span><span class="s1">e</span><span class="s3">.</span><span class="s1">target</span><span class="s3">.</span><span class="s1">closest</span><span class="s3">(</span><span class="s2">'select'</span><span class="s3">).</span><span class="s1">id </span><span class="s3">=== </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_to'</span><span class="s3">) {</span>
                        <span class="s1">SelectBox</span><span class="s3">.</span><span class="s1">move</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_to'</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_from'</span><span class="s3">);</span>
                    <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
                        <span class="s1">SelectBox</span><span class="s3">.</span><span class="s1">move</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_from'</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_to'</span><span class="s3">);</span>
                    <span class="s3">}</span>
                    <span class="s1">SelectFilter</span><span class="s3">.</span><span class="s1">refresh_icons</span><span class="s3">(</span><span class="s1">field_id</span><span class="s3">);</span>
                <span class="s3">}</span>
            <span class="s3">});</span>
            <span class="s1">from_box</span><span class="s3">.</span><span class="s1">closest</span><span class="s3">(</span><span class="s2">'form'</span><span class="s3">).</span><span class="s1">addEventListener</span><span class="s3">(</span><span class="s2">'submit'</span><span class="s3">, </span><span class="s4">function</span><span class="s3">() {</span>
                <span class="s1">SelectBox</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_to'</span><span class="s3">, </span><span class="s2">''</span><span class="s3">);</span>
                <span class="s1">SelectBox</span><span class="s3">.</span><span class="s1">select_all</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_to'</span><span class="s3">);</span>
            <span class="s3">});</span>
            <span class="s1">SelectBox</span><span class="s3">.</span><span class="s1">init</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_from'</span><span class="s3">);</span>
            <span class="s1">SelectBox</span><span class="s3">.</span><span class="s1">init</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_to'</span><span class="s3">);</span>
            <span class="s0">// Move selected from_box options to to_box</span>
            <span class="s1">SelectBox</span><span class="s3">.</span><span class="s1">move</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_from'</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_to'</span><span class="s3">);</span>

            <span class="s0">// Initial icon refresh</span>
            <span class="s1">SelectFilter</span><span class="s3">.</span><span class="s1">refresh_icons</span><span class="s3">(</span><span class="s1">field_id</span><span class="s3">);</span>
        <span class="s3">},</span>
        <span class="s1">any_selected</span><span class="s3">: </span><span class="s4">function</span><span class="s3">(</span><span class="s1">field</span><span class="s3">) {</span>
            <span class="s0">// Temporarily add the required attribute and check validity.</span>
            <span class="s1">field</span><span class="s3">.</span><span class="s1">required </span><span class="s3">= </span><span class="s4">true</span><span class="s3">;</span>
            <span class="s4">const </span><span class="s1">any_selected </span><span class="s3">= </span><span class="s1">field</span><span class="s3">.</span><span class="s1">checkValidity</span><span class="s3">();</span>
            <span class="s1">field</span><span class="s3">.</span><span class="s1">required </span><span class="s3">= </span><span class="s4">false</span><span class="s3">;</span>
            <span class="s4">return </span><span class="s1">any_selected</span><span class="s3">;</span>
        <span class="s3">},</span>
        <span class="s1">refresh_filtered_warning</span><span class="s3">: </span><span class="s4">function</span><span class="s3">(</span><span class="s1">field_id</span><span class="s3">) {</span>
            <span class="s4">const </span><span class="s1">count </span><span class="s3">= </span><span class="s1">SelectBox</span><span class="s3">.</span><span class="s1">get_hidden_node_count</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_to'</span><span class="s3">);</span>
            <span class="s4">const </span><span class="s1">selector </span><span class="s3">= </span><span class="s1">document</span><span class="s3">.</span><span class="s1">getElementById</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_selector_chosen'</span><span class="s3">);</span>
            <span class="s4">const </span><span class="s1">warning </span><span class="s3">= </span><span class="s1">document</span><span class="s3">.</span><span class="s1">getElementById</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_list-footer-display-text'</span><span class="s3">);</span>
            <span class="s1">selector</span><span class="s3">.</span><span class="s1">className </span><span class="s3">= </span><span class="s1">selector</span><span class="s3">.</span><span class="s1">className</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s2">'selector-chosen--with-filtered'</span><span class="s3">, </span><span class="s2">''</span><span class="s3">);</span>
            <span class="s1">warning</span><span class="s3">.</span><span class="s1">textContent </span><span class="s3">= </span><span class="s1">interpolate</span><span class="s3">(</span><span class="s1">ngettext</span><span class="s3">(</span>
                <span class="s2">'%s selected option not visible'</span><span class="s3">,</span>
                <span class="s2">'%s selected options not visible'</span><span class="s3">,</span>
                <span class="s1">count</span>
            <span class="s3">), [</span><span class="s1">count</span><span class="s3">]);</span>
            <span class="s4">if</span><span class="s3">(</span><span class="s1">count </span><span class="s3">&gt; </span><span class="s6">0</span><span class="s3">) {</span>
                <span class="s1">selector</span><span class="s3">.</span><span class="s1">className </span><span class="s3">+= </span><span class="s2">' selector-chosen--with-filtered'</span><span class="s3">;</span>
            <span class="s3">}</span>
        <span class="s3">},</span>
        <span class="s1">refresh_filtered_selects</span><span class="s3">: </span><span class="s4">function</span><span class="s3">(</span><span class="s1">field_id</span><span class="s3">) {</span>
            <span class="s1">SelectBox</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_from'</span><span class="s3">, </span><span class="s1">document</span><span class="s3">.</span><span class="s1">getElementById</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">&quot;_input&quot;</span><span class="s3">).</span><span class="s1">value</span><span class="s3">);</span>
            <span class="s1">SelectBox</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_to'</span><span class="s3">, </span><span class="s1">document</span><span class="s3">.</span><span class="s1">getElementById</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">&quot;_selected_input&quot;</span><span class="s3">).</span><span class="s1">value</span><span class="s3">);</span>
        <span class="s3">},</span>
        <span class="s1">refresh_icons</span><span class="s3">: </span><span class="s4">function</span><span class="s3">(</span><span class="s1">field_id</span><span class="s3">) {</span>
            <span class="s4">const </span><span class="s1">from </span><span class="s3">= </span><span class="s1">document</span><span class="s3">.</span><span class="s1">getElementById</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_from'</span><span class="s3">);</span>
            <span class="s4">const </span><span class="s1">to </span><span class="s3">= </span><span class="s1">document</span><span class="s3">.</span><span class="s1">getElementById</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_to'</span><span class="s3">);</span>
            <span class="s0">// Active if at least one item is selected</span>
            <span class="s1">document</span><span class="s3">.</span><span class="s1">getElementById</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_add_link'</span><span class="s3">).</span><span class="s1">classList</span><span class="s3">.</span><span class="s1">toggle</span><span class="s3">(</span><span class="s2">'active'</span><span class="s3">, </span><span class="s1">SelectFilter</span><span class="s3">.</span><span class="s1">any_selected</span><span class="s3">(</span><span class="s1">from</span><span class="s3">));</span>
            <span class="s1">document</span><span class="s3">.</span><span class="s1">getElementById</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_remove_link'</span><span class="s3">).</span><span class="s1">classList</span><span class="s3">.</span><span class="s1">toggle</span><span class="s3">(</span><span class="s2">'active'</span><span class="s3">, </span><span class="s1">SelectFilter</span><span class="s3">.</span><span class="s1">any_selected</span><span class="s3">(</span><span class="s1">to</span><span class="s3">));</span>
            <span class="s0">// Active if the corresponding box isn't empty</span>
            <span class="s1">document</span><span class="s3">.</span><span class="s1">getElementById</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_add_all_link'</span><span class="s3">).</span><span class="s1">classList</span><span class="s3">.</span><span class="s1">toggle</span><span class="s3">(</span><span class="s2">'active'</span><span class="s3">, </span><span class="s1">from</span><span class="s3">.</span><span class="s1">querySelector</span><span class="s3">(</span><span class="s2">'option'</span><span class="s3">));</span>
            <span class="s1">document</span><span class="s3">.</span><span class="s1">getElementById</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s2">'_remove_all_link'</span><span class="s3">).</span><span class="s1">classList</span><span class="s3">.</span><span class="s1">toggle</span><span class="s3">(</span><span class="s2">'active'</span><span class="s3">, </span><span class="s1">to</span><span class="s3">.</span><span class="s1">querySelector</span><span class="s3">(</span><span class="s2">'option'</span><span class="s3">));</span>
            <span class="s1">SelectFilter</span><span class="s3">.</span><span class="s1">refresh_filtered_warning</span><span class="s3">(</span><span class="s1">field_id</span><span class="s3">);</span>
        <span class="s3">},</span>
        <span class="s1">filter_key_press</span><span class="s3">: </span><span class="s4">function</span><span class="s3">(</span><span class="s1">event</span><span class="s3">, </span><span class="s1">field_id</span><span class="s3">, </span><span class="s1">source</span><span class="s3">, </span><span class="s1">target</span><span class="s3">) {</span>
            <span class="s4">const </span><span class="s1">source_box </span><span class="s3">= </span><span class="s1">document</span><span class="s3">.</span><span class="s1">getElementById</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s1">source</span><span class="s3">);</span>
            <span class="s0">// don't submit form if user pressed Enter</span>
            <span class="s4">if </span><span class="s3">((</span><span class="s1">event</span><span class="s3">.</span><span class="s1">which </span><span class="s3">&amp;&amp; </span><span class="s1">event</span><span class="s3">.</span><span class="s1">which </span><span class="s3">=== </span><span class="s6">13</span><span class="s3">) || (</span><span class="s1">event</span><span class="s3">.</span><span class="s1">keyCode </span><span class="s3">&amp;&amp; </span><span class="s1">event</span><span class="s3">.</span><span class="s1">keyCode </span><span class="s3">=== </span><span class="s6">13</span><span class="s3">)) {</span>
                <span class="s1">source_box</span><span class="s3">.</span><span class="s1">selectedIndex </span><span class="s3">= </span><span class="s6">0</span><span class="s3">;</span>
                <span class="s1">SelectBox</span><span class="s3">.</span><span class="s1">move</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s1">source</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s1">target</span><span class="s3">);</span>
                <span class="s1">source_box</span><span class="s3">.</span><span class="s1">selectedIndex </span><span class="s3">= </span><span class="s6">0</span><span class="s3">;</span>
                <span class="s1">event</span><span class="s3">.</span><span class="s1">preventDefault</span><span class="s3">();</span>
            <span class="s3">}</span>
        <span class="s3">},</span>
        <span class="s1">filter_key_up</span><span class="s3">: </span><span class="s4">function</span><span class="s3">(</span><span class="s1">event</span><span class="s3">, </span><span class="s1">field_id</span><span class="s3">, </span><span class="s1">source</span><span class="s3">, </span><span class="s1">filter_input</span><span class="s3">) {</span>
            <span class="s4">const </span><span class="s1">input </span><span class="s3">= </span><span class="s1">filter_input </span><span class="s3">|| </span><span class="s2">'_input'</span><span class="s3">;</span>
            <span class="s4">const </span><span class="s1">source_box </span><span class="s3">= </span><span class="s1">document</span><span class="s3">.</span><span class="s1">getElementById</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s1">source</span><span class="s3">);</span>
            <span class="s4">const </span><span class="s1">temp </span><span class="s3">= </span><span class="s1">source_box</span><span class="s3">.</span><span class="s1">selectedIndex</span><span class="s3">;</span>
            <span class="s1">SelectBox</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s1">source</span><span class="s3">, </span><span class="s1">document</span><span class="s3">.</span><span class="s1">getElementById</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s1">input</span><span class="s3">).</span><span class="s1">value</span><span class="s3">);</span>
            <span class="s1">source_box</span><span class="s3">.</span><span class="s1">selectedIndex </span><span class="s3">= </span><span class="s1">temp</span><span class="s3">;</span>
            <span class="s1">SelectFilter</span><span class="s3">.</span><span class="s1">refresh_filtered_warning</span><span class="s3">(</span><span class="s1">field_id</span><span class="s3">);</span>
            <span class="s1">SelectFilter</span><span class="s3">.</span><span class="s1">refresh_icons</span><span class="s3">(</span><span class="s1">field_id</span><span class="s3">);</span>
        <span class="s3">},</span>
        <span class="s1">filter_key_down</span><span class="s3">: </span><span class="s4">function</span><span class="s3">(</span><span class="s1">event</span><span class="s3">, </span><span class="s1">field_id</span><span class="s3">, </span><span class="s1">source</span><span class="s3">, </span><span class="s1">target</span><span class="s3">) {</span>
            <span class="s4">const </span><span class="s1">source_box </span><span class="s3">= </span><span class="s1">document</span><span class="s3">.</span><span class="s1">getElementById</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s1">source</span><span class="s3">);</span>
            <span class="s0">// right key (39) or left key (37)</span>
            <span class="s4">const </span><span class="s1">direction </span><span class="s3">= </span><span class="s1">source </span><span class="s3">=== </span><span class="s2">'_from' </span><span class="s3">? </span><span class="s6">39 </span><span class="s3">: </span><span class="s6">37</span><span class="s3">;</span>
            <span class="s0">// right arrow -- move across</span>
            <span class="s4">if </span><span class="s3">((</span><span class="s1">event</span><span class="s3">.</span><span class="s1">which </span><span class="s3">&amp;&amp; </span><span class="s1">event</span><span class="s3">.</span><span class="s1">which </span><span class="s3">=== </span><span class="s1">direction</span><span class="s3">) || (</span><span class="s1">event</span><span class="s3">.</span><span class="s1">keyCode </span><span class="s3">&amp;&amp; </span><span class="s1">event</span><span class="s3">.</span><span class="s1">keyCode </span><span class="s3">=== </span><span class="s1">direction</span><span class="s3">)) {</span>
                <span class="s4">const </span><span class="s1">old_index </span><span class="s3">= </span><span class="s1">source_box</span><span class="s3">.</span><span class="s1">selectedIndex</span><span class="s3">;</span>
                <span class="s1">SelectBox</span><span class="s3">.</span><span class="s1">move</span><span class="s3">(</span><span class="s1">field_id </span><span class="s3">+ </span><span class="s1">source</span><span class="s3">, </span><span class="s1">field_id </span><span class="s3">+ </span><span class="s1">target</span><span class="s3">);</span>
                <span class="s1">SelectFilter</span><span class="s3">.</span><span class="s1">refresh_filtered_selects</span><span class="s3">(</span><span class="s1">field_id</span><span class="s3">);</span>
                <span class="s1">SelectFilter</span><span class="s3">.</span><span class="s1">refresh_filtered_warning</span><span class="s3">(</span><span class="s1">field_id</span><span class="s3">);</span>
                <span class="s1">source_box</span><span class="s3">.</span><span class="s1">selectedIndex </span><span class="s3">= (</span><span class="s1">old_index </span><span class="s3">=== </span><span class="s1">source_box</span><span class="s3">.</span><span class="s1">length</span><span class="s3">) ? </span><span class="s1">source_box</span><span class="s3">.</span><span class="s1">length </span><span class="s3">- </span><span class="s6">1 </span><span class="s3">: </span><span class="s1">old_index</span><span class="s3">;</span>
                <span class="s4">return</span><span class="s3">;</span>
            <span class="s3">}</span>
            <span class="s0">// down arrow -- wrap around</span>
            <span class="s4">if </span><span class="s3">((</span><span class="s1">event</span><span class="s3">.</span><span class="s1">which </span><span class="s3">&amp;&amp; </span><span class="s1">event</span><span class="s3">.</span><span class="s1">which </span><span class="s3">=== </span><span class="s6">40</span><span class="s3">) || (</span><span class="s1">event</span><span class="s3">.</span><span class="s1">keyCode </span><span class="s3">&amp;&amp; </span><span class="s1">event</span><span class="s3">.</span><span class="s1">keyCode </span><span class="s3">=== </span><span class="s6">40</span><span class="s3">)) {</span>
                <span class="s1">source_box</span><span class="s3">.</span><span class="s1">selectedIndex </span><span class="s3">= (</span><span class="s1">source_box</span><span class="s3">.</span><span class="s1">length </span><span class="s3">=== </span><span class="s1">source_box</span><span class="s3">.</span><span class="s1">selectedIndex </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">) ? </span><span class="s6">0 </span><span class="s3">: </span><span class="s1">source_box</span><span class="s3">.</span><span class="s1">selectedIndex </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">;</span>
            <span class="s3">}</span>
            <span class="s0">// up arrow -- wrap around</span>
            <span class="s4">if </span><span class="s3">((</span><span class="s1">event</span><span class="s3">.</span><span class="s1">which </span><span class="s3">&amp;&amp; </span><span class="s1">event</span><span class="s3">.</span><span class="s1">which </span><span class="s3">=== </span><span class="s6">38</span><span class="s3">) || (</span><span class="s1">event</span><span class="s3">.</span><span class="s1">keyCode </span><span class="s3">&amp;&amp; </span><span class="s1">event</span><span class="s3">.</span><span class="s1">keyCode </span><span class="s3">=== </span><span class="s6">38</span><span class="s3">)) {</span>
                <span class="s1">source_box</span><span class="s3">.</span><span class="s1">selectedIndex </span><span class="s3">= (</span><span class="s1">source_box</span><span class="s3">.</span><span class="s1">selectedIndex </span><span class="s3">=== </span><span class="s6">0</span><span class="s3">) ? </span><span class="s1">source_box</span><span class="s3">.</span><span class="s1">length </span><span class="s3">- </span><span class="s6">1 </span><span class="s3">: </span><span class="s1">source_box</span><span class="s3">.</span><span class="s1">selectedIndex </span><span class="s3">- </span><span class="s6">1</span><span class="s3">;</span>
            <span class="s3">}</span>
        <span class="s3">}</span>
    <span class="s3">};</span>

    <span class="s1">window</span><span class="s3">.</span><span class="s1">addEventListener</span><span class="s3">(</span><span class="s2">'load'</span><span class="s3">, </span><span class="s4">function</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) {</span>
        <span class="s1">document</span><span class="s3">.</span><span class="s1">querySelectorAll</span><span class="s3">(</span><span class="s2">'select.selectfilter, select.selectfilterstacked'</span><span class="s3">).</span><span class="s1">forEach</span><span class="s3">(</span><span class="s4">function</span><span class="s3">(</span><span class="s1">el</span><span class="s3">) {</span>
            <span class="s4">const </span><span class="s1">data </span><span class="s3">= </span><span class="s1">el</span><span class="s3">.</span><span class="s1">dataset</span><span class="s3">;</span>
            <span class="s1">SelectFilter</span><span class="s3">.</span><span class="s1">init</span><span class="s3">(</span><span class="s1">el</span><span class="s3">.</span><span class="s1">id</span><span class="s3">, </span><span class="s1">data</span><span class="s3">.</span><span class="s1">fieldName</span><span class="s3">, </span><span class="s1">parseInt</span><span class="s3">(</span><span class="s1">data</span><span class="s3">.</span><span class="s1">isStacked</span><span class="s3">, </span><span class="s6">10</span><span class="s3">));</span>
        <span class="s3">});</span>
    <span class="s3">});</span>
<span class="s3">}</span>
</pre>
</body>
</html>