<html>
<head>
<title>boundfield.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
boundfield.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">re</span>

<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">exceptions </span><span class="s0">import </span><span class="s1">ValidationError</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">forms</span><span class="s2">.</span><span class="s1">utils </span><span class="s0">import </span><span class="s1">RenderableFieldMixin</span><span class="s2">, </span><span class="s1">pretty_name</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">forms</span><span class="s2">.</span><span class="s1">widgets </span><span class="s0">import </span><span class="s1">MultiWidget</span><span class="s2">, </span><span class="s1">Textarea</span><span class="s2">, </span><span class="s1">TextInput</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">functional </span><span class="s0">import </span><span class="s1">cached_property</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">html </span><span class="s0">import </span><span class="s1">format_html</span><span class="s2">, </span><span class="s1">html_safe</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">translation </span><span class="s0">import </span><span class="s1">gettext_lazy </span><span class="s0">as </span><span class="s1">_</span>

<span class="s1">__all__ </span><span class="s2">= (</span><span class="s3">&quot;BoundField&quot;</span><span class="s2">,)</span>


<span class="s0">class </span><span class="s1">BoundField</span><span class="s2">(</span><span class="s1">RenderableFieldMixin</span><span class="s2">):</span>
    <span class="s4">&quot;A Field plus data&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">form</span><span class="s2">, </span><span class="s1">field</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">form </span><span class="s2">= </span><span class="s1">form</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">field </span><span class="s2">= </span><span class="s1">field</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">html_name </span><span class="s2">= </span><span class="s1">form</span><span class="s2">.</span><span class="s1">add_prefix</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">html_initial_name </span><span class="s2">= </span><span class="s1">form</span><span class="s2">.</span><span class="s1">add_initial_prefix</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">html_initial_id </span><span class="s2">= </span><span class="s1">form</span><span class="s2">.</span><span class="s1">add_initial_prefix</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">auto_id</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">label </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">label </span><span class="s2">= </span><span class="s1">pretty_name</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">label </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">label</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">help_text </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">help_text </span><span class="s0">or </span><span class="s3">&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">renderer </span><span class="s2">= </span><span class="s1">form</span><span class="s2">.</span><span class="s1">renderer</span>

    <span class="s2">@</span><span class="s1">cached_property</span>
    <span class="s0">def </span><span class="s1">subwidgets</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Most widgets yield a single subwidget, but others like RadioSelect and 
        CheckboxSelectMultiple produce one subwidget for each choice. 
 
        This property is cached so that only one database query occurs when 
        rendering ModelChoiceFields. 
        &quot;&quot;&quot;</span>
        <span class="s1">id_ </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">widget</span><span class="s2">.</span><span class="s1">attrs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;id&quot;</span><span class="s2">) </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">auto_id</span>
        <span class="s1">attrs </span><span class="s2">= {</span><span class="s3">&quot;id&quot;</span><span class="s2">: </span><span class="s1">id_</span><span class="s2">} </span><span class="s0">if </span><span class="s1">id_ </span><span class="s0">else </span><span class="s2">{}</span>
        <span class="s1">attrs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build_widget_attrs</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">[</span>
            <span class="s1">BoundWidget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">widget</span><span class="s2">, </span><span class="s1">widget</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">renderer</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">widget </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">widget</span><span class="s2">.</span><span class="s1">subwidgets</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">html_name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span><span class="s2">(), </span><span class="s1">attrs</span><span class="s2">=</span><span class="s1">attrs</span>
            <span class="s2">)</span>
        <span class="s2">]</span>

    <span class="s0">def </span><span class="s1">__bool__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># BoundField evaluates to True even if it doesn't have subwidgets.</span>
        <span class="s0">return True</span>

    <span class="s0">def </span><span class="s1">__iter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">iter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">subwidgets</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__len__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">subwidgets</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">):</span>
        <span class="s5"># Prevent unnecessary reevaluation when accessing BoundField's attrs</span>
        <span class="s5"># from templates.</span>
        <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">idx</span><span class="s2">, (</span><span class="s1">int</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">)):</span>
            <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span>
                <span class="s3">&quot;BoundField indices must be integers or slices, not %s.&quot;</span>
                <span class="s2">% </span><span class="s1">type</span><span class="s2">(</span><span class="s1">idx</span><span class="s2">).</span><span class="s1">__name__</span>
            <span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">subwidgets</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">]</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">errors</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Return an ErrorList (empty if there are no errors) for this field. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">errors</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">error_class</span><span class="s2">(</span><span class="s1">renderer</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">renderer</span><span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">template_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">template_name </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">renderer</span><span class="s2">.</span><span class="s1">field_template_name</span>

    <span class="s0">def </span><span class="s1">get_context</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">{</span><span class="s3">&quot;field&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">}</span>

    <span class="s0">def </span><span class="s1">as_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">widget</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">only_initial</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Render the field by rendering the passed widget, adding any HTML 
        attributes passed as attrs. If a widget isn't specified, use the 
        field's default widget. 
        &quot;&quot;&quot;</span>
        <span class="s1">widget </span><span class="s2">= </span><span class="s1">widget </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">widget</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">localize</span><span class="s2">:</span>
            <span class="s1">widget</span><span class="s2">.</span><span class="s1">is_localized </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s1">attrs </span><span class="s2">= </span><span class="s1">attrs </span><span class="s0">or </span><span class="s2">{}</span>
        <span class="s1">attrs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build_widget_attrs</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">widget</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">auto_id </span><span class="s0">and </span><span class="s3">&quot;id&quot; </span><span class="s0">not in </span><span class="s1">widget</span><span class="s2">.</span><span class="s1">attrs</span><span class="s2">:</span>
            <span class="s1">attrs</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span>
                <span class="s3">&quot;id&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">html_initial_id </span><span class="s0">if </span><span class="s1">only_initial </span><span class="s0">else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">auto_id</span>
            <span class="s2">)</span>
        <span class="s0">if </span><span class="s1">only_initial </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">html_initial_name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">data</span><span class="s2">:</span>
            <span class="s5"># Propagate the hidden initial value.</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">_widget_data_value</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">hidden_widget</span><span class="s2">(),</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">html_initial_name</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">widget</span><span class="s2">.</span><span class="s1">render</span><span class="s2">(</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">html_initial_name </span><span class="s0">if </span><span class="s1">only_initial </span><span class="s0">else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">html_name</span><span class="s2">,</span>
            <span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">,</span>
            <span class="s1">attrs</span><span class="s2">=</span><span class="s1">attrs</span><span class="s2">,</span>
            <span class="s1">renderer</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">renderer</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">as_text</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Return a string of HTML for representing this as an &lt;input type=&quot;text&quot;&gt;. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">as_widget</span><span class="s2">(</span><span class="s1">TextInput</span><span class="s2">(), </span><span class="s1">attrs</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">as_textarea</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;Return a string of HTML for representing this as a &lt;textarea&gt;.&quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">as_widget</span><span class="s2">(</span><span class="s1">Textarea</span><span class="s2">(), </span><span class="s1">attrs</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">as_hidden</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Return a string of HTML for representing this as an &lt;input type=&quot;hidden&quot;&gt;. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">as_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">hidden_widget</span><span class="s2">(), </span><span class="s1">attrs</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Return the data for this BoundField, or None if it wasn't given. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">_widget_data_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">widget</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">html_name</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Return the value for this BoundField, using the initial value if 
        the form is not bound or the data otherwise. 
        &quot;&quot;&quot;</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">initial</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">is_bound</span><span class="s2">:</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">bound_data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">prepare_value</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_has_changed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">field </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span>
        <span class="s0">if </span><span class="s1">field</span><span class="s2">.</span><span class="s1">show_hidden_initial</span><span class="s2">:</span>
            <span class="s1">hidden_widget </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">hidden_widget</span><span class="s2">()</span>
            <span class="s1">initial_value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">_widget_data_value</span><span class="s2">(</span>
                <span class="s1">hidden_widget</span><span class="s2">,</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">html_initial_name</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">initial_value </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">to_python</span><span class="s2">(</span><span class="s1">initial_value</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">ValidationError</span><span class="s2">:</span>
                <span class="s5"># Always assume data has changed if validation fails.</span>
                <span class="s0">return True</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">initial_value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">initial</span>
        <span class="s0">return </span><span class="s1">field</span><span class="s2">.</span><span class="s1">has_changed</span><span class="s2">(</span><span class="s1">initial_value</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">label_tag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">contents</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">label_suffix</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">tag</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Wrap the given contents in a &lt;label&gt;, if the field has an ID attribute. 
        contents should be mark_safe'd to avoid HTML escaping. If contents 
        aren't given, use the field's HTML-escaped label. 
 
        If attrs are given, use them as HTML attributes on the &lt;label&gt; tag. 
 
        label_suffix overrides the form's label_suffix. 
        &quot;&quot;&quot;</span>
        <span class="s1">contents </span><span class="s2">= </span><span class="s1">contents </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">label</span>
        <span class="s0">if </span><span class="s1">label_suffix </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">label_suffix </span><span class="s2">= (</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">label_suffix</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">label_suffix </span><span class="s0">is not None</span>
                <span class="s0">else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">label_suffix</span>
            <span class="s2">)</span>
        <span class="s5"># Only add the suffix if the label does not end in punctuation.</span>
        <span class="s5"># Translators: If found as last label character, these punctuation</span>
        <span class="s5"># characters will prevent the default label_suffix to be appended to the label</span>
        <span class="s0">if </span><span class="s1">label_suffix </span><span class="s0">and </span><span class="s1">contents </span><span class="s0">and </span><span class="s1">contents</span><span class="s2">[-</span><span class="s6">1</span><span class="s2">] </span><span class="s0">not in </span><span class="s1">_</span><span class="s2">(</span><span class="s3">&quot;:?.!&quot;</span><span class="s2">):</span>
            <span class="s1">contents </span><span class="s2">= </span><span class="s1">format_html</span><span class="s2">(</span><span class="s3">&quot;{}{}&quot;</span><span class="s2">, </span><span class="s1">contents</span><span class="s2">, </span><span class="s1">label_suffix</span><span class="s2">)</span>
        <span class="s1">widget </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">widget</span>
        <span class="s1">id_ </span><span class="s2">= </span><span class="s1">widget</span><span class="s2">.</span><span class="s1">attrs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;id&quot;</span><span class="s2">) </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">auto_id</span>
        <span class="s0">if </span><span class="s1">id_</span><span class="s2">:</span>
            <span class="s1">id_for_label </span><span class="s2">= </span><span class="s1">widget</span><span class="s2">.</span><span class="s1">id_for_label</span><span class="s2">(</span><span class="s1">id_</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">id_for_label</span><span class="s2">:</span>
                <span class="s1">attrs </span><span class="s2">= {**(</span><span class="s1">attrs </span><span class="s0">or </span><span class="s2">{}), </span><span class="s3">&quot;for&quot;</span><span class="s2">: </span><span class="s1">id_for_label</span><span class="s2">}</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">required </span><span class="s0">and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">, </span><span class="s3">&quot;required_css_class&quot;</span><span class="s2">):</span>
                <span class="s1">attrs </span><span class="s2">= </span><span class="s1">attrs </span><span class="s0">or </span><span class="s2">{}</span>
                <span class="s0">if </span><span class="s3">&quot;class&quot; </span><span class="s0">in </span><span class="s1">attrs</span><span class="s2">:</span>
                    <span class="s1">attrs</span><span class="s2">[</span><span class="s3">&quot;class&quot;</span><span class="s2">] += </span><span class="s3">&quot; &quot; </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">required_css_class</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">attrs</span><span class="s2">[</span><span class="s3">&quot;class&quot;</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">required_css_class</span>
        <span class="s1">context </span><span class="s2">= {</span>
            <span class="s3">&quot;field&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">,</span>
            <span class="s3">&quot;label&quot;</span><span class="s2">: </span><span class="s1">contents</span><span class="s2">,</span>
            <span class="s3">&quot;attrs&quot;</span><span class="s2">: </span><span class="s1">attrs</span><span class="s2">,</span>
            <span class="s3">&quot;use_tag&quot;</span><span class="s2">: </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">id_</span><span class="s2">),</span>
            <span class="s3">&quot;tag&quot;</span><span class="s2">: </span><span class="s1">tag </span><span class="s0">or </span><span class="s3">&quot;label&quot;</span><span class="s2">,</span>
        <span class="s2">}</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">render</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">template_name_label</span><span class="s2">, </span><span class="s1">context</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">legend_tag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">contents</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">label_suffix</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Wrap the given contents in a &lt;legend&gt;, if the field has an ID 
        attribute. Contents should be mark_safe'd to avoid HTML escaping. If 
        contents aren't given, use the field's HTML-escaped label. 
 
        If attrs are given, use them as HTML attributes on the &lt;legend&gt; tag. 
 
        label_suffix overrides the form's label_suffix. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">label_tag</span><span class="s2">(</span><span class="s1">contents</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">label_suffix</span><span class="s2">, </span><span class="s1">tag</span><span class="s2">=</span><span class="s3">&quot;legend&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">css_classes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">extra_classes</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Return a string of space-separated CSS classes for this field. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">extra_classes</span><span class="s2">, </span><span class="s3">&quot;split&quot;</span><span class="s2">):</span>
            <span class="s1">extra_classes </span><span class="s2">= </span><span class="s1">extra_classes</span><span class="s2">.</span><span class="s1">split</span><span class="s2">()</span>
        <span class="s1">extra_classes </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">extra_classes </span><span class="s0">or </span><span class="s2">[])</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">errors </span><span class="s0">and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">, </span><span class="s3">&quot;error_css_class&quot;</span><span class="s2">):</span>
            <span class="s1">extra_classes</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">error_css_class</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">required </span><span class="s0">and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">, </span><span class="s3">&quot;required_css_class&quot;</span><span class="s2">):</span>
            <span class="s1">extra_classes</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">required_css_class</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s3">&quot; &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">extra_classes</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">is_hidden</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;Return True if this BoundField's widget is hidden.&quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">widget</span><span class="s2">.</span><span class="s1">is_hidden</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">auto_id</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Calculate and return the ID attribute for this BoundField, if the 
        associated Form has specified auto_id. Return an empty string otherwise. 
        &quot;&quot;&quot;</span>
        <span class="s1">auto_id </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">auto_id  </span><span class="s5"># Boolean or string</span>
        <span class="s0">if </span><span class="s1">auto_id </span><span class="s0">and </span><span class="s3">&quot;%s&quot; </span><span class="s0">in </span><span class="s1">str</span><span class="s2">(</span><span class="s1">auto_id</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">auto_id </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">html_name</span>
        <span class="s0">elif </span><span class="s1">auto_id</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">html_name</span>
        <span class="s0">return </span><span class="s3">&quot;&quot;</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">id_for_label</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Wrapper around the field widget's `id_for_label` method. 
        Useful, for example, for focusing on this field regardless of whether 
        it has a single widget or a MultiWidget. 
        &quot;&quot;&quot;</span>
        <span class="s1">widget </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">widget</span>
        <span class="s1">id_ </span><span class="s2">= </span><span class="s1">widget</span><span class="s2">.</span><span class="s1">attrs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;id&quot;</span><span class="s2">) </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">auto_id</span>
        <span class="s0">return </span><span class="s1">widget</span><span class="s2">.</span><span class="s1">id_for_label</span><span class="s2">(</span><span class="s1">id_</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">cached_property</span>
    <span class="s0">def </span><span class="s1">initial</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">get_initial_for_field</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">build_widget_attrs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">widget</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">widget </span><span class="s2">= </span><span class="s1">widget </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">widget</span>
        <span class="s1">attrs </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">)  </span><span class="s5"># Copy attrs to avoid modifying the argument.</span>
        <span class="s0">if </span><span class="s2">(</span>
            <span class="s1">widget</span><span class="s2">.</span><span class="s1">use_required_attribute</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">initial</span><span class="s2">)</span>
            <span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">required</span>
            <span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">use_required_attribute</span>
        <span class="s2">):</span>
            <span class="s5"># MultiValueField has require_all_fields: if False, fall back</span>
            <span class="s5"># on subfields.</span>
            <span class="s0">if </span><span class="s2">(</span>
                <span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">, </span><span class="s3">&quot;require_all_fields&quot;</span><span class="s2">)</span>
                <span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">require_all_fields</span>
                <span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">widget</span><span class="s2">, </span><span class="s1">MultiWidget</span><span class="s2">)</span>
            <span class="s2">):</span>
                <span class="s0">for </span><span class="s1">subfield</span><span class="s2">, </span><span class="s1">subwidget </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">, </span><span class="s1">widget</span><span class="s2">.</span><span class="s1">widgets</span><span class="s2">):</span>
                    <span class="s1">subwidget</span><span class="s2">.</span><span class="s1">attrs</span><span class="s2">[</span><span class="s3">&quot;required&quot;</span><span class="s2">] = (</span>
                        <span class="s1">subwidget</span><span class="s2">.</span><span class="s1">use_required_attribute</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">initial</span><span class="s2">)</span>
                        <span class="s0">and </span><span class="s1">subfield</span><span class="s2">.</span><span class="s1">required</span>
                    <span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">attrs</span><span class="s2">[</span><span class="s3">&quot;required&quot;</span><span class="s2">] = </span><span class="s0">True</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">disabled</span><span class="s2">:</span>
            <span class="s1">attrs</span><span class="s2">[</span><span class="s3">&quot;disabled&quot;</span><span class="s2">] = </span><span class="s0">True</span>
        <span class="s0">if not </span><span class="s1">widget</span><span class="s2">.</span><span class="s1">is_hidden </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">errors</span><span class="s2">:</span>
            <span class="s1">attrs</span><span class="s2">[</span><span class="s3">&quot;aria-invalid&quot;</span><span class="s2">] = </span><span class="s3">&quot;true&quot;</span>
        <span class="s5"># If a custom aria-describedby attribute is given (either via the attrs</span>
        <span class="s5"># argument or widget.attrs) and help_text is used, the custom</span>
        <span class="s5"># aria-described by is preserved so user can set the desired order.</span>
        <span class="s0">if </span><span class="s2">(</span>
            <span class="s0">not </span><span class="s1">attrs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;aria-describedby&quot;</span><span class="s2">)</span>
            <span class="s0">and not </span><span class="s1">widget</span><span class="s2">.</span><span class="s1">attrs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;aria-describedby&quot;</span><span class="s2">)</span>
            <span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">help_text</span>
            <span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">use_fieldset</span>
            <span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">auto_id</span>
        <span class="s2">):</span>
            <span class="s1">attrs</span><span class="s2">[</span><span class="s3">&quot;aria-describedby&quot;</span><span class="s2">] = </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">auto_id</span><span class="s0">}</span><span class="s3">_helptext&quot;</span>
        <span class="s0">return </span><span class="s1">attrs</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">widget_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">re</span><span class="s2">.</span><span class="s1">sub</span><span class="s2">(</span>
            <span class="s3">r&quot;widget$|input$&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">widget</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()</span>
        <span class="s2">)</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">use_fieldset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Return the value of this BoundField widget's use_fieldset attribute. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">widget</span><span class="s2">.</span><span class="s1">use_fieldset</span>


<span class="s2">@</span><span class="s1">html_safe</span>
<span class="s0">class </span><span class="s1">BoundWidget</span><span class="s2">:</span>
    <span class="s4">&quot;&quot;&quot; 
    A container class used for iterating over widgets. This is useful for 
    widgets that have choices. For example, the following can be used in a 
    template: 
 
    {% for radio in myform.beatles %} 
      &lt;label for=&quot;{{ radio.id_for_label }}&quot;&gt; 
        {{ radio.choice_label }} 
        &lt;span class=&quot;radio&quot;&gt;{{ radio.tag }}&lt;/span&gt; 
      &lt;/label&gt; 
    {% endfor %} 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">parent_widget</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">renderer</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">parent_widget </span><span class="s2">= </span><span class="s1">parent_widget</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= </span><span class="s1">data</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">renderer </span><span class="s2">= </span><span class="s1">renderer</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tag</span><span class="s2">(</span><span class="s1">wrap_label</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">tag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">wrap_label</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s1">context </span><span class="s2">= {</span><span class="s3">&quot;widget&quot;</span><span class="s2">: {**</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s3">&quot;wrap_label&quot;</span><span class="s2">: </span><span class="s1">wrap_label</span><span class="s2">}}</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parent_widget</span><span class="s2">.</span><span class="s1">_render</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">template_name</span><span class="s2">, </span><span class="s1">context</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">renderer</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">template_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s3">&quot;template_name&quot; </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">[</span><span class="s3">&quot;template_name&quot;</span><span class="s2">]</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parent_widget</span><span class="s2">.</span><span class="s1">template_name</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">id_for_label</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">[</span><span class="s3">&quot;attrs&quot;</span><span class="s2">].</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;id&quot;</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">choice_label</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">[</span><span class="s3">&quot;label&quot;</span><span class="s2">]</span>
</pre>
</body>
</html>