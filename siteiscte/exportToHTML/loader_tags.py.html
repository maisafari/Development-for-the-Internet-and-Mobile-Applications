<html>
<head>
<title>loader_tags.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
loader_tags.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">posixpath</span>
<span class="s0">from </span><span class="s1">collections </span><span class="s0">import </span><span class="s1">defaultdict</span>

<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">safestring </span><span class="s0">import </span><span class="s1">mark_safe</span>

<span class="s0">from </span><span class="s2">.</span><span class="s1">base </span><span class="s0">import </span><span class="s1">Node</span><span class="s2">, </span><span class="s1">Template</span><span class="s2">, </span><span class="s1">TemplateSyntaxError</span><span class="s2">, </span><span class="s1">TextNode</span><span class="s2">, </span><span class="s1">Variable</span><span class="s2">, </span><span class="s1">token_kwargs</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">library </span><span class="s0">import </span><span class="s1">Library</span>

<span class="s1">register </span><span class="s2">= </span><span class="s1">Library</span><span class="s2">()</span>

<span class="s1">BLOCK_CONTEXT_KEY </span><span class="s2">= </span><span class="s3">&quot;block_context&quot;</span>


<span class="s0">class </span><span class="s1">BlockContext</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Dictionary of FIFO queues.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">blocks </span><span class="s2">= </span><span class="s1">defaultdict</span><span class="s2">(</span><span class="s1">list</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s3">f&quot;&lt;</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__qualname__</span><span class="s0">}</span><span class="s3">: blocks=</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s0">!r}</span><span class="s3">&gt;&quot;</span>

    <span class="s0">def </span><span class="s1">add_blocks</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">blocks</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">block </span><span class="s0">in </span><span class="s1">blocks</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">[</span><span class="s1">name</span><span class="s2">].</span><span class="s1">insert</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">block</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">pop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">[</span><span class="s1">name</span><span class="s2">].</span><span class="s1">pop</span><span class="s2">()</span>
        <span class="s0">except </span><span class="s1">IndexError</span><span class="s2">:</span>
            <span class="s0">return None</span>

    <span class="s0">def </span><span class="s1">push</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">block</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">[</span><span class="s1">name</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">block</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_block</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">[</span><span class="s1">name</span><span class="s2">][-</span><span class="s5">1</span><span class="s2">]</span>
        <span class="s0">except </span><span class="s1">IndexError</span><span class="s2">:</span>
            <span class="s0">return None</span>


<span class="s0">class </span><span class="s1">BlockNode</span><span class="s2">(</span><span class="s1">Node</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">nodelist</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">nodelist </span><span class="s2">= </span><span class="s1">nodelist</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">parent </span><span class="s2">= </span><span class="s1">parent</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s3">&quot;&lt;Block Node: %s. Contents: %r&gt;&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">nodelist</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">render</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">context</span><span class="s2">):</span>
        <span class="s1">block_context </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">render_context</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">BLOCK_CONTEXT_KEY</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">context</span><span class="s2">.</span><span class="s1">push</span><span class="s2">():</span>
            <span class="s0">if </span><span class="s1">block_context </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s1">context</span><span class="s2">[</span><span class="s3">&quot;block&quot;</span><span class="s2">] = </span><span class="s1">self</span>
                <span class="s1">result </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">nodelist</span><span class="s2">.</span><span class="s1">render</span><span class="s2">(</span><span class="s1">context</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">push </span><span class="s2">= </span><span class="s1">block </span><span class="s2">= </span><span class="s1">block_context</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">block </span><span class="s0">is None</span><span class="s2">:</span>
                    <span class="s1">block </span><span class="s2">= </span><span class="s1">self</span>
                <span class="s4"># Create new block so we can store context without thread-safety issues.</span>
                <span class="s1">block </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)(</span><span class="s1">block</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">block</span><span class="s2">.</span><span class="s1">nodelist</span><span class="s2">)</span>
                <span class="s1">block</span><span class="s2">.</span><span class="s1">context </span><span class="s2">= </span><span class="s1">context</span>
                <span class="s1">context</span><span class="s2">[</span><span class="s3">&quot;block&quot;</span><span class="s2">] = </span><span class="s1">block</span>
                <span class="s1">result </span><span class="s2">= </span><span class="s1">block</span><span class="s2">.</span><span class="s1">nodelist</span><span class="s2">.</span><span class="s1">render</span><span class="s2">(</span><span class="s1">context</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">push </span><span class="s0">is not None</span><span class="s2">:</span>
                    <span class="s1">block_context</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">push</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">result</span>

    <span class="s0">def </span><span class="s1">super</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">&quot;context&quot;</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">TemplateSyntaxError</span><span class="s2">(</span>
                <span class="s3">&quot;'%s' object has no attribute 'context'. Did you use &quot;</span>
                <span class="s3">&quot;{{ block.super }} in a base template?&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span>
            <span class="s2">)</span>
        <span class="s1">render_context </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">render_context</span>
        <span class="s0">if </span><span class="s2">(</span>
            <span class="s1">BLOCK_CONTEXT_KEY </span><span class="s0">in </span><span class="s1">render_context</span>
            <span class="s0">and </span><span class="s1">render_context</span><span class="s2">[</span><span class="s1">BLOCK_CONTEXT_KEY</span><span class="s2">].</span><span class="s1">get_block</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">) </span><span class="s0">is not None</span>
        <span class="s2">):</span>
            <span class="s0">return </span><span class="s1">mark_safe</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s3">&quot;&quot;</span>


<span class="s0">class </span><span class="s1">ExtendsNode</span><span class="s2">(</span><span class="s1">Node</span><span class="s2">):</span>
    <span class="s1">must_be_first </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">context_key </span><span class="s2">= </span><span class="s3">&quot;extends_context&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">nodelist</span><span class="s2">, </span><span class="s1">parent_name</span><span class="s2">, </span><span class="s1">template_dirs</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">nodelist </span><span class="s2">= </span><span class="s1">nodelist</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">parent_name </span><span class="s2">= </span><span class="s1">parent_name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">template_dirs </span><span class="s2">= </span><span class="s1">template_dirs</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">blocks </span><span class="s2">= {</span><span class="s1">n</span><span class="s2">.</span><span class="s1">name</span><span class="s2">: </span><span class="s1">n </span><span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">nodelist</span><span class="s2">.</span><span class="s1">get_nodes_by_type</span><span class="s2">(</span><span class="s1">BlockNode</span><span class="s2">)}</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s3">&quot;&lt;%s: extends %s&gt;&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parent_name</span><span class="s2">.</span><span class="s1">token</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">find_template</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">template_name</span><span class="s2">, </span><span class="s1">context</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        This is a wrapper around engine.find_template(). A history is kept in 
        the render_context attribute between successive extends calls and 
        passed as the skip argument. This enables extends to work recursively 
        without extending the same template twice. 
        &quot;&quot;&quot;</span>
        <span class="s1">history </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">render_context</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">context_key</span><span class="s2">,</span>
            <span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">origin</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">template</span><span class="s2">, </span><span class="s1">origin </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">template</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">.</span><span class="s1">find_template</span><span class="s2">(</span>
            <span class="s1">template_name</span><span class="s2">,</span>
            <span class="s1">skip</span><span class="s2">=</span><span class="s1">history</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">history</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">origin</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">template</span>

    <span class="s0">def </span><span class="s1">get_parent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">context</span><span class="s2">):</span>
        <span class="s1">parent </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parent_name</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">context</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">parent</span><span class="s2">:</span>
            <span class="s1">error_msg </span><span class="s2">= </span><span class="s3">&quot;Invalid template name in 'extends' tag: %r.&quot; </span><span class="s2">% </span><span class="s1">parent</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parent_name</span><span class="s2">.</span><span class="s1">filters </span><span class="s0">or </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">parent_name</span><span class="s2">.</span><span class="s1">var</span><span class="s2">, </span><span class="s1">Variable</span><span class="s2">):</span>
                <span class="s1">error_msg </span><span class="s2">+= (</span>
                    <span class="s3">&quot; Got this from the '%s' variable.&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parent_name</span><span class="s2">.</span><span class="s1">token</span>
                <span class="s2">)</span>
            <span class="s0">raise </span><span class="s1">TemplateSyntaxError</span><span class="s2">(</span><span class="s1">error_msg</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">, </span><span class="s1">Template</span><span class="s2">):</span>
            <span class="s4"># parent is a django.template.Template</span>
            <span class="s0">return </span><span class="s1">parent</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">, </span><span class="s3">&quot;template&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">), </span><span class="s1">Template</span><span class="s2">):</span>
            <span class="s4"># parent is a django.template.backends.django.Template</span>
            <span class="s0">return </span><span class="s1">parent</span><span class="s2">.</span><span class="s1">template</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">find_template</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">, </span><span class="s1">context</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">render</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">context</span><span class="s2">):</span>
        <span class="s1">compiled_parent </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_parent</span><span class="s2">(</span><span class="s1">context</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">BLOCK_CONTEXT_KEY </span><span class="s0">not in </span><span class="s1">context</span><span class="s2">.</span><span class="s1">render_context</span><span class="s2">:</span>
            <span class="s1">context</span><span class="s2">.</span><span class="s1">render_context</span><span class="s2">[</span><span class="s1">BLOCK_CONTEXT_KEY</span><span class="s2">] = </span><span class="s1">BlockContext</span><span class="s2">()</span>
        <span class="s1">block_context </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">render_context</span><span class="s2">[</span><span class="s1">BLOCK_CONTEXT_KEY</span><span class="s2">]</span>

        <span class="s4"># Add the block nodes from this node to the block context</span>
        <span class="s1">block_context</span><span class="s2">.</span><span class="s1">add_blocks</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">)</span>

        <span class="s4"># If this block's parent doesn't have an extends node it is the root,</span>
        <span class="s4"># and its block nodes also need to be added to the block context.</span>
        <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">compiled_parent</span><span class="s2">.</span><span class="s1">nodelist</span><span class="s2">:</span>
            <span class="s4"># The ExtendsNode has to be the first non-text node.</span>
            <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s1">TextNode</span><span class="s2">):</span>
                <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s1">ExtendsNode</span><span class="s2">):</span>
                    <span class="s1">blocks </span><span class="s2">= {</span>
                        <span class="s1">n</span><span class="s2">.</span><span class="s1">name</span><span class="s2">: </span><span class="s1">n</span>
                        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">compiled_parent</span><span class="s2">.</span><span class="s1">nodelist</span><span class="s2">.</span><span class="s1">get_nodes_by_type</span><span class="s2">(</span><span class="s1">BlockNode</span><span class="s2">)</span>
                    <span class="s2">}</span>
                    <span class="s1">block_context</span><span class="s2">.</span><span class="s1">add_blocks</span><span class="s2">(</span><span class="s1">blocks</span><span class="s2">)</span>
                <span class="s0">break</span>

        <span class="s4"># Call Template._render explicitly so the parser context stays</span>
        <span class="s4"># the same.</span>
        <span class="s0">with </span><span class="s1">context</span><span class="s2">.</span><span class="s1">render_context</span><span class="s2">.</span><span class="s1">push_state</span><span class="s2">(</span><span class="s1">compiled_parent</span><span class="s2">, </span><span class="s1">isolated_context</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">compiled_parent</span><span class="s2">.</span><span class="s1">_render</span><span class="s2">(</span><span class="s1">context</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">IncludeNode</span><span class="s2">(</span><span class="s1">Node</span><span class="s2">):</span>
    <span class="s1">context_key </span><span class="s2">= </span><span class="s3">&quot;__include_context&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">template</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, </span><span class="s1">extra_context</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">isolated_context</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, **</span><span class="s1">kwargs</span>
    <span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">template </span><span class="s2">= </span><span class="s1">template</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">extra_context </span><span class="s2">= </span><span class="s1">extra_context </span><span class="s0">or </span><span class="s2">{}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">isolated_context </span><span class="s2">= </span><span class="s1">isolated_context</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s3">f&quot;&lt;</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__qualname__</span><span class="s0">}</span><span class="s3">: template=</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">template</span><span class="s0">!r}</span><span class="s3">&gt;&quot;</span>

    <span class="s0">def </span><span class="s1">render</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">context</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Render the specified template and context. Cache the template object 
        in render_context to avoid reparsing and loading when used in a for 
        loop. 
        &quot;&quot;&quot;</span>
        <span class="s1">template </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">template</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">context</span><span class="s2">)</span>
        <span class="s4"># Does this quack like a Template?</span>
        <span class="s0">if not </span><span class="s1">callable</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">template</span><span class="s2">, </span><span class="s3">&quot;render&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)):</span>
            <span class="s4"># If not, try the cache and select_template().</span>
            <span class="s1">template_name </span><span class="s2">= </span><span class="s1">template </span><span class="s0">or </span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">template_name</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
                <span class="s1">template_name </span><span class="s2">= (</span>
                    <span class="s1">construct_relative_path</span><span class="s2">(</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">origin</span><span class="s2">.</span><span class="s1">template_name</span><span class="s2">,</span>
                        <span class="s1">template_name</span><span class="s2">,</span>
                    <span class="s2">),</span>
                <span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">template_name </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">template_name</span><span class="s2">)</span>
            <span class="s1">cache </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">render_context</span><span class="s2">.</span><span class="s1">dicts</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, {})</span>
            <span class="s1">template </span><span class="s2">= </span><span class="s1">cache</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">template_name</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">template </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s1">template </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">template</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">.</span><span class="s1">select_template</span><span class="s2">(</span><span class="s1">template_name</span><span class="s2">)</span>
                <span class="s1">cache</span><span class="s2">[</span><span class="s1">template_name</span><span class="s2">] = </span><span class="s1">template</span>
        <span class="s4"># Use the base.Template of a backends.django.Template.</span>
        <span class="s0">elif </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">template</span><span class="s2">, </span><span class="s3">&quot;template&quot;</span><span class="s2">):</span>
            <span class="s1">template </span><span class="s2">= </span><span class="s1">template</span><span class="s2">.</span><span class="s1">template</span>
        <span class="s1">values </span><span class="s2">= {</span>
            <span class="s1">name</span><span class="s2">: </span><span class="s1">var</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">context</span><span class="s2">) </span><span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">var </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">extra_context</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()</span>
        <span class="s2">}</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">isolated_context</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">template</span><span class="s2">.</span><span class="s1">render</span><span class="s2">(</span><span class="s1">context</span><span class="s2">.</span><span class="s1">new</span><span class="s2">(</span><span class="s1">values</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">context</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(**</span><span class="s1">values</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">template</span><span class="s2">.</span><span class="s1">render</span><span class="s2">(</span><span class="s1">context</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">register</span><span class="s2">.</span><span class="s1">tag</span><span class="s2">(</span><span class="s3">&quot;block&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">do_block</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">token</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Define a block that can be overridden by child templates. 
    &quot;&quot;&quot;</span>
    <span class="s4"># token.split_contents() isn't useful here because this tag doesn't accept</span>
    <span class="s4"># variable as arguments.</span>
    <span class="s1">bits </span><span class="s2">= </span><span class="s1">token</span><span class="s2">.</span><span class="s1">contents</span><span class="s2">.</span><span class="s1">split</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">bits</span><span class="s2">) != </span><span class="s5">2</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">TemplateSyntaxError</span><span class="s2">(</span><span class="s3">&quot;'%s' tag takes only one argument&quot; </span><span class="s2">% </span><span class="s1">bits</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
    <span class="s1">block_name </span><span class="s2">= </span><span class="s1">bits</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s4"># Keep track of the names of BlockNodes found in this template, so we can</span>
    <span class="s4"># check for duplication.</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">block_name </span><span class="s0">in </span><span class="s1">parser</span><span class="s2">.</span><span class="s1">__loaded_blocks</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">TemplateSyntaxError</span><span class="s2">(</span>
                <span class="s3">&quot;'%s' tag with name '%s' appears more than once&quot; </span><span class="s2">% (</span><span class="s1">bits</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">block_name</span><span class="s2">)</span>
            <span class="s2">)</span>
        <span class="s1">parser</span><span class="s2">.</span><span class="s1">__loaded_blocks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">block_name</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:  </span><span class="s4"># parser.__loaded_blocks isn't a list yet</span>
        <span class="s1">parser</span><span class="s2">.</span><span class="s1">__loaded_blocks </span><span class="s2">= [</span><span class="s1">block_name</span><span class="s2">]</span>
    <span class="s1">nodelist </span><span class="s2">= </span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">((</span><span class="s3">&quot;endblock&quot;</span><span class="s2">,))</span>

    <span class="s4"># This check is kept for backwards-compatibility. See #3100.</span>
    <span class="s1">endblock </span><span class="s2">= </span><span class="s1">parser</span><span class="s2">.</span><span class="s1">next_token</span><span class="s2">()</span>
    <span class="s1">acceptable_endblocks </span><span class="s2">= (</span><span class="s3">&quot;endblock&quot;</span><span class="s2">, </span><span class="s3">&quot;endblock %s&quot; </span><span class="s2">% </span><span class="s1">block_name</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">endblock</span><span class="s2">.</span><span class="s1">contents </span><span class="s0">not in </span><span class="s1">acceptable_endblocks</span><span class="s2">:</span>
        <span class="s1">parser</span><span class="s2">.</span><span class="s1">invalid_block_tag</span><span class="s2">(</span><span class="s1">endblock</span><span class="s2">, </span><span class="s3">&quot;endblock&quot;</span><span class="s2">, </span><span class="s1">acceptable_endblocks</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">BlockNode</span><span class="s2">(</span><span class="s1">block_name</span><span class="s2">, </span><span class="s1">nodelist</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">construct_relative_path</span><span class="s2">(</span><span class="s1">current_template_name</span><span class="s2">, </span><span class="s1">relative_name</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Convert a relative path (starting with './' or '../') to the full template 
    name based on the current_template_name. 
    &quot;&quot;&quot;</span>
    <span class="s1">new_name </span><span class="s2">= </span><span class="s1">relative_name</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">(</span><span class="s3">&quot;'</span><span class="s0">\&quot;</span><span class="s3">&quot;</span><span class="s2">)</span>
    <span class="s0">if not </span><span class="s1">new_name</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">((</span><span class="s3">&quot;./&quot;</span><span class="s2">, </span><span class="s3">&quot;../&quot;</span><span class="s2">)):</span>
        <span class="s4"># relative_name is a variable or a literal that doesn't contain a</span>
        <span class="s4"># relative path.</span>
        <span class="s0">return </span><span class="s1">relative_name</span>

    <span class="s1">new_name </span><span class="s2">= </span><span class="s1">posixpath</span><span class="s2">.</span><span class="s1">normpath</span><span class="s2">(</span>
        <span class="s1">posixpath</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span>
            <span class="s1">posixpath</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">current_template_name</span><span class="s2">.</span><span class="s1">lstrip</span><span class="s2">(</span><span class="s3">&quot;/&quot;</span><span class="s2">)),</span>
            <span class="s1">new_name</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">new_name</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;../&quot;</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">TemplateSyntaxError</span><span class="s2">(</span>
            <span class="s3">&quot;The relative path '%s' points outside the file hierarchy that &quot;</span>
            <span class="s3">&quot;template '%s' is in.&quot; </span><span class="s2">% (</span><span class="s1">relative_name</span><span class="s2">, </span><span class="s1">current_template_name</span><span class="s2">)</span>
        <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">current_template_name</span><span class="s2">.</span><span class="s1">lstrip</span><span class="s2">(</span><span class="s3">&quot;/&quot;</span><span class="s2">) == </span><span class="s1">new_name</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">TemplateSyntaxError</span><span class="s2">(</span>
            <span class="s3">&quot;The relative path '%s' was translated to template name '%s', the &quot;</span>
            <span class="s3">&quot;same template in which the tag appears.&quot;</span>
            <span class="s2">% (</span><span class="s1">relative_name</span><span class="s2">, </span><span class="s1">current_template_name</span><span class="s2">)</span>
        <span class="s2">)</span>
    <span class="s1">has_quotes </span><span class="s2">= (</span>
        <span class="s1">relative_name</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">((</span><span class="s3">'&quot;'</span><span class="s2">, </span><span class="s3">&quot;'&quot;</span><span class="s2">)) </span><span class="s0">and </span><span class="s1">relative_name</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s1">relative_name</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">return </span><span class="s3">f'&quot;</span><span class="s0">{</span><span class="s1">new_name</span><span class="s0">}</span><span class="s3">&quot;' </span><span class="s0">if </span><span class="s1">has_quotes </span><span class="s0">else </span><span class="s1">new_name</span>


<span class="s2">@</span><span class="s1">register</span><span class="s2">.</span><span class="s1">tag</span><span class="s2">(</span><span class="s3">&quot;extends&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">do_extends</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">token</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Signal that this template extends a parent template. 
 
    This tag may be used in two ways: ``{% extends &quot;base&quot; %}`` (with quotes) 
    uses the literal value &quot;base&quot; as the name of the parent template to extend, 
    or ``{% extends variable %}`` uses the value of ``variable`` as either the 
    name of the parent template to extend (if it evaluates to a string) or as 
    the parent template itself (if it evaluates to a Template object). 
    &quot;&quot;&quot;</span>
    <span class="s1">bits </span><span class="s2">= </span><span class="s1">token</span><span class="s2">.</span><span class="s1">split_contents</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">bits</span><span class="s2">) != </span><span class="s5">2</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">TemplateSyntaxError</span><span class="s2">(</span><span class="s3">&quot;'%s' takes one argument&quot; </span><span class="s2">% </span><span class="s1">bits</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
    <span class="s1">bits</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] = </span><span class="s1">construct_relative_path</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">origin</span><span class="s2">.</span><span class="s1">template_name</span><span class="s2">, </span><span class="s1">bits</span><span class="s2">[</span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">parent_name </span><span class="s2">= </span><span class="s1">parser</span><span class="s2">.</span><span class="s1">compile_filter</span><span class="s2">(</span><span class="s1">bits</span><span class="s2">[</span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">nodelist </span><span class="s2">= </span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s1">nodelist</span><span class="s2">.</span><span class="s1">get_nodes_by_type</span><span class="s2">(</span><span class="s1">ExtendsNode</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">TemplateSyntaxError</span><span class="s2">(</span>
            <span class="s3">&quot;'%s' cannot appear more than once in the same template&quot; </span><span class="s2">% </span><span class="s1">bits</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s2">)</span>
    <span class="s0">return </span><span class="s1">ExtendsNode</span><span class="s2">(</span><span class="s1">nodelist</span><span class="s2">, </span><span class="s1">parent_name</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">register</span><span class="s2">.</span><span class="s1">tag</span><span class="s2">(</span><span class="s3">&quot;include&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">do_include</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">token</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Load a template and render it with the current context. You can pass 
    additional context using keyword arguments. 
 
    Example:: 
 
        {% include &quot;foo/some_include&quot; %} 
        {% include &quot;foo/some_include&quot; with bar=&quot;BAZZ!&quot; baz=&quot;BING!&quot; %} 
 
    Use the ``only`` argument to exclude the current context when rendering 
    the included template:: 
 
        {% include &quot;foo/some_include&quot; only %} 
        {% include &quot;foo/some_include&quot; with bar=&quot;1&quot; only %} 
    &quot;&quot;&quot;</span>
    <span class="s1">bits </span><span class="s2">= </span><span class="s1">token</span><span class="s2">.</span><span class="s1">split_contents</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">bits</span><span class="s2">) &lt; </span><span class="s5">2</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">TemplateSyntaxError</span><span class="s2">(</span>
            <span class="s3">&quot;%r tag takes at least one argument: the name of the template to &quot;</span>
            <span class="s3">&quot;be included.&quot; </span><span class="s2">% </span><span class="s1">bits</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s2">)</span>
    <span class="s1">options </span><span class="s2">= {}</span>
    <span class="s1">remaining_bits </span><span class="s2">= </span><span class="s1">bits</span><span class="s2">[</span><span class="s5">2</span><span class="s2">:]</span>
    <span class="s0">while </span><span class="s1">remaining_bits</span><span class="s2">:</span>
        <span class="s1">option </span><span class="s2">= </span><span class="s1">remaining_bits</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">option </span><span class="s0">in </span><span class="s1">options</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">TemplateSyntaxError</span><span class="s2">(</span>
                <span class="s3">&quot;The %r option was specified more than once.&quot; </span><span class="s2">% </span><span class="s1">option</span>
            <span class="s2">)</span>
        <span class="s0">if </span><span class="s1">option </span><span class="s2">== </span><span class="s3">&quot;with&quot;</span><span class="s2">:</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">token_kwargs</span><span class="s2">(</span><span class="s1">remaining_bits</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">support_legacy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">value</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">TemplateSyntaxError</span><span class="s2">(</span>
                    <span class="s3">'&quot;with&quot; in %r tag needs at least one keyword argument.' </span><span class="s2">% </span><span class="s1">bits</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
                <span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">option </span><span class="s2">== </span><span class="s3">&quot;only&quot;</span><span class="s2">:</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">TemplateSyntaxError</span><span class="s2">(</span>
                <span class="s3">&quot;Unknown argument for %r tag: %r.&quot; </span><span class="s2">% (</span><span class="s1">bits</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">option</span><span class="s2">)</span>
            <span class="s2">)</span>
        <span class="s1">options</span><span class="s2">[</span><span class="s1">option</span><span class="s2">] = </span><span class="s1">value</span>
    <span class="s1">isolated_context </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;only&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">namemap </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;with&quot;</span><span class="s2">, {})</span>
    <span class="s1">bits</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] = </span><span class="s1">construct_relative_path</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">origin</span><span class="s2">.</span><span class="s1">template_name</span><span class="s2">, </span><span class="s1">bits</span><span class="s2">[</span><span class="s5">1</span><span class="s2">])</span>
    <span class="s0">return </span><span class="s1">IncludeNode</span><span class="s2">(</span>
        <span class="s1">parser</span><span class="s2">.</span><span class="s1">compile_filter</span><span class="s2">(</span><span class="s1">bits</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]),</span>
        <span class="s1">extra_context</span><span class="s2">=</span><span class="s1">namemap</span><span class="s2">,</span>
        <span class="s1">isolated_context</span><span class="s2">=</span><span class="s1">isolated_context</span><span class="s2">,</span>
    <span class="s2">)</span>
</pre>
</body>
</html>