<html>
<head>
<title>makemessages.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
makemessages.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">glob</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">from </span><span class="s1">functools </span><span class="s0">import </span><span class="s1">total_ordering</span>
<span class="s0">from </span><span class="s1">itertools </span><span class="s0">import </span><span class="s1">dropwhile</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>

<span class="s0">import </span><span class="s1">django</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">conf </span><span class="s0">import </span><span class="s1">settings</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">exceptions </span><span class="s0">import </span><span class="s1">ImproperlyConfigured</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">files</span><span class="s2">.</span><span class="s1">temp </span><span class="s0">import </span><span class="s1">NamedTemporaryFile</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">management</span><span class="s2">.</span><span class="s1">base </span><span class="s0">import </span><span class="s1">BaseCommand</span><span class="s2">, </span><span class="s1">CommandError</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">management</span><span class="s2">.</span><span class="s1">utils </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">find_command</span><span class="s2">,</span>
    <span class="s1">handle_extensions</span><span class="s2">,</span>
    <span class="s1">is_ignored_path</span><span class="s2">,</span>
    <span class="s1">popen_wrapper</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">encoding </span><span class="s0">import </span><span class="s1">DEFAULT_LOCALE_ENCODING</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">functional </span><span class="s0">import </span><span class="s1">cached_property</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">jslex </span><span class="s0">import </span><span class="s1">prepare_js_for_gettext</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">regex_helper </span><span class="s0">import </span><span class="s1">_lazy_re_compile</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">text </span><span class="s0">import </span><span class="s1">get_text_list</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">translation </span><span class="s0">import </span><span class="s1">templatize</span>

<span class="s1">plural_forms_re </span><span class="s2">= </span><span class="s1">_lazy_re_compile</span><span class="s2">(</span>
    <span class="s3">r'^(?P&lt;value&gt;&quot;Plural-Forms.+?\\n&quot;)\s*$'</span><span class="s2">, </span><span class="s1">re</span><span class="s2">.</span><span class="s1">MULTILINE </span><span class="s2">| </span><span class="s1">re</span><span class="s2">.</span><span class="s1">DOTALL</span>
<span class="s2">)</span>
<span class="s1">STATUS_OK </span><span class="s2">= </span><span class="s4">0</span>
<span class="s1">NO_LOCALE_DIR </span><span class="s2">= </span><span class="s1">object</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">check_programs</span><span class="s2">(*</span><span class="s1">programs</span><span class="s2">):</span>
    <span class="s0">for </span><span class="s1">program </span><span class="s0">in </span><span class="s1">programs</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">find_command</span><span class="s2">(</span><span class="s1">program</span><span class="s2">) </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">CommandError</span><span class="s2">(</span>
                <span class="s3">&quot;Can't find %s. Make sure you have GNU gettext tools 0.15 or &quot;</span>
                <span class="s3">&quot;newer installed.&quot; </span><span class="s2">% </span><span class="s1">program</span>
            <span class="s2">)</span>


<span class="s0">def </span><span class="s1">is_valid_locale</span><span class="s2">(</span><span class="s1">locale</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">re</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s3">r&quot;^[a-z]+$&quot;</span><span class="s2">, </span><span class="s1">locale</span><span class="s2">) </span><span class="s0">or </span><span class="s1">re</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s3">r&quot;^[a-z]+_[A-Z].*$&quot;</span><span class="s2">, </span><span class="s1">locale</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">total_ordering</span>
<span class="s0">class </span><span class="s1">TranslatableFile</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dirpath</span><span class="s2">, </span><span class="s1">file_name</span><span class="s2">, </span><span class="s1">locale_dir</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">file </span><span class="s2">= </span><span class="s1">file_name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dirpath </span><span class="s2">= </span><span class="s1">dirpath</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">locale_dir </span><span class="s2">= </span><span class="s1">locale_dir</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s3">&quot;&lt;%s: %s&gt;&quot; </span><span class="s2">% (</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">,</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">sep</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dirpath</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file</span><span class="s2">]),</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path </span><span class="s2">== </span><span class="s1">other</span><span class="s2">.</span><span class="s1">path</span>

    <span class="s0">def </span><span class="s1">__lt__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path </span><span class="s2">&lt; </span><span class="s1">other</span><span class="s2">.</span><span class="s1">path</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">path</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dirpath</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">BuildFile</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot; 
    Represent the state of a translatable file during the build process. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">command</span><span class="s2">, </span><span class="s1">domain</span><span class="s2">, </span><span class="s1">translatable</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">command </span><span class="s2">= </span><span class="s1">command</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">domain </span><span class="s2">= </span><span class="s1">domain</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">translatable </span><span class="s2">= </span><span class="s1">translatable</span>

    <span class="s2">@</span><span class="s1">cached_property</span>
    <span class="s0">def </span><span class="s1">is_templatized</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">domain </span><span class="s2">== </span><span class="s3">&quot;djangojs&quot;</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">command</span><span class="s2">.</span><span class="s1">gettext_version </span><span class="s2">&lt; (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">18</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">domain </span><span class="s2">== </span><span class="s3">&quot;django&quot;</span><span class="s2">:</span>
            <span class="s1">file_ext </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">splitext</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">translatable</span><span class="s2">.</span><span class="s1">file</span><span class="s2">)[</span><span class="s4">1</span><span class="s2">]</span>
            <span class="s0">return </span><span class="s1">file_ext </span><span class="s2">!= </span><span class="s3">&quot;.py&quot;</span>
        <span class="s0">return False</span>

    <span class="s2">@</span><span class="s1">cached_property</span>
    <span class="s0">def </span><span class="s1">path</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">translatable</span><span class="s2">.</span><span class="s1">path</span>

    <span class="s2">@</span><span class="s1">cached_property</span>
    <span class="s0">def </span><span class="s1">work_path</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Path to a file which is being fed into GNU gettext pipeline. This may 
        be either a translatable or its preprocessed version. 
        &quot;&quot;&quot;</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_templatized</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span>
        <span class="s1">extension </span><span class="s2">= {</span>
            <span class="s3">&quot;djangojs&quot;</span><span class="s2">: </span><span class="s3">&quot;c&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;django&quot;</span><span class="s2">: </span><span class="s3">&quot;py&quot;</span><span class="s2">,</span>
        <span class="s2">}.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">domain</span><span class="s2">)</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s3">&quot;%s.%s&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">translatable</span><span class="s2">.</span><span class="s1">file</span><span class="s2">, </span><span class="s1">extension</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">translatable</span><span class="s2">.</span><span class="s1">dirpath</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">preprocess</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Preprocess (if necessary) a translatable file before passing it to 
        xgettext GNU gettext utility. 
        &quot;&quot;&quot;</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_templatized</span><span class="s2">:</span>
            <span class="s0">return</span>

        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fp</span><span class="s2">:</span>
            <span class="s1">src_data </span><span class="s2">= </span><span class="s1">fp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">domain </span><span class="s2">== </span><span class="s3">&quot;djangojs&quot;</span><span class="s2">:</span>
            <span class="s1">content </span><span class="s2">= </span><span class="s1">prepare_js_for_gettext</span><span class="s2">(</span><span class="s1">src_data</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">domain </span><span class="s2">== </span><span class="s3">&quot;django&quot;</span><span class="s2">:</span>
            <span class="s1">content </span><span class="s2">= </span><span class="s1">templatize</span><span class="s2">(</span><span class="s1">src_data</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span><span class="s2">[</span><span class="s4">2</span><span class="s2">:])</span>

        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">work_path</span><span class="s2">, </span><span class="s3">&quot;w&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fp</span><span class="s2">:</span>
            <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">content</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">postprocess_messages</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">msgs</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Postprocess messages generated by xgettext GNU gettext utility. 
 
        Transform paths as if these messages were generated from original 
        translatable files rather than from preprocessed versions. 
        &quot;&quot;&quot;</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_templatized</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">msgs</span>

        <span class="s6"># Remove '.py' suffix</span>
        <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s3">&quot;nt&quot;</span><span class="s2">:</span>
            <span class="s6"># Preserve '.\' prefix on Windows to respect gettext behavior</span>
            <span class="s1">old_path </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">work_path</span>
            <span class="s1">new_path </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">old_path </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">work_path</span><span class="s2">[</span><span class="s4">2</span><span class="s2">:]</span>
            <span class="s1">new_path </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span><span class="s2">[</span><span class="s4">2</span><span class="s2">:]</span>

        <span class="s0">return </span><span class="s1">re</span><span class="s2">.</span><span class="s1">sub</span><span class="s2">(</span>
            <span class="s3">r&quot;^(#: .*)(&quot; </span><span class="s2">+ </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">old_path</span><span class="s2">) + </span><span class="s3">r&quot;)&quot;</span><span class="s2">,</span>
            <span class="s0">lambda </span><span class="s1">match</span><span class="s2">: </span><span class="s1">match</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">old_path</span><span class="s2">, </span><span class="s1">new_path</span><span class="s2">),</span>
            <span class="s1">msgs</span><span class="s2">,</span>
            <span class="s1">flags</span><span class="s2">=</span><span class="s1">re</span><span class="s2">.</span><span class="s1">MULTILINE</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">cleanup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Remove a preprocessed copy of a translatable file (if any). 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_templatized</span><span class="s2">:</span>
            <span class="s6"># This check is needed for the case of a symlinked file and its</span>
            <span class="s6"># source being processed inside a single group (locale dir);</span>
            <span class="s6"># removing either of those two removes both.</span>
            <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">work_path</span><span class="s2">):</span>
                <span class="s1">os</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">work_path</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">normalize_eols</span><span class="s2">(</span><span class="s1">raw_contents</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Take a block of raw text that will be passed through str.splitlines() to 
    get universal newlines treatment. 
 
    Return the resulting block of text with normalized `\n` EOL sequences ready 
    to be written to disk using current platform's native EOLs. 
    &quot;&quot;&quot;</span>
    <span class="s1">lines_list </span><span class="s2">= </span><span class="s1">raw_contents</span><span class="s2">.</span><span class="s1">splitlines</span><span class="s2">()</span>
    <span class="s6"># Ensure last line has its EOL</span>
    <span class="s0">if </span><span class="s1">lines_list </span><span class="s0">and </span><span class="s1">lines_list</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]:</span>
        <span class="s1">lines_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">lines_list</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">write_pot_file</span><span class="s2">(</span><span class="s1">potfile</span><span class="s2">, </span><span class="s1">msgs</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Write the `potfile` with the `msgs` contents, making sure its format is 
    valid. 
    &quot;&quot;&quot;</span>
    <span class="s1">pot_lines </span><span class="s2">= </span><span class="s1">msgs</span><span class="s2">.</span><span class="s1">splitlines</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">potfile</span><span class="s2">):</span>
        <span class="s6"># Strip the header</span>
        <span class="s1">lines </span><span class="s2">= </span><span class="s1">dropwhile</span><span class="s2">(</span><span class="s1">len</span><span class="s2">, </span><span class="s1">pot_lines</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">lines </span><span class="s2">= []</span>
        <span class="s1">found</span><span class="s2">, </span><span class="s1">header_read </span><span class="s2">= </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span>
        <span class="s0">for </span><span class="s1">line </span><span class="s0">in </span><span class="s1">pot_lines</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">found </span><span class="s0">and not </span><span class="s1">header_read</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s3">&quot;charset=CHARSET&quot; </span><span class="s0">in </span><span class="s1">line</span><span class="s2">:</span>
                    <span class="s1">found </span><span class="s2">= </span><span class="s0">True</span>
                    <span class="s1">line </span><span class="s2">= </span><span class="s1">line</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">&quot;charset=CHARSET&quot;</span><span class="s2">, </span><span class="s3">&quot;charset=UTF-8&quot;</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">line </span><span class="s0">and not </span><span class="s1">found</span><span class="s2">:</span>
                <span class="s1">header_read </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s1">lines</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">line</span><span class="s2">)</span>
    <span class="s1">msgs </span><span class="s2">= </span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">)</span>
    <span class="s6"># Force newlines of POT files to '\n' to work around</span>
    <span class="s6"># https://savannah.gnu.org/bugs/index.php?52395</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">potfile</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">, </span><span class="s1">newline</span><span class="s2">=</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fp</span><span class="s2">:</span>
        <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Command</span><span class="s2">(</span><span class="s1">BaseCommand</span><span class="s2">):</span>
    <span class="s1">help </span><span class="s2">= (</span>
        <span class="s3">&quot;Runs over the entire source tree of the current directory and pulls out all &quot;</span>
        <span class="s3">&quot;strings marked for translation. It creates (or updates) a message file in the &quot;</span>
        <span class="s3">&quot;conf/locale (in the django tree) or locale (for projects and applications) &quot;</span>
        <span class="s3">&quot;directory.</span><span class="s0">\n\n</span><span class="s3">You must run this command with one of either the --locale, &quot;</span>
        <span class="s3">&quot;--exclude, or --all options.&quot;</span>
    <span class="s2">)</span>

    <span class="s1">translatable_file_class </span><span class="s2">= </span><span class="s1">TranslatableFile</span>
    <span class="s1">build_file_class </span><span class="s2">= </span><span class="s1">BuildFile</span>

    <span class="s1">requires_system_checks </span><span class="s2">= []</span>

    <span class="s1">msgmerge_options </span><span class="s2">= [</span><span class="s3">&quot;-q&quot;</span><span class="s2">, </span><span class="s3">&quot;--backup=none&quot;</span><span class="s2">, </span><span class="s3">&quot;--previous&quot;</span><span class="s2">, </span><span class="s3">&quot;--update&quot;</span><span class="s2">]</span>
    <span class="s1">msguniq_options </span><span class="s2">= [</span><span class="s3">&quot;--to-code=utf-8&quot;</span><span class="s2">]</span>
    <span class="s1">msgattrib_options </span><span class="s2">= [</span><span class="s3">&quot;--no-obsolete&quot;</span><span class="s2">]</span>
    <span class="s1">xgettext_options </span><span class="s2">= [</span><span class="s3">&quot;--from-code=UTF-8&quot;</span><span class="s2">, </span><span class="s3">&quot;--add-comments=Translators&quot;</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">add_arguments</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_argument</span><span class="s2">(</span>
            <span class="s3">&quot;--locale&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;-l&quot;</span><span class="s2">,</span>
            <span class="s1">default</span><span class="s2">=[],</span>
            <span class="s1">action</span><span class="s2">=</span><span class="s3">&quot;append&quot;</span><span class="s2">,</span>
            <span class="s1">help</span><span class="s2">=(</span>
                <span class="s3">&quot;Creates or updates the message files for the given locale(s) (e.g. &quot;</span>
                <span class="s3">&quot;pt_BR). Can be used multiple times.&quot;</span>
            <span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_argument</span><span class="s2">(</span>
            <span class="s3">&quot;--exclude&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;-x&quot;</span><span class="s2">,</span>
            <span class="s1">default</span><span class="s2">=[],</span>
            <span class="s1">action</span><span class="s2">=</span><span class="s3">&quot;append&quot;</span><span class="s2">,</span>
            <span class="s1">help</span><span class="s2">=</span><span class="s3">&quot;Locales to exclude. Default is none. Can be used multiple times.&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_argument</span><span class="s2">(</span>
            <span class="s3">&quot;--domain&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;-d&quot;</span><span class="s2">,</span>
            <span class="s1">default</span><span class="s2">=</span><span class="s3">&quot;django&quot;</span><span class="s2">,</span>
            <span class="s1">help</span><span class="s2">=</span><span class="s3">'The domain of the message files (default: &quot;django&quot;).'</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_argument</span><span class="s2">(</span>
            <span class="s3">&quot;--all&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;-a&quot;</span><span class="s2">,</span>
            <span class="s1">action</span><span class="s2">=</span><span class="s3">&quot;store_true&quot;</span><span class="s2">,</span>
            <span class="s1">help</span><span class="s2">=</span><span class="s3">&quot;Updates the message files for all existing locales.&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_argument</span><span class="s2">(</span>
            <span class="s3">&quot;--extension&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;-e&quot;</span><span class="s2">,</span>
            <span class="s1">dest</span><span class="s2">=</span><span class="s3">&quot;extensions&quot;</span><span class="s2">,</span>
            <span class="s1">action</span><span class="s2">=</span><span class="s3">&quot;append&quot;</span><span class="s2">,</span>
            <span class="s1">help</span><span class="s2">=</span><span class="s3">'The file extension(s) to examine (default: &quot;html,txt,py&quot;, or &quot;js&quot; '</span>
            <span class="s3">'if the domain is &quot;djangojs&quot;). Separate multiple extensions with '</span>
            <span class="s3">&quot;commas, or use -e multiple times.&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_argument</span><span class="s2">(</span>
            <span class="s3">&quot;--symlinks&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;-s&quot;</span><span class="s2">,</span>
            <span class="s1">action</span><span class="s2">=</span><span class="s3">&quot;store_true&quot;</span><span class="s2">,</span>
            <span class="s1">help</span><span class="s2">=</span><span class="s3">&quot;Follows symlinks to directories when examining source code &quot;</span>
            <span class="s3">&quot;and templates for translation strings.&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_argument</span><span class="s2">(</span>
            <span class="s3">&quot;--ignore&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;-i&quot;</span><span class="s2">,</span>
            <span class="s1">action</span><span class="s2">=</span><span class="s3">&quot;append&quot;</span><span class="s2">,</span>
            <span class="s1">dest</span><span class="s2">=</span><span class="s3">&quot;ignore_patterns&quot;</span><span class="s2">,</span>
            <span class="s1">default</span><span class="s2">=[],</span>
            <span class="s1">metavar</span><span class="s2">=</span><span class="s3">&quot;PATTERN&quot;</span><span class="s2">,</span>
            <span class="s1">help</span><span class="s2">=</span><span class="s3">&quot;Ignore files or directories matching this glob-style pattern. &quot;</span>
            <span class="s3">&quot;Use multiple times to ignore more.&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_argument</span><span class="s2">(</span>
            <span class="s3">&quot;--no-default-ignore&quot;</span><span class="s2">,</span>
            <span class="s1">action</span><span class="s2">=</span><span class="s3">&quot;store_false&quot;</span><span class="s2">,</span>
            <span class="s1">dest</span><span class="s2">=</span><span class="s3">&quot;use_default_ignore_patterns&quot;</span><span class="s2">,</span>
            <span class="s1">help</span><span class="s2">=(</span>
                <span class="s3">&quot;Don't ignore the common glob-style patterns 'CVS', '.*', '*~' and &quot;</span>
                <span class="s3">&quot;'*.pyc'.&quot;</span>
            <span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_argument</span><span class="s2">(</span>
            <span class="s3">&quot;--no-wrap&quot;</span><span class="s2">,</span>
            <span class="s1">action</span><span class="s2">=</span><span class="s3">&quot;store_true&quot;</span><span class="s2">,</span>
            <span class="s1">help</span><span class="s2">=</span><span class="s3">&quot;Don't break long message lines into several lines.&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_argument</span><span class="s2">(</span>
            <span class="s3">&quot;--no-location&quot;</span><span class="s2">,</span>
            <span class="s1">action</span><span class="s2">=</span><span class="s3">&quot;store_true&quot;</span><span class="s2">,</span>
            <span class="s1">help</span><span class="s2">=</span><span class="s3">&quot;Don't write '#: filename:line' lines.&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_argument</span><span class="s2">(</span>
            <span class="s3">&quot;--add-location&quot;</span><span class="s2">,</span>
            <span class="s1">choices</span><span class="s2">=(</span><span class="s3">&quot;full&quot;</span><span class="s2">, </span><span class="s3">&quot;file&quot;</span><span class="s2">, </span><span class="s3">&quot;never&quot;</span><span class="s2">),</span>
            <span class="s1">const</span><span class="s2">=</span><span class="s3">&quot;full&quot;</span><span class="s2">,</span>
            <span class="s1">nargs</span><span class="s2">=</span><span class="s3">&quot;?&quot;</span><span class="s2">,</span>
            <span class="s1">help</span><span class="s2">=(</span>
                <span class="s3">&quot;Controls '#: filename:line' lines. If the option is 'full' &quot;</span>
                <span class="s3">&quot;(the default if not given), the lines  include both file name &quot;</span>
                <span class="s3">&quot;and line number. If it's 'file', the line number is omitted. If &quot;</span>
                <span class="s3">&quot;it's 'never', the lines are suppressed (same as --no-location). &quot;</span>
                <span class="s3">&quot;--add-location requires gettext 0.19 or newer.&quot;</span>
            <span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_argument</span><span class="s2">(</span>
            <span class="s3">&quot;--no-obsolete&quot;</span><span class="s2">,</span>
            <span class="s1">action</span><span class="s2">=</span><span class="s3">&quot;store_true&quot;</span><span class="s2">,</span>
            <span class="s1">help</span><span class="s2">=</span><span class="s3">&quot;Remove obsolete message strings.&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_argument</span><span class="s2">(</span>
            <span class="s3">&quot;--keep-pot&quot;</span><span class="s2">,</span>
            <span class="s1">action</span><span class="s2">=</span><span class="s3">&quot;store_true&quot;</span><span class="s2">,</span>
            <span class="s1">help</span><span class="s2">=</span><span class="s3">&quot;Keep .pot file after making messages. Useful when debugging.&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">handle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">):</span>
        <span class="s1">locale </span><span class="s2">= </span><span class="s1">options</span><span class="s2">[</span><span class="s3">&quot;locale&quot;</span><span class="s2">]</span>
        <span class="s1">exclude </span><span class="s2">= </span><span class="s1">options</span><span class="s2">[</span><span class="s3">&quot;exclude&quot;</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">domain </span><span class="s2">= </span><span class="s1">options</span><span class="s2">[</span><span class="s3">&quot;domain&quot;</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">verbosity </span><span class="s2">= </span><span class="s1">options</span><span class="s2">[</span><span class="s3">&quot;verbosity&quot;</span><span class="s2">]</span>
        <span class="s1">process_all </span><span class="s2">= </span><span class="s1">options</span><span class="s2">[</span><span class="s3">&quot;all&quot;</span><span class="s2">]</span>
        <span class="s1">extensions </span><span class="s2">= </span><span class="s1">options</span><span class="s2">[</span><span class="s3">&quot;extensions&quot;</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">symlinks </span><span class="s2">= </span><span class="s1">options</span><span class="s2">[</span><span class="s3">&quot;symlinks&quot;</span><span class="s2">]</span>

        <span class="s1">ignore_patterns </span><span class="s2">= </span><span class="s1">options</span><span class="s2">[</span><span class="s3">&quot;ignore_patterns&quot;</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">options</span><span class="s2">[</span><span class="s3">&quot;use_default_ignore_patterns&quot;</span><span class="s2">]:</span>
            <span class="s1">ignore_patterns </span><span class="s2">+= [</span><span class="s3">&quot;CVS&quot;</span><span class="s2">, </span><span class="s3">&quot;.*&quot;</span><span class="s2">, </span><span class="s3">&quot;*~&quot;</span><span class="s2">, </span><span class="s3">&quot;*.pyc&quot;</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ignore_patterns </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">ignore_patterns</span><span class="s2">))</span>

        <span class="s6"># Avoid messing with mutable class variables</span>
        <span class="s0">if </span><span class="s1">options</span><span class="s2">[</span><span class="s3">&quot;no_wrap&quot;</span><span class="s2">]:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">msgmerge_options </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">msgmerge_options</span><span class="s2">[:] + [</span><span class="s3">&quot;--no-wrap&quot;</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">msguniq_options </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">msguniq_options</span><span class="s2">[:] + [</span><span class="s3">&quot;--no-wrap&quot;</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">msgattrib_options </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">msgattrib_options</span><span class="s2">[:] + [</span><span class="s3">&quot;--no-wrap&quot;</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">xgettext_options </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">xgettext_options</span><span class="s2">[:] + [</span><span class="s3">&quot;--no-wrap&quot;</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">options</span><span class="s2">[</span><span class="s3">&quot;no_location&quot;</span><span class="s2">]:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">msgmerge_options </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">msgmerge_options</span><span class="s2">[:] + [</span><span class="s3">&quot;--no-location&quot;</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">msguniq_options </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">msguniq_options</span><span class="s2">[:] + [</span><span class="s3">&quot;--no-location&quot;</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">msgattrib_options </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">msgattrib_options</span><span class="s2">[:] + [</span><span class="s3">&quot;--no-location&quot;</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">xgettext_options </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">xgettext_options</span><span class="s2">[:] + [</span><span class="s3">&quot;--no-location&quot;</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">options</span><span class="s2">[</span><span class="s3">&quot;add_location&quot;</span><span class="s2">]:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gettext_version </span><span class="s2">&lt; (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">19</span><span class="s2">):</span>
                <span class="s0">raise </span><span class="s1">CommandError</span><span class="s2">(</span>
                    <span class="s3">&quot;The --add-location option requires gettext 0.19 or later. &quot;</span>
                    <span class="s3">&quot;You have %s.&quot; </span><span class="s2">% </span><span class="s3">&quot;.&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gettext_version</span><span class="s2">)</span>
                <span class="s2">)</span>
            <span class="s1">arg_add_location </span><span class="s2">= </span><span class="s3">&quot;--add-location=%s&quot; </span><span class="s2">% </span><span class="s1">options</span><span class="s2">[</span><span class="s3">&quot;add_location&quot;</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">msgmerge_options </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">msgmerge_options</span><span class="s2">[:] + [</span><span class="s1">arg_add_location</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">msguniq_options </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">msguniq_options</span><span class="s2">[:] + [</span><span class="s1">arg_add_location</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">msgattrib_options </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">msgattrib_options</span><span class="s2">[:] + [</span><span class="s1">arg_add_location</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">xgettext_options </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">xgettext_options</span><span class="s2">[:] + [</span><span class="s1">arg_add_location</span><span class="s2">]</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">no_obsolete </span><span class="s2">= </span><span class="s1">options</span><span class="s2">[</span><span class="s3">&quot;no_obsolete&quot;</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">keep_pot </span><span class="s2">= </span><span class="s1">options</span><span class="s2">[</span><span class="s3">&quot;keep_pot&quot;</span><span class="s2">]</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">domain </span><span class="s0">not in </span><span class="s2">(</span><span class="s3">&quot;django&quot;</span><span class="s2">, </span><span class="s3">&quot;djangojs&quot;</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">CommandError</span><span class="s2">(</span>
                <span class="s3">&quot;currently makemessages only supports domains &quot;</span>
                <span class="s3">&quot;'django' and 'djangojs'&quot;</span>
            <span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">domain </span><span class="s2">== </span><span class="s3">&quot;djangojs&quot;</span><span class="s2">:</span>
            <span class="s1">exts </span><span class="s2">= </span><span class="s1">extensions </span><span class="s0">or </span><span class="s2">[</span><span class="s3">&quot;js&quot;</span><span class="s2">]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">exts </span><span class="s2">= </span><span class="s1">extensions </span><span class="s0">or </span><span class="s2">[</span><span class="s3">&quot;html&quot;</span><span class="s2">, </span><span class="s3">&quot;txt&quot;</span><span class="s2">, </span><span class="s3">&quot;py&quot;</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">extensions </span><span class="s2">= </span><span class="s1">handle_extensions</span><span class="s2">(</span><span class="s1">exts</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s2">(</span><span class="s0">not </span><span class="s1">locale </span><span class="s0">and not </span><span class="s1">exclude </span><span class="s0">and not </span><span class="s1">process_all</span><span class="s2">) </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">domain </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">CommandError</span><span class="s2">(</span>
                <span class="s3">&quot;Type '%s help %s' for usage information.&quot;</span>
                <span class="s2">% (</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">basename</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">argv</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]), </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">argv</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>
            <span class="s2">)</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">verbosity </span><span class="s2">&gt; </span><span class="s4">1</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span>
                <span class="s3">&quot;examining files with the extensions: %s&quot;</span>
                <span class="s2">% </span><span class="s1">get_text_list</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">extensions</span><span class="s2">), </span><span class="s3">&quot;and&quot;</span><span class="s2">)</span>
            <span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">invoked_for_django </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">locale_paths </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">default_locale_path </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isdir</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">&quot;conf&quot;</span><span class="s2">, </span><span class="s3">&quot;locale&quot;</span><span class="s2">)):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">locale_paths </span><span class="s2">= [</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">&quot;conf&quot;</span><span class="s2">, </span><span class="s3">&quot;locale&quot;</span><span class="s2">))]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">default_locale_path </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">locale_paths</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ignore_patterns</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">&quot;views/templates/i18n_catalog.js&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">invoked_for_django </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">settings_available</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">locale_paths</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">settings</span><span class="s2">.</span><span class="s1">LOCALE_PATHS</span><span class="s2">)</span>
            <span class="s6"># Allow to run makemessages inside an app dir</span>
            <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isdir</span><span class="s2">(</span><span class="s3">&quot;locale&quot;</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">locale_paths</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s3">&quot;locale&quot;</span><span class="s2">))</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">locale_paths</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">default_locale_path </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">locale_paths</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
                <span class="s1">os</span><span class="s2">.</span><span class="s1">makedirs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">default_locale_path</span><span class="s2">, </span><span class="s1">exist_ok</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

        <span class="s6"># Build locale list</span>
        <span class="s1">looks_like_locale </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s3">r&quot;[a-z]{2}&quot;</span><span class="s2">)</span>
        <span class="s1">locale_dirs </span><span class="s2">= </span><span class="s1">filter</span><span class="s2">(</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isdir</span><span class="s2">, </span><span class="s1">glob</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s3">&quot;%s/*&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">default_locale_path</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s1">all_locales </span><span class="s2">= [</span>
            <span class="s1">lang_code</span>
            <span class="s0">for </span><span class="s1">lang_code </span><span class="s0">in </span><span class="s1">map</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">basename</span><span class="s2">, </span><span class="s1">locale_dirs</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">looks_like_locale</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">lang_code</span><span class="s2">)</span>
        <span class="s2">]</span>

        <span class="s6"># Account for excluded locales</span>
        <span class="s0">if </span><span class="s1">process_all</span><span class="s2">:</span>
            <span class="s1">locales </span><span class="s2">= </span><span class="s1">all_locales</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">locales </span><span class="s2">= </span><span class="s1">locale </span><span class="s0">or </span><span class="s1">all_locales</span>
            <span class="s1">locales </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">locales</span><span class="s2">).</span><span class="s1">difference</span><span class="s2">(</span><span class="s1">exclude</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">locales</span><span class="s2">:</span>
            <span class="s1">check_programs</span><span class="s2">(</span><span class="s3">&quot;msguniq&quot;</span><span class="s2">, </span><span class="s3">&quot;msgmerge&quot;</span><span class="s2">, </span><span class="s3">&quot;msgattrib&quot;</span><span class="s2">)</span>

        <span class="s1">check_programs</span><span class="s2">(</span><span class="s3">&quot;xgettext&quot;</span><span class="s2">)</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">potfiles </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build_potfiles</span><span class="s2">()</span>

            <span class="s6"># Build po files for each selected locale</span>
            <span class="s0">for </span><span class="s1">locale </span><span class="s0">in </span><span class="s1">locales</span><span class="s2">:</span>
                <span class="s0">if not </span><span class="s1">is_valid_locale</span><span class="s2">(</span><span class="s1">locale</span><span class="s2">):</span>
                    <span class="s6"># Try to guess what valid locale it could be</span>
                    <span class="s6"># Valid examples are: en_GB, shi_Latn_MA and nl_NL-x-informal</span>

                    <span class="s6"># Search for characters followed by a non character (i.e. separator)</span>
                    <span class="s1">match </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span>
                        <span class="s3">r&quot;^(?P&lt;language&gt;[a-zA-Z]+)&quot;</span>
                        <span class="s3">r&quot;(?P&lt;separator&gt;[^a-zA-Z])&quot;</span>
                        <span class="s3">r&quot;(?P&lt;territory&gt;.+)$&quot;</span><span class="s2">,</span>
                        <span class="s1">locale</span><span class="s2">,</span>
                    <span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">match</span><span class="s2">:</span>
                        <span class="s1">locale_parts </span><span class="s2">= </span><span class="s1">match</span><span class="s2">.</span><span class="s1">groupdict</span><span class="s2">()</span>
                        <span class="s1">language </span><span class="s2">= </span><span class="s1">locale_parts</span><span class="s2">[</span><span class="s3">&quot;language&quot;</span><span class="s2">].</span><span class="s1">lower</span><span class="s2">()</span>
                        <span class="s1">territory </span><span class="s2">= (</span>
                            <span class="s1">locale_parts</span><span class="s2">[</span><span class="s3">&quot;territory&quot;</span><span class="s2">][:</span><span class="s4">2</span><span class="s2">].</span><span class="s1">upper</span><span class="s2">()</span>
                            <span class="s2">+ </span><span class="s1">locale_parts</span><span class="s2">[</span><span class="s3">&quot;territory&quot;</span><span class="s2">][</span><span class="s4">2</span><span class="s2">:]</span>
                        <span class="s2">)</span>
                        <span class="s1">proposed_locale </span><span class="s2">= </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">language</span><span class="s0">}</span><span class="s3">_</span><span class="s0">{</span><span class="s1">territory</span><span class="s0">}</span><span class="s3">&quot;</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s6"># It could be a language in uppercase</span>
                        <span class="s1">proposed_locale </span><span class="s2">= </span><span class="s1">locale</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()</span>

                    <span class="s6"># Recheck if the proposed locale is valid</span>
                    <span class="s0">if </span><span class="s1">is_valid_locale</span><span class="s2">(</span><span class="s1">proposed_locale</span><span class="s2">):</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span>
                            <span class="s3">&quot;invalid locale %s, did you mean %s?&quot;</span>
                            <span class="s2">% (</span>
                                <span class="s1">locale</span><span class="s2">,</span>
                                <span class="s1">proposed_locale</span><span class="s2">,</span>
                            <span class="s2">),</span>
                        <span class="s2">)</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;invalid locale %s&quot; </span><span class="s2">% </span><span class="s1">locale</span><span class="s2">)</span>

                    <span class="s0">continue</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">verbosity </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;processing locale %s&quot; </span><span class="s2">% </span><span class="s1">locale</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">potfile </span><span class="s0">in </span><span class="s1">potfiles</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">write_po_file</span><span class="s2">(</span><span class="s1">potfile</span><span class="s2">, </span><span class="s1">locale</span><span class="s2">)</span>
        <span class="s0">finally</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">keep_pot</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">remove_potfiles</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">cached_property</span>
    <span class="s0">def </span><span class="s1">gettext_version</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Gettext tools will output system-encoded bytestrings instead of UTF-8,</span>
        <span class="s6"># when looking up the version. It's especially a problem on Windows.</span>
        <span class="s1">out</span><span class="s2">, </span><span class="s1">err</span><span class="s2">, </span><span class="s1">status </span><span class="s2">= </span><span class="s1">popen_wrapper</span><span class="s2">(</span>
            <span class="s2">[</span><span class="s3">&quot;xgettext&quot;</span><span class="s2">, </span><span class="s3">&quot;--version&quot;</span><span class="s2">],</span>
            <span class="s1">stdout_encoding</span><span class="s2">=</span><span class="s1">DEFAULT_LOCALE_ENCODING</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">search</span><span class="s2">(</span><span class="s3">r&quot;(\d+)\.(\d+)\.?(\d+)?&quot;</span><span class="s2">, </span><span class="s1">out</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">m</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">d</span><span class="s2">) </span><span class="s0">for </span><span class="s1">d </span><span class="s0">in </span><span class="s1">m</span><span class="s2">.</span><span class="s1">groups</span><span class="s2">() </span><span class="s0">if </span><span class="s1">d </span><span class="s0">is not None</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">CommandError</span><span class="s2">(</span><span class="s3">&quot;Unable to get gettext version. Is it installed?&quot;</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">cached_property</span>
    <span class="s0">def </span><span class="s1">settings_available</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">settings</span><span class="s2">.</span><span class="s1">LOCALE_PATHS</span>
        <span class="s0">except </span><span class="s1">ImproperlyConfigured</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">verbosity </span><span class="s2">&gt; </span><span class="s4">1</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">stderr</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;Running without configured settings.&quot;</span><span class="s2">)</span>
            <span class="s0">return False</span>
        <span class="s0">return True</span>

    <span class="s0">def </span><span class="s1">build_potfiles</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Build pot files and apply msguniq to them. 
        &quot;&quot;&quot;</span>
        <span class="s1">file_list </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">find_files</span><span class="s2">(</span><span class="s3">&quot;.&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">remove_potfiles</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">process_files</span><span class="s2">(</span><span class="s1">file_list</span><span class="s2">)</span>
        <span class="s1">potfiles </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">path </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">locale_paths</span><span class="s2">:</span>
            <span class="s1">potfile </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s3">&quot;%s.pot&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">domain</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">potfile</span><span class="s2">):</span>
                <span class="s0">continue</span>
            <span class="s1">args </span><span class="s2">= [</span><span class="s3">&quot;msguniq&quot;</span><span class="s2">] + </span><span class="s1">self</span><span class="s2">.</span><span class="s1">msguniq_options </span><span class="s2">+ [</span><span class="s1">potfile</span><span class="s2">]</span>
            <span class="s1">msgs</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">, </span><span class="s1">status </span><span class="s2">= </span><span class="s1">popen_wrapper</span><span class="s2">(</span><span class="s1">args</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">errors</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">status </span><span class="s2">!= </span><span class="s1">STATUS_OK</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">CommandError</span><span class="s2">(</span>
                        <span class="s3">&quot;errors happened while running msguniq</span><span class="s0">\n</span><span class="s3">%s&quot; </span><span class="s2">% </span><span class="s1">errors</span>
                    <span class="s2">)</span>
                <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">verbosity </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">errors</span><span class="s2">)</span>
            <span class="s1">msgs </span><span class="s2">= </span><span class="s1">normalize_eols</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">potfile</span><span class="s2">, </span><span class="s3">&quot;w&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fp</span><span class="s2">:</span>
                <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">)</span>
            <span class="s1">potfiles</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">potfile</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">potfiles</span>

    <span class="s0">def </span><span class="s1">remove_potfiles</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">path </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">locale_paths</span><span class="s2">:</span>
            <span class="s1">pot_path </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s3">&quot;%s.pot&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">domain</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">pot_path</span><span class="s2">):</span>
                <span class="s1">os</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">(</span><span class="s1">pot_path</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">find_files</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">root</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Get all files in the given root. Also check that there is a matching 
        locale dir for each file. 
        &quot;&quot;&quot;</span>
        <span class="s1">all_files </span><span class="s2">= []</span>
        <span class="s1">ignored_roots </span><span class="s2">= []</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">settings_available</span><span class="s2">:</span>
            <span class="s1">ignored_roots </span><span class="s2">= [</span>
                <span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">normpath</span><span class="s2">(</span><span class="s1">p</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s2">(</span><span class="s1">settings</span><span class="s2">.</span><span class="s1">MEDIA_ROOT</span><span class="s2">, </span><span class="s1">settings</span><span class="s2">.</span><span class="s1">STATIC_ROOT</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">p</span>
            <span class="s2">]</span>
        <span class="s0">for </span><span class="s1">dirpath</span><span class="s2">, </span><span class="s1">dirnames</span><span class="s2">, </span><span class="s1">filenames </span><span class="s0">in </span><span class="s1">os</span><span class="s2">.</span><span class="s1">walk</span><span class="s2">(</span>
            <span class="s1">root</span><span class="s2">, </span><span class="s1">topdown</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">followlinks</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">symlinks</span>
        <span class="s2">):</span>
            <span class="s0">for </span><span class="s1">dirname </span><span class="s0">in </span><span class="s1">dirnames</span><span class="s2">[:]:</span>
                <span class="s0">if </span><span class="s2">(</span>
                    <span class="s1">is_ignored_path</span><span class="s2">(</span>
                        <span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">normpath</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dirpath</span><span class="s2">, </span><span class="s1">dirname</span><span class="s2">)),</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">ignore_patterns</span><span class="s2">,</span>
                    <span class="s2">)</span>
                    <span class="s0">or </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s1">dirpath</span><span class="s2">), </span><span class="s1">dirname</span><span class="s2">) </span><span class="s0">in </span><span class="s1">ignored_roots</span>
                <span class="s2">):</span>
                    <span class="s1">dirnames</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">dirname</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">verbosity </span><span class="s2">&gt; </span><span class="s4">1</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;ignoring directory %s&quot; </span><span class="s2">% </span><span class="s1">dirname</span><span class="s2">)</span>
                <span class="s0">elif </span><span class="s1">dirname </span><span class="s2">== </span><span class="s3">&quot;locale&quot;</span><span class="s2">:</span>
                    <span class="s1">dirnames</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">dirname</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">locale_paths</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span>
                        <span class="s4">0</span><span class="s2">, </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s1">dirpath</span><span class="s2">), </span><span class="s1">dirname</span><span class="s2">)</span>
                    <span class="s2">)</span>
            <span class="s0">for </span><span class="s1">filename </span><span class="s0">in </span><span class="s1">filenames</span><span class="s2">:</span>
                <span class="s1">file_path </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">normpath</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dirpath</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">))</span>
                <span class="s1">file_ext </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">splitext</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)[</span><span class="s4">1</span><span class="s2">]</span>
                <span class="s0">if </span><span class="s1">file_ext </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">extensions </span><span class="s0">or </span><span class="s1">is_ignored_path</span><span class="s2">(</span>
                    <span class="s1">file_path</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ignore_patterns</span>
                <span class="s2">):</span>
                    <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">verbosity </span><span class="s2">&gt; </span><span class="s4">1</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span>
                            <span class="s3">&quot;ignoring file %s in %s&quot; </span><span class="s2">% (</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">dirpath</span><span class="s2">)</span>
                        <span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">locale_dir </span><span class="s2">= </span><span class="s0">None</span>
                    <span class="s0">for </span><span class="s1">path </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">locale_paths</span><span class="s2">:</span>
                        <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s1">dirpath</span><span class="s2">).</span><span class="s1">startswith</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)):</span>
                            <span class="s1">locale_dir </span><span class="s2">= </span><span class="s1">path</span>
                            <span class="s0">break</span>
                    <span class="s1">locale_dir </span><span class="s2">= </span><span class="s1">locale_dir </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">default_locale_path </span><span class="s0">or </span><span class="s1">NO_LOCALE_DIR</span>
                    <span class="s1">all_files</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">translatable_file_class</span><span class="s2">(</span><span class="s1">dirpath</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">, </span><span class="s1">locale_dir</span><span class="s2">)</span>
                    <span class="s2">)</span>
        <span class="s0">return </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">all_files</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">process_files</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file_list</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Group translatable files by locale directory and run pot file build 
        process for each group. 
        &quot;&quot;&quot;</span>
        <span class="s1">file_groups </span><span class="s2">= {}</span>
        <span class="s0">for </span><span class="s1">translatable </span><span class="s0">in </span><span class="s1">file_list</span><span class="s2">:</span>
            <span class="s1">file_group </span><span class="s2">= </span><span class="s1">file_groups</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s1">translatable</span><span class="s2">.</span><span class="s1">locale_dir</span><span class="s2">, [])</span>
            <span class="s1">file_group</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">translatable</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">locale_dir</span><span class="s2">, </span><span class="s1">files </span><span class="s0">in </span><span class="s1">file_groups</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">process_locale_dir</span><span class="s2">(</span><span class="s1">locale_dir</span><span class="s2">, </span><span class="s1">files</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">process_locale_dir</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">locale_dir</span><span class="s2">, </span><span class="s1">files</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Extract translatable literals from the specified files, creating or 
        updating the POT file for a given locale directory. 
 
        Use the xgettext GNU gettext utility. 
        &quot;&quot;&quot;</span>
        <span class="s1">build_files </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">translatable </span><span class="s0">in </span><span class="s1">files</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">verbosity </span><span class="s2">&gt; </span><span class="s4">1</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span>
                    <span class="s3">&quot;processing file %s in %s&quot;</span>
                    <span class="s2">% (</span><span class="s1">translatable</span><span class="s2">.</span><span class="s1">file</span><span class="s2">, </span><span class="s1">translatable</span><span class="s2">.</span><span class="s1">dirpath</span><span class="s2">)</span>
                <span class="s2">)</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">domain </span><span class="s0">not in </span><span class="s2">(</span><span class="s3">&quot;djangojs&quot;</span><span class="s2">, </span><span class="s3">&quot;django&quot;</span><span class="s2">):</span>
                <span class="s0">continue</span>
            <span class="s1">build_file </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build_file_class</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">domain</span><span class="s2">, </span><span class="s1">translatable</span><span class="s2">)</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">build_file</span><span class="s2">.</span><span class="s1">preprocess</span><span class="s2">()</span>
            <span class="s0">except </span><span class="s1">UnicodeDecodeError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span>
                    <span class="s3">&quot;UnicodeDecodeError: skipped file %s in %s (reason: %s)&quot;</span>
                    <span class="s2">% (</span>
                        <span class="s1">translatable</span><span class="s2">.</span><span class="s1">file</span><span class="s2">,</span>
                        <span class="s1">translatable</span><span class="s2">.</span><span class="s1">dirpath</span><span class="s2">,</span>
                        <span class="s1">e</span><span class="s2">,</span>
                    <span class="s2">)</span>
                <span class="s2">)</span>
                <span class="s0">continue</span>
            <span class="s0">except </span><span class="s1">BaseException</span><span class="s2">:</span>
                <span class="s6"># Cleanup before exit.</span>
                <span class="s0">for </span><span class="s1">build_file </span><span class="s0">in </span><span class="s1">build_files</span><span class="s2">:</span>
                    <span class="s1">build_file</span><span class="s2">.</span><span class="s1">cleanup</span><span class="s2">()</span>
                <span class="s0">raise</span>
            <span class="s1">build_files</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">build_file</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">domain </span><span class="s2">== </span><span class="s3">&quot;djangojs&quot;</span><span class="s2">:</span>
            <span class="s1">is_templatized </span><span class="s2">= </span><span class="s1">build_file</span><span class="s2">.</span><span class="s1">is_templatized</span>
            <span class="s1">args </span><span class="s2">= [</span>
                <span class="s3">&quot;xgettext&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;-d&quot;</span><span class="s2">,</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">domain</span><span class="s2">,</span>
                <span class="s3">&quot;--language=%s&quot; </span><span class="s2">% (</span><span class="s3">&quot;C&quot; </span><span class="s0">if </span><span class="s1">is_templatized </span><span class="s0">else </span><span class="s3">&quot;JavaScript&quot;</span><span class="s2">,),</span>
                <span class="s3">&quot;--keyword=gettext_noop&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;--keyword=gettext_lazy&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;--keyword=ngettext_lazy:1,2&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;--keyword=pgettext:1c,2&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;--keyword=npgettext:1c,2,3&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;--output=-&quot;</span><span class="s2">,</span>
            <span class="s2">]</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">domain </span><span class="s2">== </span><span class="s3">&quot;django&quot;</span><span class="s2">:</span>
            <span class="s1">args </span><span class="s2">= [</span>
                <span class="s3">&quot;xgettext&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;-d&quot;</span><span class="s2">,</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">domain</span><span class="s2">,</span>
                <span class="s3">&quot;--language=Python&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;--keyword=gettext_noop&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;--keyword=gettext_lazy&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;--keyword=ngettext_lazy:1,2&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;--keyword=pgettext:1c,2&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;--keyword=npgettext:1c,2,3&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;--keyword=pgettext_lazy:1c,2&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;--keyword=npgettext_lazy:1c,2,3&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;--output=-&quot;</span><span class="s2">,</span>
            <span class="s2">]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return</span>

        <span class="s1">input_files </span><span class="s2">= [</span><span class="s1">bf</span><span class="s2">.</span><span class="s1">work_path </span><span class="s0">for </span><span class="s1">bf </span><span class="s0">in </span><span class="s1">build_files</span><span class="s2">]</span>
        <span class="s0">with </span><span class="s1">NamedTemporaryFile</span><span class="s2">(</span><span class="s1">mode</span><span class="s2">=</span><span class="s3">&quot;w+&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">input_files_list</span><span class="s2">:</span>
            <span class="s1">input_files_list</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">input_files</span><span class="s2">))</span>
            <span class="s1">input_files_list</span><span class="s2">.</span><span class="s1">flush</span><span class="s2">()</span>
            <span class="s1">args</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span><span class="s3">&quot;--files-from&quot;</span><span class="s2">, </span><span class="s1">input_files_list</span><span class="s2">.</span><span class="s1">name</span><span class="s2">])</span>
            <span class="s1">args</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xgettext_options</span><span class="s2">)</span>
            <span class="s1">msgs</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">, </span><span class="s1">status </span><span class="s2">= </span><span class="s1">popen_wrapper</span><span class="s2">(</span><span class="s1">args</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">errors</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">status </span><span class="s2">!= </span><span class="s1">STATUS_OK</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">build_file </span><span class="s0">in </span><span class="s1">build_files</span><span class="s2">:</span>
                    <span class="s1">build_file</span><span class="s2">.</span><span class="s1">cleanup</span><span class="s2">()</span>
                <span class="s0">raise </span><span class="s1">CommandError</span><span class="s2">(</span>
                    <span class="s3">&quot;errors happened while running xgettext on %s</span><span class="s0">\n</span><span class="s3">%s&quot;</span>
                    <span class="s2">% (</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">input_files</span><span class="s2">), </span><span class="s1">errors</span><span class="s2">)</span>
                <span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">verbosity </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:</span>
                <span class="s6"># Print warnings</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">errors</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">msgs</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">locale_dir </span><span class="s0">is </span><span class="s1">NO_LOCALE_DIR</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">build_file </span><span class="s0">in </span><span class="s1">build_files</span><span class="s2">:</span>
                    <span class="s1">build_file</span><span class="s2">.</span><span class="s1">cleanup</span><span class="s2">()</span>
                <span class="s1">file_path </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">normpath</span><span class="s2">(</span><span class="s1">build_files</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">path</span><span class="s2">)</span>
                <span class="s0">raise </span><span class="s1">CommandError</span><span class="s2">(</span>
                    <span class="s3">&quot;Unable to find a locale path to store translations for &quot;</span>
                    <span class="s3">&quot;file %s. Make sure the 'locale' directory exists in an &quot;</span>
                    <span class="s3">&quot;app or LOCALE_PATHS setting is set.&quot; </span><span class="s2">% </span><span class="s1">file_path</span>
                <span class="s2">)</span>
            <span class="s0">for </span><span class="s1">build_file </span><span class="s0">in </span><span class="s1">build_files</span><span class="s2">:</span>
                <span class="s1">msgs </span><span class="s2">= </span><span class="s1">build_file</span><span class="s2">.</span><span class="s1">postprocess_messages</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">)</span>
            <span class="s1">potfile </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">locale_dir</span><span class="s2">, </span><span class="s3">&quot;%s.pot&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">domain</span><span class="s2">)</span>
            <span class="s1">write_pot_file</span><span class="s2">(</span><span class="s1">potfile</span><span class="s2">, </span><span class="s1">msgs</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">build_file </span><span class="s0">in </span><span class="s1">build_files</span><span class="s2">:</span>
            <span class="s1">build_file</span><span class="s2">.</span><span class="s1">cleanup</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">write_po_file</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">potfile</span><span class="s2">, </span><span class="s1">locale</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Create or update the PO file for self.domain and `locale`. 
        Use contents of the existing `potfile`. 
 
        Use msgmerge and msgattrib GNU gettext utilities. 
        &quot;&quot;&quot;</span>
        <span class="s1">basedir </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">potfile</span><span class="s2">), </span><span class="s1">locale</span><span class="s2">, </span><span class="s3">&quot;LC_MESSAGES&quot;</span><span class="s2">)</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">makedirs</span><span class="s2">(</span><span class="s1">basedir</span><span class="s2">, </span><span class="s1">exist_ok</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">pofile </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">basedir</span><span class="s2">, </span><span class="s3">&quot;%s.po&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">domain</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">pofile</span><span class="s2">):</span>
            <span class="s1">args </span><span class="s2">= [</span><span class="s3">&quot;msgmerge&quot;</span><span class="s2">] + </span><span class="s1">self</span><span class="s2">.</span><span class="s1">msgmerge_options </span><span class="s2">+ [</span><span class="s1">pofile</span><span class="s2">, </span><span class="s1">potfile</span><span class="s2">]</span>
            <span class="s1">_</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">, </span><span class="s1">status </span><span class="s2">= </span><span class="s1">popen_wrapper</span><span class="s2">(</span><span class="s1">args</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">errors</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">status </span><span class="s2">!= </span><span class="s1">STATUS_OK</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">CommandError</span><span class="s2">(</span>
                        <span class="s3">&quot;errors happened while running msgmerge</span><span class="s0">\n</span><span class="s3">%s&quot; </span><span class="s2">% </span><span class="s1">errors</span>
                    <span class="s2">)</span>
                <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">verbosity </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">errors</span><span class="s2">)</span>
            <span class="s1">msgs </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">pofile</span><span class="s2">).</span><span class="s1">read_text</span><span class="s2">(</span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">potfile</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fp</span><span class="s2">:</span>
                <span class="s1">msgs </span><span class="s2">= </span><span class="s1">fp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">()</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">invoked_for_django</span><span class="s2">:</span>
                <span class="s1">msgs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">copy_plural_forms</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">, </span><span class="s1">locale</span><span class="s2">)</span>
        <span class="s1">msgs </span><span class="s2">= </span><span class="s1">normalize_eols</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">)</span>
        <span class="s1">msgs </span><span class="s2">= </span><span class="s1">msgs</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span>
            <span class="s3">&quot;#. #-#-#-#-#  %s.pot (PACKAGE VERSION)  #-#-#-#-#</span><span class="s0">\n</span><span class="s3">&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">domain</span><span class="s2">, </span><span class="s3">&quot;&quot;</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">pofile</span><span class="s2">, </span><span class="s3">&quot;w&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fp</span><span class="s2">:</span>
            <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">msgs</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">no_obsolete</span><span class="s2">:</span>
            <span class="s1">args </span><span class="s2">= [</span><span class="s3">&quot;msgattrib&quot;</span><span class="s2">] + </span><span class="s1">self</span><span class="s2">.</span><span class="s1">msgattrib_options </span><span class="s2">+ [</span><span class="s3">&quot;-o&quot;</span><span class="s2">, </span><span class="s1">pofile</span><span class="s2">, </span><span class="s1">pofile</span><span class="s2">]</span>
            <span class="s1">msgs</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">, </span><span class="s1">status </span><span class="s2">= </span><span class="s1">popen_wrapper</span><span class="s2">(</span><span class="s1">args</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">errors</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">status </span><span class="s2">!= </span><span class="s1">STATUS_OK</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">CommandError</span><span class="s2">(</span>
                        <span class="s3">&quot;errors happened while running msgattrib</span><span class="s0">\n</span><span class="s3">%s&quot; </span><span class="s2">% </span><span class="s1">errors</span>
                    <span class="s2">)</span>
                <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">verbosity </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">errors</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">copy_plural_forms</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">msgs</span><span class="s2">, </span><span class="s1">locale</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Copy plural forms header contents from a Django catalog of locale to 
        the msgs string, inserting it at the right place. msgs should be the 
        contents of a newly created .po file. 
        &quot;&quot;&quot;</span>
        <span class="s1">django_dir </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">normpath</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">django</span><span class="s2">.</span><span class="s1">__file__</span><span class="s2">)))</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">domain </span><span class="s2">== </span><span class="s3">&quot;djangojs&quot;</span><span class="s2">:</span>
            <span class="s1">domains </span><span class="s2">= (</span><span class="s3">&quot;djangojs&quot;</span><span class="s2">, </span><span class="s3">&quot;django&quot;</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">domains </span><span class="s2">= (</span><span class="s3">&quot;django&quot;</span><span class="s2">,)</span>
        <span class="s0">for </span><span class="s1">domain </span><span class="s0">in </span><span class="s1">domains</span><span class="s2">:</span>
            <span class="s1">django_po </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span>
                <span class="s1">django_dir</span><span class="s2">, </span><span class="s3">&quot;conf&quot;</span><span class="s2">, </span><span class="s3">&quot;locale&quot;</span><span class="s2">, </span><span class="s1">locale</span><span class="s2">, </span><span class="s3">&quot;LC_MESSAGES&quot;</span><span class="s2">, </span><span class="s3">&quot;%s.po&quot; </span><span class="s2">% </span><span class="s1">domain</span>
            <span class="s2">)</span>
            <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">django_po</span><span class="s2">):</span>
                <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">django_po</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fp</span><span class="s2">:</span>
                    <span class="s1">m </span><span class="s2">= </span><span class="s1">plural_forms_re</span><span class="s2">.</span><span class="s1">search</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">())</span>
                <span class="s0">if </span><span class="s1">m</span><span class="s2">:</span>
                    <span class="s1">plural_form_line </span><span class="s2">= </span><span class="s1">m</span><span class="s2">[</span><span class="s3">&quot;value&quot;</span><span class="s2">]</span>
                    <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">verbosity </span><span class="s2">&gt; </span><span class="s4">1</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;copying plural forms: %s&quot; </span><span class="s2">% </span><span class="s1">plural_form_line</span><span class="s2">)</span>
                    <span class="s1">lines </span><span class="s2">= []</span>
                    <span class="s1">found </span><span class="s2">= </span><span class="s0">False</span>
                    <span class="s0">for </span><span class="s1">line </span><span class="s0">in </span><span class="s1">msgs</span><span class="s2">.</span><span class="s1">splitlines</span><span class="s2">():</span>
                        <span class="s0">if not </span><span class="s1">found </span><span class="s0">and </span><span class="s2">(</span><span class="s0">not </span><span class="s1">line </span><span class="s0">or </span><span class="s1">plural_forms_re</span><span class="s2">.</span><span class="s1">search</span><span class="s2">(</span><span class="s1">line</span><span class="s2">)):</span>
                            <span class="s1">line </span><span class="s2">= </span><span class="s1">plural_form_line</span>
                            <span class="s1">found </span><span class="s2">= </span><span class="s0">True</span>
                        <span class="s1">lines</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">line</span><span class="s2">)</span>
                    <span class="s1">msgs </span><span class="s2">= </span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">)</span>
                    <span class="s0">break</span>
        <span class="s0">return </span><span class="s1">msgs</span>
</pre>
</body>
</html>