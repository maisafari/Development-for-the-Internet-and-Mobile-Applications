<html>
<head>
<title>options.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
options.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">copy</span>
<span class="s0">import </span><span class="s1">enum</span>
<span class="s0">import </span><span class="s1">json</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">from </span><span class="s1">functools </span><span class="s0">import </span><span class="s1">partial</span><span class="s2">, </span><span class="s1">update_wrapper</span>
<span class="s0">from </span><span class="s1">urllib</span><span class="s2">.</span><span class="s1">parse </span><span class="s0">import </span><span class="s1">parse_qsl</span>
<span class="s0">from </span><span class="s1">urllib</span><span class="s2">.</span><span class="s1">parse </span><span class="s0">import </span><span class="s1">quote </span><span class="s0">as </span><span class="s1">urlquote</span>
<span class="s0">from </span><span class="s1">urllib</span><span class="s2">.</span><span class="s1">parse </span><span class="s0">import </span><span class="s1">urlparse</span>

<span class="s0">from </span><span class="s1">django </span><span class="s0">import </span><span class="s1">forms</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">conf </span><span class="s0">import </span><span class="s1">settings</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">contrib </span><span class="s0">import </span><span class="s1">messages</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">contrib</span><span class="s2">.</span><span class="s1">admin </span><span class="s0">import </span><span class="s1">helpers</span><span class="s2">, </span><span class="s1">widgets</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">contrib</span><span class="s2">.</span><span class="s1">admin</span><span class="s2">.</span><span class="s1">checks </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">BaseModelAdminChecks</span><span class="s2">,</span>
    <span class="s1">InlineModelAdminChecks</span><span class="s2">,</span>
    <span class="s1">ModelAdminChecks</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">contrib</span><span class="s2">.</span><span class="s1">admin</span><span class="s2">.</span><span class="s1">exceptions </span><span class="s0">import </span><span class="s1">DisallowedModelAdminToField</span><span class="s2">, </span><span class="s1">NotRegistered</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">contrib</span><span class="s2">.</span><span class="s1">admin</span><span class="s2">.</span><span class="s1">templatetags</span><span class="s2">.</span><span class="s1">admin_urls </span><span class="s0">import </span><span class="s1">add_preserved_filters</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">contrib</span><span class="s2">.</span><span class="s1">admin</span><span class="s2">.</span><span class="s1">utils </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">NestedObjects</span><span class="s2">,</span>
    <span class="s1">construct_change_message</span><span class="s2">,</span>
    <span class="s1">flatten_fieldsets</span><span class="s2">,</span>
    <span class="s1">get_deleted_objects</span><span class="s2">,</span>
    <span class="s1">lookup_spawns_duplicates</span><span class="s2">,</span>
    <span class="s1">model_format_dict</span><span class="s2">,</span>
    <span class="s1">model_ngettext</span><span class="s2">,</span>
    <span class="s1">quote</span><span class="s2">,</span>
    <span class="s1">unquote</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">contrib</span><span class="s2">.</span><span class="s1">admin</span><span class="s2">.</span><span class="s1">widgets </span><span class="s0">import </span><span class="s1">AutocompleteSelect</span><span class="s2">, </span><span class="s1">AutocompleteSelectMultiple</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">contrib</span><span class="s2">.</span><span class="s1">auth </span><span class="s0">import </span><span class="s1">get_permission_codename</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">exceptions </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">FieldDoesNotExist</span><span class="s2">,</span>
    <span class="s1">FieldError</span><span class="s2">,</span>
    <span class="s1">PermissionDenied</span><span class="s2">,</span>
    <span class="s1">ValidationError</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">paginator </span><span class="s0">import </span><span class="s1">Paginator</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">db </span><span class="s0">import </span><span class="s1">models</span><span class="s2">, </span><span class="s1">router</span><span class="s2">, </span><span class="s1">transaction</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">db</span><span class="s2">.</span><span class="s1">models</span><span class="s2">.</span><span class="s1">constants </span><span class="s0">import </span><span class="s1">LOOKUP_SEP</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">forms</span><span class="s2">.</span><span class="s1">formsets </span><span class="s0">import </span><span class="s1">DELETION_FIELD_NAME</span><span class="s2">, </span><span class="s1">all_valid</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">forms</span><span class="s2">.</span><span class="s1">models </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">BaseInlineFormSet</span><span class="s2">,</span>
    <span class="s1">inlineformset_factory</span><span class="s2">,</span>
    <span class="s1">modelform_defines_fields</span><span class="s2">,</span>
    <span class="s1">modelform_factory</span><span class="s2">,</span>
    <span class="s1">modelformset_factory</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">forms</span><span class="s2">.</span><span class="s1">widgets </span><span class="s0">import </span><span class="s1">CheckboxSelectMultiple</span><span class="s2">, </span><span class="s1">SelectMultiple</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">http </span><span class="s0">import </span><span class="s1">HttpResponseRedirect</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">http</span><span class="s2">.</span><span class="s1">response </span><span class="s0">import </span><span class="s1">HttpResponseBase</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">template</span><span class="s2">.</span><span class="s1">response </span><span class="s0">import </span><span class="s1">SimpleTemplateResponse</span><span class="s2">, </span><span class="s1">TemplateResponse</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">urls </span><span class="s0">import </span><span class="s1">reverse</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">decorators </span><span class="s0">import </span><span class="s1">method_decorator</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">html </span><span class="s0">import </span><span class="s1">format_html</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">http </span><span class="s0">import </span><span class="s1">urlencode</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">safestring </span><span class="s0">import </span><span class="s1">mark_safe</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">text </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">capfirst</span><span class="s2">,</span>
    <span class="s1">format_lazy</span><span class="s2">,</span>
    <span class="s1">get_text_list</span><span class="s2">,</span>
    <span class="s1">smart_split</span><span class="s2">,</span>
    <span class="s1">unescape_string_literal</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">translation </span><span class="s0">import </span><span class="s1">gettext </span><span class="s0">as </span><span class="s1">_</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">translation </span><span class="s0">import </span><span class="s1">ngettext</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">views</span><span class="s2">.</span><span class="s1">decorators</span><span class="s2">.</span><span class="s1">csrf </span><span class="s0">import </span><span class="s1">csrf_protect</span>
<span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">views</span><span class="s2">.</span><span class="s1">generic </span><span class="s0">import </span><span class="s1">RedirectView</span>

<span class="s1">IS_POPUP_VAR </span><span class="s2">= </span><span class="s3">&quot;_popup&quot;</span>
<span class="s1">TO_FIELD_VAR </span><span class="s2">= </span><span class="s3">&quot;_to_field&quot;</span>
<span class="s1">IS_FACETS_VAR </span><span class="s2">= </span><span class="s3">&quot;_facets&quot;</span>


<span class="s0">class </span><span class="s1">ShowFacets</span><span class="s2">(</span><span class="s1">enum</span><span class="s2">.</span><span class="s1">Enum</span><span class="s2">):</span>
    <span class="s1">NEVER </span><span class="s2">= </span><span class="s3">&quot;NEVER&quot;</span>
    <span class="s1">ALLOW </span><span class="s2">= </span><span class="s3">&quot;ALLOW&quot;</span>
    <span class="s1">ALWAYS </span><span class="s2">= </span><span class="s3">&quot;ALWAYS&quot;</span>


<span class="s1">HORIZONTAL</span><span class="s2">, </span><span class="s1">VERTICAL </span><span class="s2">= </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span>


<span class="s0">def </span><span class="s1">get_content_type_for_model</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">):</span>
    <span class="s5"># Since this module gets imported in the application's root package,</span>
    <span class="s5"># it cannot import models from other applications at the module level.</span>
    <span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">contrib</span><span class="s2">.</span><span class="s1">contenttypes</span><span class="s2">.</span><span class="s1">models </span><span class="s0">import </span><span class="s1">ContentType</span>

    <span class="s0">return </span><span class="s1">ContentType</span><span class="s2">.</span><span class="s1">objects</span><span class="s2">.</span><span class="s1">get_for_model</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">for_concrete_model</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">get_ul_class</span><span class="s2">(</span><span class="s1">radio_style</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s3">&quot;radiolist&quot; </span><span class="s0">if </span><span class="s1">radio_style </span><span class="s2">== </span><span class="s1">VERTICAL </span><span class="s0">else </span><span class="s3">&quot;radiolist inline&quot;</span>


<span class="s0">class </span><span class="s1">IncorrectLookupParameters</span><span class="s2">(</span><span class="s1">Exception</span><span class="s2">):</span>
    <span class="s0">pass</span>


<span class="s5"># Defaults for formfield_overrides. ModelAdmin subclasses can change this</span>
<span class="s5"># by adding to ModelAdmin.formfield_overrides.</span>

<span class="s1">FORMFIELD_FOR_DBFIELD_DEFAULTS </span><span class="s2">= {</span>
    <span class="s1">models</span><span class="s2">.</span><span class="s1">DateTimeField</span><span class="s2">: {</span>
        <span class="s3">&quot;form_class&quot;</span><span class="s2">: </span><span class="s1">forms</span><span class="s2">.</span><span class="s1">SplitDateTimeField</span><span class="s2">,</span>
        <span class="s3">&quot;widget&quot;</span><span class="s2">: </span><span class="s1">widgets</span><span class="s2">.</span><span class="s1">AdminSplitDateTime</span><span class="s2">,</span>
    <span class="s2">},</span>
    <span class="s1">models</span><span class="s2">.</span><span class="s1">DateField</span><span class="s2">: {</span><span class="s3">&quot;widget&quot;</span><span class="s2">: </span><span class="s1">widgets</span><span class="s2">.</span><span class="s1">AdminDateWidget</span><span class="s2">},</span>
    <span class="s1">models</span><span class="s2">.</span><span class="s1">TimeField</span><span class="s2">: {</span><span class="s3">&quot;widget&quot;</span><span class="s2">: </span><span class="s1">widgets</span><span class="s2">.</span><span class="s1">AdminTimeWidget</span><span class="s2">},</span>
    <span class="s1">models</span><span class="s2">.</span><span class="s1">TextField</span><span class="s2">: {</span><span class="s3">&quot;widget&quot;</span><span class="s2">: </span><span class="s1">widgets</span><span class="s2">.</span><span class="s1">AdminTextareaWidget</span><span class="s2">},</span>
    <span class="s1">models</span><span class="s2">.</span><span class="s1">URLField</span><span class="s2">: {</span><span class="s3">&quot;widget&quot;</span><span class="s2">: </span><span class="s1">widgets</span><span class="s2">.</span><span class="s1">AdminURLFieldWidget</span><span class="s2">},</span>
    <span class="s1">models</span><span class="s2">.</span><span class="s1">IntegerField</span><span class="s2">: {</span><span class="s3">&quot;widget&quot;</span><span class="s2">: </span><span class="s1">widgets</span><span class="s2">.</span><span class="s1">AdminIntegerFieldWidget</span><span class="s2">},</span>
    <span class="s1">models</span><span class="s2">.</span><span class="s1">BigIntegerField</span><span class="s2">: {</span><span class="s3">&quot;widget&quot;</span><span class="s2">: </span><span class="s1">widgets</span><span class="s2">.</span><span class="s1">AdminBigIntegerFieldWidget</span><span class="s2">},</span>
    <span class="s1">models</span><span class="s2">.</span><span class="s1">CharField</span><span class="s2">: {</span><span class="s3">&quot;widget&quot;</span><span class="s2">: </span><span class="s1">widgets</span><span class="s2">.</span><span class="s1">AdminTextInputWidget</span><span class="s2">},</span>
    <span class="s1">models</span><span class="s2">.</span><span class="s1">ImageField</span><span class="s2">: {</span><span class="s3">&quot;widget&quot;</span><span class="s2">: </span><span class="s1">widgets</span><span class="s2">.</span><span class="s1">AdminFileWidget</span><span class="s2">},</span>
    <span class="s1">models</span><span class="s2">.</span><span class="s1">FileField</span><span class="s2">: {</span><span class="s3">&quot;widget&quot;</span><span class="s2">: </span><span class="s1">widgets</span><span class="s2">.</span><span class="s1">AdminFileWidget</span><span class="s2">},</span>
    <span class="s1">models</span><span class="s2">.</span><span class="s1">EmailField</span><span class="s2">: {</span><span class="s3">&quot;widget&quot;</span><span class="s2">: </span><span class="s1">widgets</span><span class="s2">.</span><span class="s1">AdminEmailInputWidget</span><span class="s2">},</span>
    <span class="s1">models</span><span class="s2">.</span><span class="s1">UUIDField</span><span class="s2">: {</span><span class="s3">&quot;widget&quot;</span><span class="s2">: </span><span class="s1">widgets</span><span class="s2">.</span><span class="s1">AdminUUIDInputWidget</span><span class="s2">},</span>
<span class="s2">}</span>

<span class="s1">csrf_protect_m </span><span class="s2">= </span><span class="s1">method_decorator</span><span class="s2">(</span><span class="s1">csrf_protect</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">BaseModelAdmin</span><span class="s2">(</span><span class="s1">metaclass</span><span class="s2">=</span><span class="s1">forms</span><span class="s2">.</span><span class="s1">MediaDefiningClass</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Functionality common to both ModelAdmin and InlineAdmin.&quot;&quot;&quot;</span>

    <span class="s1">autocomplete_fields </span><span class="s2">= ()</span>
    <span class="s1">raw_id_fields </span><span class="s2">= ()</span>
    <span class="s1">fields </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">exclude </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">fieldsets </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">form </span><span class="s2">= </span><span class="s1">forms</span><span class="s2">.</span><span class="s1">ModelForm</span>
    <span class="s1">filter_vertical </span><span class="s2">= ()</span>
    <span class="s1">filter_horizontal </span><span class="s2">= ()</span>
    <span class="s1">radio_fields </span><span class="s2">= {}</span>
    <span class="s1">prepopulated_fields </span><span class="s2">= {}</span>
    <span class="s1">formfield_overrides </span><span class="s2">= {}</span>
    <span class="s1">readonly_fields </span><span class="s2">= ()</span>
    <span class="s1">ordering </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">sortable_by </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">view_on_site </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">show_full_result_count </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">checks_class </span><span class="s2">= </span><span class="s1">BaseModelAdminChecks</span>

    <span class="s0">def </span><span class="s1">check</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">checks_class</span><span class="s2">().</span><span class="s1">check</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Merge FORMFIELD_FOR_DBFIELD_DEFAULTS with the formfield_overrides</span>
        <span class="s5"># rather than simply overwriting.</span>
        <span class="s1">overrides </span><span class="s2">= </span><span class="s1">copy</span><span class="s2">.</span><span class="s1">deepcopy</span><span class="s2">(</span><span class="s1">FORMFIELD_FOR_DBFIELD_DEFAULTS</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">formfield_overrides</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">overrides</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, {}).</span><span class="s1">update</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">formfield_overrides </span><span class="s2">= </span><span class="s1">overrides</span>

    <span class="s0">def </span><span class="s1">formfield_for_dbfield</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">db_field</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Hook for specifying the form Field instance for a given database Field 
        instance. 
 
        If kwargs are given, they're passed to the form Field's constructor. 
        &quot;&quot;&quot;</span>
        <span class="s5"># If the field specifies choices, we don't need to look for special</span>
        <span class="s5"># admin widgets - we just need to use a select widget of some kind.</span>
        <span class="s0">if </span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">choices</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">formfield_for_choice_field</span><span class="s2">(</span><span class="s1">db_field</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s5"># ForeignKey or ManyToManyFields</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">db_field</span><span class="s2">, (</span><span class="s1">models</span><span class="s2">.</span><span class="s1">ForeignKey</span><span class="s2">, </span><span class="s1">models</span><span class="s2">.</span><span class="s1">ManyToManyField</span><span class="s2">)):</span>
            <span class="s5"># Combine the field kwargs with any options for formfield_overrides.</span>
            <span class="s5"># Make sure the passed in **kwargs override anything in</span>
            <span class="s5"># formfield_overrides because **kwargs is more specific, and should</span>
            <span class="s5"># always win.</span>
            <span class="s0">if </span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">__class__ </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">formfield_overrides</span><span class="s2">:</span>
                <span class="s1">kwargs </span><span class="s2">= {**</span><span class="s1">self</span><span class="s2">.</span><span class="s1">formfield_overrides</span><span class="s2">[</span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">], **</span><span class="s1">kwargs</span><span class="s2">}</span>

            <span class="s5"># Get the correct formfield.</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">db_field</span><span class="s2">, </span><span class="s1">models</span><span class="s2">.</span><span class="s1">ForeignKey</span><span class="s2">):</span>
                <span class="s1">formfield </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">formfield_for_foreignkey</span><span class="s2">(</span><span class="s1">db_field</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">db_field</span><span class="s2">, </span><span class="s1">models</span><span class="s2">.</span><span class="s1">ManyToManyField</span><span class="s2">):</span>
                <span class="s1">formfield </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">formfield_for_manytomany</span><span class="s2">(</span><span class="s1">db_field</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

            <span class="s5"># For non-raw_id fields, wrap the widget with a wrapper that adds</span>
            <span class="s5"># extra HTML -- the &quot;add other&quot; interface -- to the end of the</span>
            <span class="s5"># rendered output. formfield can be None if it came from a</span>
            <span class="s5"># OneToOneField with parent_link=True or a M2M intermediary.</span>
            <span class="s0">if </span><span class="s1">formfield </span><span class="s0">and </span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">name </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">raw_id_fields</span><span class="s2">:</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">related_modeladmin </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">get_model_admin</span><span class="s2">(</span>
                        <span class="s1">db_field</span><span class="s2">.</span><span class="s1">remote_field</span><span class="s2">.</span><span class="s1">model</span>
                    <span class="s2">)</span>
                <span class="s0">except </span><span class="s1">NotRegistered</span><span class="s2">:</span>
                    <span class="s1">wrapper_kwargs </span><span class="s2">= {}</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">wrapper_kwargs </span><span class="s2">= {</span>
                        <span class="s3">&quot;can_add_related&quot;</span><span class="s2">: </span><span class="s1">related_modeladmin</span><span class="s2">.</span><span class="s1">has_add_permission</span><span class="s2">(</span>
                            <span class="s1">request</span>
                        <span class="s2">),</span>
                        <span class="s3">&quot;can_change_related&quot;</span><span class="s2">: </span><span class="s1">related_modeladmin</span><span class="s2">.</span><span class="s1">has_change_permission</span><span class="s2">(</span>
                            <span class="s1">request</span>
                        <span class="s2">),</span>
                        <span class="s3">&quot;can_delete_related&quot;</span><span class="s2">: </span><span class="s1">related_modeladmin</span><span class="s2">.</span><span class="s1">has_delete_permission</span><span class="s2">(</span>
                            <span class="s1">request</span>
                        <span class="s2">),</span>
                        <span class="s3">&quot;can_view_related&quot;</span><span class="s2">: </span><span class="s1">related_modeladmin</span><span class="s2">.</span><span class="s1">has_view_permission</span><span class="s2">(</span>
                            <span class="s1">request</span>
                        <span class="s2">),</span>
                    <span class="s2">}</span>
                <span class="s1">formfield</span><span class="s2">.</span><span class="s1">widget </span><span class="s2">= </span><span class="s1">widgets</span><span class="s2">.</span><span class="s1">RelatedFieldWidgetWrapper</span><span class="s2">(</span>
                    <span class="s1">formfield</span><span class="s2">.</span><span class="s1">widget</span><span class="s2">,</span>
                    <span class="s1">db_field</span><span class="s2">.</span><span class="s1">remote_field</span><span class="s2">,</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">,</span>
                    <span class="s2">**</span><span class="s1">wrapper_kwargs</span><span class="s2">,</span>
                <span class="s2">)</span>

            <span class="s0">return </span><span class="s1">formfield</span>

        <span class="s5"># If we've got overrides for the formfield defined, use 'em. **kwargs</span>
        <span class="s5"># passed to formfield_for_dbfield override the defaults.</span>
        <span class="s0">for </span><span class="s1">klass </span><span class="s0">in </span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">mro</span><span class="s2">():</span>
            <span class="s0">if </span><span class="s1">klass </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">formfield_overrides</span><span class="s2">:</span>
                <span class="s1">kwargs </span><span class="s2">= {**</span><span class="s1">copy</span><span class="s2">.</span><span class="s1">deepcopy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">formfield_overrides</span><span class="s2">[</span><span class="s1">klass</span><span class="s2">]), **</span><span class="s1">kwargs</span><span class="s2">}</span>
                <span class="s0">return </span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">formfield</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s5"># For any other type of field, just call its formfield() method.</span>
        <span class="s0">return </span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">formfield</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">formfield_for_choice_field</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">db_field</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Get a form Field for a database Field that has declared choices. 
        &quot;&quot;&quot;</span>
        <span class="s5"># If the field is named as a radio_field, use a RadioSelect</span>
        <span class="s0">if </span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">radio_fields</span><span class="s2">:</span>
            <span class="s5"># Avoid stomping on custom widget/choices arguments.</span>
            <span class="s0">if </span><span class="s3">&quot;widget&quot; </span><span class="s0">not in </span><span class="s1">kwargs</span><span class="s2">:</span>
                <span class="s1">kwargs</span><span class="s2">[</span><span class="s3">&quot;widget&quot;</span><span class="s2">] = </span><span class="s1">widgets</span><span class="s2">.</span><span class="s1">AdminRadioSelect</span><span class="s2">(</span>
                    <span class="s1">attrs</span><span class="s2">={</span>
                        <span class="s3">&quot;class&quot;</span><span class="s2">: </span><span class="s1">get_ul_class</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">radio_fields</span><span class="s2">[</span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">]),</span>
                    <span class="s2">}</span>
                <span class="s2">)</span>
            <span class="s0">if </span><span class="s3">&quot;choices&quot; </span><span class="s0">not in </span><span class="s1">kwargs</span><span class="s2">:</span>
                <span class="s1">kwargs</span><span class="s2">[</span><span class="s3">&quot;choices&quot;</span><span class="s2">] = </span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">get_choices</span><span class="s2">(</span>
                    <span class="s1">include_blank</span><span class="s2">=</span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">blank</span><span class="s2">, </span><span class="s1">blank_choice</span><span class="s2">=[(</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">_</span><span class="s2">(</span><span class="s3">&quot;None&quot;</span><span class="s2">))]</span>
                <span class="s2">)</span>
        <span class="s0">return </span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">formfield</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_field_queryset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">db</span><span class="s2">, </span><span class="s1">db_field</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        If the ModelAdmin specifies ordering, the queryset should respect that 
        ordering.  Otherwise don't specify the queryset, let the field decide 
        (return None in that case). 
        &quot;&quot;&quot;</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">related_admin </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">get_model_admin</span><span class="s2">(</span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">remote_field</span><span class="s2">.</span><span class="s1">model</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">NotRegistered</span><span class="s2">:</span>
            <span class="s0">return None</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">ordering </span><span class="s2">= </span><span class="s1">related_admin</span><span class="s2">.</span><span class="s1">get_ordering</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">ordering </span><span class="s0">is not None and </span><span class="s1">ordering </span><span class="s2">!= ():</span>
                <span class="s0">return </span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">remote_field</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_default_manager</span><span class="s2">.</span><span class="s1">using</span><span class="s2">(</span><span class="s1">db</span><span class="s2">).</span><span class="s1">order_by</span><span class="s2">(</span>
                    <span class="s2">*</span><span class="s1">ordering</span>
                <span class="s2">)</span>
        <span class="s0">return None</span>

    <span class="s0">def </span><span class="s1">formfield_for_foreignkey</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">db_field</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Get a form Field for a ForeignKey. 
        &quot;&quot;&quot;</span>
        <span class="s1">db </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;using&quot;</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s3">&quot;widget&quot; </span><span class="s0">not in </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_autocomplete_fields</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
                <span class="s1">kwargs</span><span class="s2">[</span><span class="s3">&quot;widget&quot;</span><span class="s2">] = </span><span class="s1">AutocompleteSelect</span><span class="s2">(</span>
                    <span class="s1">db_field</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">, </span><span class="s1">using</span><span class="s2">=</span><span class="s1">db</span>
                <span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">raw_id_fields</span><span class="s2">:</span>
                <span class="s1">kwargs</span><span class="s2">[</span><span class="s3">&quot;widget&quot;</span><span class="s2">] = </span><span class="s1">widgets</span><span class="s2">.</span><span class="s1">ForeignKeyRawIdWidget</span><span class="s2">(</span>
                    <span class="s1">db_field</span><span class="s2">.</span><span class="s1">remote_field</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">, </span><span class="s1">using</span><span class="s2">=</span><span class="s1">db</span>
                <span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">radio_fields</span><span class="s2">:</span>
                <span class="s1">kwargs</span><span class="s2">[</span><span class="s3">&quot;widget&quot;</span><span class="s2">] = </span><span class="s1">widgets</span><span class="s2">.</span><span class="s1">AdminRadioSelect</span><span class="s2">(</span>
                    <span class="s1">attrs</span><span class="s2">={</span>
                        <span class="s3">&quot;class&quot;</span><span class="s2">: </span><span class="s1">get_ul_class</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">radio_fields</span><span class="s2">[</span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">]),</span>
                    <span class="s2">}</span>
                <span class="s2">)</span>
                <span class="s1">kwargs</span><span class="s2">[</span><span class="s3">&quot;empty_label&quot;</span><span class="s2">] = (</span>
                    <span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;empty_label&quot;</span><span class="s2">, </span><span class="s1">_</span><span class="s2">(</span><span class="s3">&quot;None&quot;</span><span class="s2">)) </span><span class="s0">if </span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">blank </span><span class="s0">else None</span>
                <span class="s2">)</span>

        <span class="s0">if </span><span class="s3">&quot;queryset&quot; </span><span class="s0">not in </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s1">queryset </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_field_queryset</span><span class="s2">(</span><span class="s1">db</span><span class="s2">, </span><span class="s1">db_field</span><span class="s2">, </span><span class="s1">request</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">queryset </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">kwargs</span><span class="s2">[</span><span class="s3">&quot;queryset&quot;</span><span class="s2">] = </span><span class="s1">queryset</span>

        <span class="s0">return </span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">formfield</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">formfield_for_manytomany</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">db_field</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Get a form Field for a ManyToManyField. 
        &quot;&quot;&quot;</span>
        <span class="s5"># If it uses an intermediary model that isn't auto created, don't show</span>
        <span class="s5"># a field in admin.</span>
        <span class="s0">if not </span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">remote_field</span><span class="s2">.</span><span class="s1">through</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">auto_created</span><span class="s2">:</span>
            <span class="s0">return None</span>
        <span class="s1">db </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;using&quot;</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s3">&quot;widget&quot; </span><span class="s0">not in </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s1">autocomplete_fields </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_autocomplete_fields</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">autocomplete_fields</span><span class="s2">:</span>
                <span class="s1">kwargs</span><span class="s2">[</span><span class="s3">&quot;widget&quot;</span><span class="s2">] = </span><span class="s1">AutocompleteSelectMultiple</span><span class="s2">(</span>
                    <span class="s1">db_field</span><span class="s2">,</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">,</span>
                    <span class="s1">using</span><span class="s2">=</span><span class="s1">db</span><span class="s2">,</span>
                <span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">raw_id_fields</span><span class="s2">:</span>
                <span class="s1">kwargs</span><span class="s2">[</span><span class="s3">&quot;widget&quot;</span><span class="s2">] = </span><span class="s1">widgets</span><span class="s2">.</span><span class="s1">ManyToManyRawIdWidget</span><span class="s2">(</span>
                    <span class="s1">db_field</span><span class="s2">.</span><span class="s1">remote_field</span><span class="s2">,</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">,</span>
                    <span class="s1">using</span><span class="s2">=</span><span class="s1">db</span><span class="s2">,</span>
                <span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s2">[*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">filter_vertical</span><span class="s2">, *</span><span class="s1">self</span><span class="s2">.</span><span class="s1">filter_horizontal</span><span class="s2">]:</span>
                <span class="s1">kwargs</span><span class="s2">[</span><span class="s3">&quot;widget&quot;</span><span class="s2">] = </span><span class="s1">widgets</span><span class="s2">.</span><span class="s1">FilteredSelectMultiple</span><span class="s2">(</span>
                    <span class="s1">db_field</span><span class="s2">.</span><span class="s1">verbose_name</span><span class="s2">, </span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filter_vertical</span>
                <span class="s2">)</span>
        <span class="s0">if </span><span class="s3">&quot;queryset&quot; </span><span class="s0">not in </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s1">queryset </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_field_queryset</span><span class="s2">(</span><span class="s1">db</span><span class="s2">, </span><span class="s1">db_field</span><span class="s2">, </span><span class="s1">request</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">queryset </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">kwargs</span><span class="s2">[</span><span class="s3">&quot;queryset&quot;</span><span class="s2">] = </span><span class="s1">queryset</span>

        <span class="s1">form_field </span><span class="s2">= </span><span class="s1">db_field</span><span class="s2">.</span><span class="s1">formfield</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s2">(</span>
            <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">form_field</span><span class="s2">.</span><span class="s1">widget</span><span class="s2">, </span><span class="s1">SelectMultiple</span><span class="s2">)</span>
            <span class="s0">and </span><span class="s1">form_field</span><span class="s2">.</span><span class="s1">widget</span><span class="s2">.</span><span class="s1">allow_multiple_selected</span>
            <span class="s0">and not </span><span class="s1">isinstance</span><span class="s2">(</span>
                <span class="s1">form_field</span><span class="s2">.</span><span class="s1">widget</span><span class="s2">, (</span><span class="s1">CheckboxSelectMultiple</span><span class="s2">, </span><span class="s1">AutocompleteSelectMultiple</span><span class="s2">)</span>
            <span class="s2">)</span>
        <span class="s2">):</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s1">_</span><span class="s2">(</span>
                <span class="s3">&quot;Hold down “Control”, or “Command” on a Mac, to select more than one.&quot;</span>
            <span class="s2">)</span>
            <span class="s1">help_text </span><span class="s2">= </span><span class="s1">form_field</span><span class="s2">.</span><span class="s1">help_text</span>
            <span class="s1">form_field</span><span class="s2">.</span><span class="s1">help_text </span><span class="s2">= (</span>
                <span class="s1">format_lazy</span><span class="s2">(</span><span class="s3">&quot;{} {}&quot;</span><span class="s2">, </span><span class="s1">help_text</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">) </span><span class="s0">if </span><span class="s1">help_text </span><span class="s0">else </span><span class="s1">msg</span>
            <span class="s2">)</span>
        <span class="s0">return </span><span class="s1">form_field</span>

    <span class="s0">def </span><span class="s1">get_autocomplete_fields</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return a list of ForeignKey and/or ManyToMany fields which should use 
        an autocomplete widget. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">autocomplete_fields</span>

    <span class="s0">def </span><span class="s1">get_view_on_site_url</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">obj </span><span class="s0">is None or not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">view_on_site</span><span class="s2">:</span>
            <span class="s0">return None</span>

        <span class="s0">if </span><span class="s1">callable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">view_on_site</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">view_on_site</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s3">&quot;get_absolute_url&quot;</span><span class="s2">):</span>
            <span class="s5"># use the ContentType lookup if view_on_site is True</span>
            <span class="s0">return </span><span class="s1">reverse</span><span class="s2">(</span>
                <span class="s3">&quot;admin:view_on_site&quot;</span><span class="s2">,</span>
                <span class="s1">kwargs</span><span class="s2">={</span>
                    <span class="s3">&quot;content_type_id&quot;</span><span class="s2">: </span><span class="s1">get_content_type_for_model</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">).</span><span class="s1">pk</span><span class="s2">,</span>
                    <span class="s3">&quot;object_id&quot;</span><span class="s2">: </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">pk</span><span class="s2">,</span>
                <span class="s2">},</span>
                <span class="s1">current_app</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">name</span><span class="s2">,</span>
            <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_empty_value_display</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return the empty_value_display set on ModelAdmin or AdminSite. 
        &quot;&quot;&quot;</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">mark_safe</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">empty_value_display</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">mark_safe</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">empty_value_display</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_exclude</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Hook for specifying exclude. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exclude</span>

    <span class="s0">def </span><span class="s1">get_fields</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Hook for specifying fields. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fields</span>
        <span class="s5"># _get_form_for_get_fields() is implemented in subclasses.</span>
        <span class="s1">form </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_form_for_get_fields</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">[*</span><span class="s1">form</span><span class="s2">.</span><span class="s1">base_fields</span><span class="s2">, *</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_readonly_fields</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)]</span>

    <span class="s0">def </span><span class="s1">get_fieldsets</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Hook for specifying fieldsets. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fieldsets</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fieldsets</span>
        <span class="s0">return </span><span class="s2">[(</span><span class="s0">None</span><span class="s2">, {</span><span class="s3">&quot;fields&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_fields</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)})]</span>

    <span class="s0">def </span><span class="s1">get_inlines</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Hook for specifying custom inlines.&quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">inlines</span>

    <span class="s0">def </span><span class="s1">get_ordering</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Hook for specifying field ordering. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ordering </span><span class="s0">or </span><span class="s2">()  </span><span class="s5"># otherwise we might try to *None, which is bad ;)</span>

    <span class="s0">def </span><span class="s1">get_readonly_fields</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Hook for specifying custom readonly fields. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">readonly_fields</span>

    <span class="s0">def </span><span class="s1">get_prepopulated_fields</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Hook for specifying custom prepopulated fields. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">prepopulated_fields</span>

    <span class="s0">def </span><span class="s1">get_queryset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return a QuerySet of all model instances that can be edited by the 
        admin site. This is used by changelist_view. 
        &quot;&quot;&quot;</span>
        <span class="s1">qs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_default_manager</span><span class="s2">.</span><span class="s1">get_queryset</span><span class="s2">()</span>
        <span class="s5"># TODO: this should be handled by some parameter to the ChangeList.</span>
        <span class="s1">ordering </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_ordering</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">ordering</span><span class="s2">:</span>
            <span class="s1">qs </span><span class="s2">= </span><span class="s1">qs</span><span class="s2">.</span><span class="s1">order_by</span><span class="s2">(*</span><span class="s1">ordering</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">qs</span>

    <span class="s0">def </span><span class="s1">get_sortable_by</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Hook for specifying which fields can be sorted in the changelist.&quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sortable_by</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sortable_by </span><span class="s0">is not None</span>
            <span class="s0">else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_list_display</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s5"># RemovedInDjango60Warning: when the deprecation ends, replace with:</span>
    <span class="s5"># def lookup_allowed(self, lookup, value, request):</span>
    <span class="s0">def </span><span class="s1">lookup_allowed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lookup</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">request</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">contrib</span><span class="s2">.</span><span class="s1">admin</span><span class="s2">.</span><span class="s1">filters </span><span class="s0">import </span><span class="s1">SimpleListFilter</span>

        <span class="s1">model </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span>
        <span class="s5"># Check FKey lookups that are allowed, so that popups produced by</span>
        <span class="s5"># ForeignKeyRawIdWidget, on the basis of ForeignKey.limit_choices_to,</span>
        <span class="s5"># are allowed to work.</span>
        <span class="s0">for </span><span class="s1">fk_lookup </span><span class="s0">in </span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">related_fkey_lookups</span><span class="s2">:</span>
            <span class="s5"># As ``limit_choices_to`` can be a callable, invoke it here.</span>
            <span class="s0">if </span><span class="s1">callable</span><span class="s2">(</span><span class="s1">fk_lookup</span><span class="s2">):</span>
                <span class="s1">fk_lookup </span><span class="s2">= </span><span class="s1">fk_lookup</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">lookup</span><span class="s2">, </span><span class="s1">value</span><span class="s2">) </span><span class="s0">in </span><span class="s1">widgets</span><span class="s2">.</span><span class="s1">url_params_from_lookup_dict</span><span class="s2">(</span>
                <span class="s1">fk_lookup</span>
            <span class="s2">).</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s0">return True</span>

        <span class="s1">relation_parts </span><span class="s2">= []</span>
        <span class="s1">prev_field </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">parts </span><span class="s2">= </span><span class="s1">lookup</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s1">LOOKUP_SEP</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">part </span><span class="s0">in </span><span class="s1">parts</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">field </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">get_field</span><span class="s2">(</span><span class="s1">part</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">FieldDoesNotExist</span><span class="s2">:</span>
                <span class="s5"># Lookups on nonexistent fields are ok, since they're ignored</span>
                <span class="s5"># later.</span>
                <span class="s0">break</span>
            <span class="s0">if not </span><span class="s1">prev_field </span><span class="s0">or </span><span class="s2">(</span>
                <span class="s1">prev_field</span><span class="s2">.</span><span class="s1">is_relation</span>
                <span class="s0">and </span><span class="s1">field </span><span class="s0">not in </span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">parents</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()</span>
                <span class="s0">and </span><span class="s1">field </span><span class="s0">is not </span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">auto_field</span>
                <span class="s0">and </span><span class="s2">(</span>
                    <span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">auto_field </span><span class="s0">is None</span>
                    <span class="s0">or </span><span class="s1">part </span><span class="s0">not in </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">prev_field</span><span class="s2">, </span><span class="s3">&quot;to_fields&quot;</span><span class="s2">, [])</span>
                <span class="s2">)</span>
                <span class="s0">and </span><span class="s2">(</span><span class="s1">field</span><span class="s2">.</span><span class="s1">is_relation </span><span class="s0">or not </span><span class="s1">field</span><span class="s2">.</span><span class="s1">primary_key</span><span class="s2">)</span>
            <span class="s2">):</span>
                <span class="s1">relation_parts</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">part</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s3">&quot;path_infos&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">):</span>
                <span class="s5"># This is not a relational field, so further parts</span>
                <span class="s5"># must be transforms.</span>
                <span class="s0">break</span>
            <span class="s1">prev_field </span><span class="s2">= </span><span class="s1">field</span>
            <span class="s1">model </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">path_infos</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">].</span><span class="s1">to_opts</span><span class="s2">.</span><span class="s1">model</span>

        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">relation_parts</span><span class="s2">) &lt;= </span><span class="s4">1</span><span class="s2">:</span>
            <span class="s5"># Either a local field filter, or no fields at all.</span>
            <span class="s0">return True</span>
        <span class="s1">valid_lookups </span><span class="s2">= {</span><span class="s1">self</span><span class="s2">.</span><span class="s1">date_hierarchy</span><span class="s2">}</span>
        <span class="s5"># RemovedInDjango60Warning: when the deprecation ends, replace with:</span>
        <span class="s5"># for filter_item in self.get_list_filter(request):</span>
        <span class="s1">list_filter </span><span class="s2">= (</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">get_list_filter</span><span class="s2">(</span><span class="s1">request</span><span class="s2">) </span><span class="s0">if </span><span class="s1">request </span><span class="s0">is not None else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">list_filter</span>
        <span class="s2">)</span>
        <span class="s0">for </span><span class="s1">filter_item </span><span class="s0">in </span><span class="s1">list_filter</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">filter_item</span><span class="s2">, </span><span class="s1">type</span><span class="s2">) </span><span class="s0">and </span><span class="s1">issubclass</span><span class="s2">(</span>
                <span class="s1">filter_item</span><span class="s2">, </span><span class="s1">SimpleListFilter</span>
            <span class="s2">):</span>
                <span class="s1">valid_lookups</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">filter_item</span><span class="s2">.</span><span class="s1">parameter_name</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">filter_item</span><span class="s2">, (</span><span class="s1">list</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">)):</span>
                <span class="s1">valid_lookups</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">filter_item</span><span class="s2">[</span><span class="s4">0</span><span class="s2">])</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">valid_lookups</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">filter_item</span><span class="s2">)</span>

        <span class="s5"># Is it a valid relational lookup?</span>
        <span class="s0">return not </span><span class="s2">{</span>
            <span class="s1">LOOKUP_SEP</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">relation_parts</span><span class="s2">),</span>
            <span class="s1">LOOKUP_SEP</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">relation_parts </span><span class="s2">+ [</span><span class="s1">part</span><span class="s2">]),</span>
        <span class="s2">}.</span><span class="s1">isdisjoint</span><span class="s2">(</span><span class="s1">valid_lookups</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">to_field_allowed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">to_field</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return True if the model associated with this admin should be 
        allowed to be referenced by the specified field. 
        &quot;&quot;&quot;</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">field </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">get_field</span><span class="s2">(</span><span class="s1">to_field</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">FieldDoesNotExist</span><span class="s2">:</span>
            <span class="s0">return False</span>

        <span class="s5"># Always allow referencing the primary key since it's already possible</span>
        <span class="s5"># to get this information from the change view URL.</span>
        <span class="s0">if </span><span class="s1">field</span><span class="s2">.</span><span class="s1">primary_key</span><span class="s2">:</span>
            <span class="s0">return True</span>

        <span class="s5"># Allow reverse relationships to models defining m2m fields if they</span>
        <span class="s5"># target the specified field.</span>
        <span class="s0">for </span><span class="s1">many_to_many </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">many_to_many</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">many_to_many</span><span class="s2">.</span><span class="s1">m2m_target_field_name</span><span class="s2">() == </span><span class="s1">to_field</span><span class="s2">:</span>
                <span class="s0">return True</span>

        <span class="s5"># Make sure at least one of the models registered for this site</span>
        <span class="s5"># references this field through a FK or a M2M relationship.</span>
        <span class="s1">registered_models </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">model</span><span class="s2">, </span><span class="s1">admin </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">_registry</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">registered_models</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">model</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">inline </span><span class="s0">in </span><span class="s1">admin</span><span class="s2">.</span><span class="s1">inlines</span><span class="s2">:</span>
                <span class="s1">registered_models</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">inline</span><span class="s2">.</span><span class="s1">model</span><span class="s2">)</span>

        <span class="s1">related_objects </span><span class="s2">= (</span>
            <span class="s1">f</span>
            <span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">get_fields</span><span class="s2">(</span><span class="s1">include_hidden</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">auto_created </span><span class="s0">and not </span><span class="s1">f</span><span class="s2">.</span><span class="s1">concrete</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s0">for </span><span class="s1">related_object </span><span class="s0">in </span><span class="s1">related_objects</span><span class="s2">:</span>
            <span class="s1">related_model </span><span class="s2">= </span><span class="s1">related_object</span><span class="s2">.</span><span class="s1">related_model</span>
            <span class="s1">remote_field </span><span class="s2">= </span><span class="s1">related_object</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">remote_field</span>
            <span class="s0">if </span><span class="s2">(</span>
                <span class="s1">any</span><span class="s2">(</span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">model</span><span class="s2">, </span><span class="s1">related_model</span><span class="s2">) </span><span class="s0">for </span><span class="s1">model </span><span class="s0">in </span><span class="s1">registered_models</span><span class="s2">)</span>
                <span class="s0">and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">remote_field</span><span class="s2">, </span><span class="s3">&quot;get_related_field&quot;</span><span class="s2">)</span>
                <span class="s0">and </span><span class="s1">remote_field</span><span class="s2">.</span><span class="s1">get_related_field</span><span class="s2">() == </span><span class="s1">field</span>
            <span class="s2">):</span>
                <span class="s0">return True</span>

        <span class="s0">return False</span>

    <span class="s0">def </span><span class="s1">has_add_permission</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return True if the given request has permission to add an object. 
        Can be overridden by the user in subclasses. 
        &quot;&quot;&quot;</span>
        <span class="s1">opts </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span>
        <span class="s1">codename </span><span class="s2">= </span><span class="s1">get_permission_codename</span><span class="s2">(</span><span class="s3">&quot;add&quot;</span><span class="s2">, </span><span class="s1">opts</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">request</span><span class="s2">.</span><span class="s1">user</span><span class="s2">.</span><span class="s1">has_perm</span><span class="s2">(</span><span class="s3">&quot;%s.%s&quot; </span><span class="s2">% (</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span><span class="s2">, </span><span class="s1">codename</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">has_change_permission</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return True if the given request has permission to change the given 
        Django model instance, the default implementation doesn't examine the 
        `obj` parameter. 
 
        Can be overridden by the user in subclasses. In such case it should 
        return True if the given request has permission to change the `obj` 
        model instance. If `obj` is None, this should return True if the given 
        request has permission to change *any* object of the given type. 
        &quot;&quot;&quot;</span>
        <span class="s1">opts </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span>
        <span class="s1">codename </span><span class="s2">= </span><span class="s1">get_permission_codename</span><span class="s2">(</span><span class="s3">&quot;change&quot;</span><span class="s2">, </span><span class="s1">opts</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">request</span><span class="s2">.</span><span class="s1">user</span><span class="s2">.</span><span class="s1">has_perm</span><span class="s2">(</span><span class="s3">&quot;%s.%s&quot; </span><span class="s2">% (</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span><span class="s2">, </span><span class="s1">codename</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">has_delete_permission</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return True if the given request has permission to delete the given 
        Django model instance, the default implementation doesn't examine the 
        `obj` parameter. 
 
        Can be overridden by the user in subclasses. In such case it should 
        return True if the given request has permission to delete the `obj` 
        model instance. If `obj` is None, this should return True if the given 
        request has permission to delete *any* object of the given type. 
        &quot;&quot;&quot;</span>
        <span class="s1">opts </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span>
        <span class="s1">codename </span><span class="s2">= </span><span class="s1">get_permission_codename</span><span class="s2">(</span><span class="s3">&quot;delete&quot;</span><span class="s2">, </span><span class="s1">opts</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">request</span><span class="s2">.</span><span class="s1">user</span><span class="s2">.</span><span class="s1">has_perm</span><span class="s2">(</span><span class="s3">&quot;%s.%s&quot; </span><span class="s2">% (</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span><span class="s2">, </span><span class="s1">codename</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">has_view_permission</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return True if the given request has permission to view the given 
        Django model instance. The default implementation doesn't examine the 
        `obj` parameter. 
 
        If overridden by the user in subclasses, it should return True if the 
        given request has permission to view the `obj` model instance. If `obj` 
        is None, it should return True if the request has permission to view 
        any object of the given type. 
        &quot;&quot;&quot;</span>
        <span class="s1">opts </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span>
        <span class="s1">codename_view </span><span class="s2">= </span><span class="s1">get_permission_codename</span><span class="s2">(</span><span class="s3">&quot;view&quot;</span><span class="s2">, </span><span class="s1">opts</span><span class="s2">)</span>
        <span class="s1">codename_change </span><span class="s2">= </span><span class="s1">get_permission_codename</span><span class="s2">(</span><span class="s3">&quot;change&quot;</span><span class="s2">, </span><span class="s1">opts</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">request</span><span class="s2">.</span><span class="s1">user</span><span class="s2">.</span><span class="s1">has_perm</span><span class="s2">(</span>
            <span class="s3">&quot;%s.%s&quot; </span><span class="s2">% (</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span><span class="s2">, </span><span class="s1">codename_view</span><span class="s2">)</span>
        <span class="s2">) </span><span class="s0">or </span><span class="s1">request</span><span class="s2">.</span><span class="s1">user</span><span class="s2">.</span><span class="s1">has_perm</span><span class="s2">(</span><span class="s3">&quot;%s.%s&quot; </span><span class="s2">% (</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span><span class="s2">, </span><span class="s1">codename_change</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">has_view_or_change_permission</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_view_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">) </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_change_permission</span><span class="s2">(</span>
            <span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">has_module_permission</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return True if the given request has any permission in the given 
        app label. 
 
        Can be overridden by the user in subclasses. In such case it should 
        return True if the given request has permission to view the module on 
        the admin index page and access the module's index page. Overriding it 
        does not restrict access to the add, change or delete views. Use 
        `ModelAdmin.has_(add|change|delete)_permission` for that. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">request</span><span class="s2">.</span><span class="s1">user</span><span class="s2">.</span><span class="s1">has_module_perms</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">ModelAdmin</span><span class="s2">(</span><span class="s1">BaseModelAdmin</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Encapsulate all admin options and functionality for a given model.&quot;&quot;&quot;</span>

    <span class="s1">list_display </span><span class="s2">= (</span><span class="s3">&quot;__str__&quot;</span><span class="s2">,)</span>
    <span class="s1">list_display_links </span><span class="s2">= ()</span>
    <span class="s1">list_filter </span><span class="s2">= ()</span>
    <span class="s1">list_select_related </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">list_per_page </span><span class="s2">= </span><span class="s4">100</span>
    <span class="s1">list_max_show_all </span><span class="s2">= </span><span class="s4">200</span>
    <span class="s1">list_editable </span><span class="s2">= ()</span>
    <span class="s1">search_fields </span><span class="s2">= ()</span>
    <span class="s1">search_help_text </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">date_hierarchy </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">save_as </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">save_as_continue </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">save_on_top </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">paginator </span><span class="s2">= </span><span class="s1">Paginator</span>
    <span class="s1">preserve_filters </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">show_facets </span><span class="s2">= </span><span class="s1">ShowFacets</span><span class="s2">.</span><span class="s1">ALLOW</span>
    <span class="s1">inlines </span><span class="s2">= ()</span>

    <span class="s5"># Custom templates (designed to be over-ridden in subclasses)</span>
    <span class="s1">add_form_template </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">change_form_template </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">change_list_template </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">delete_confirmation_template </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">delete_selected_confirmation_template </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">object_history_template </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">popup_response_template </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s5"># Actions</span>
    <span class="s1">actions </span><span class="s2">= ()</span>
    <span class="s1">action_form </span><span class="s2">= </span><span class="s1">helpers</span><span class="s2">.</span><span class="s1">ActionForm</span>
    <span class="s1">actions_on_top </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">actions_on_bottom </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">actions_selection_counter </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">checks_class </span><span class="s2">= </span><span class="s1">ModelAdminChecks</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">admin_site</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s1">model</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">opts </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site </span><span class="s2">= </span><span class="s1">admin_site</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s3">&quot;%s.%s&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">(</span>
            <span class="s3">f&quot;&lt;</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__qualname__</span><span class="s0">}</span><span class="s3">: model=</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">__qualname__</span><span class="s0">} </span><span class="s3">&quot;</span>
            <span class="s3">f&quot;site=</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s0">!r}</span><span class="s3">&gt;&quot;</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_inline_instances</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">inline_instances </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">inline_class </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_inlines</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
            <span class="s1">inline </span><span class="s2">= </span><span class="s1">inline_class</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">request</span><span class="s2">:</span>
                <span class="s0">if not </span><span class="s2">(</span>
                    <span class="s1">inline</span><span class="s2">.</span><span class="s1">has_view_or_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>
                    <span class="s0">or </span><span class="s1">inline</span><span class="s2">.</span><span class="s1">has_add_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>
                    <span class="s0">or </span><span class="s1">inline</span><span class="s2">.</span><span class="s1">has_delete_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>
                <span class="s2">):</span>
                    <span class="s0">continue</span>
                <span class="s0">if not </span><span class="s1">inline</span><span class="s2">.</span><span class="s1">has_add_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
                    <span class="s1">inline</span><span class="s2">.</span><span class="s1">max_num </span><span class="s2">= </span><span class="s4">0</span>
            <span class="s1">inline_instances</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">inline</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">inline_instances</span>

    <span class="s0">def </span><span class="s1">get_urls</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">urls </span><span class="s0">import </span><span class="s1">path</span>

        <span class="s0">def </span><span class="s1">wrap</span><span class="s2">(</span><span class="s1">view</span><span class="s2">):</span>
            <span class="s0">def </span><span class="s1">wrapper</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">admin_view</span><span class="s2">(</span><span class="s1">view</span><span class="s2">)(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

            <span class="s1">wrapper</span><span class="s2">.</span><span class="s1">model_admin </span><span class="s2">= </span><span class="s1">self</span>
            <span class="s0">return </span><span class="s1">update_wrapper</span><span class="s2">(</span><span class="s1">wrapper</span><span class="s2">, </span><span class="s1">view</span><span class="s2">)</span>

        <span class="s1">info </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">model_name</span>

        <span class="s0">return </span><span class="s2">[</span>
            <span class="s1">path</span><span class="s2">(</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">wrap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">changelist_view</span><span class="s2">), </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;%s_%s_changelist&quot; </span><span class="s2">% </span><span class="s1">info</span><span class="s2">),</span>
            <span class="s1">path</span><span class="s2">(</span><span class="s3">&quot;add/&quot;</span><span class="s2">, </span><span class="s1">wrap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">add_view</span><span class="s2">), </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;%s_%s_add&quot; </span><span class="s2">% </span><span class="s1">info</span><span class="s2">),</span>
            <span class="s1">path</span><span class="s2">(</span>
                <span class="s3">&quot;&lt;path:object_id&gt;/history/&quot;</span><span class="s2">,</span>
                <span class="s1">wrap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">history_view</span><span class="s2">),</span>
                <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;%s_%s_history&quot; </span><span class="s2">% </span><span class="s1">info</span><span class="s2">,</span>
            <span class="s2">),</span>
            <span class="s1">path</span><span class="s2">(</span>
                <span class="s3">&quot;&lt;path:object_id&gt;/delete/&quot;</span><span class="s2">,</span>
                <span class="s1">wrap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">delete_view</span><span class="s2">),</span>
                <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;%s_%s_delete&quot; </span><span class="s2">% </span><span class="s1">info</span><span class="s2">,</span>
            <span class="s2">),</span>
            <span class="s1">path</span><span class="s2">(</span>
                <span class="s3">&quot;&lt;path:object_id&gt;/change/&quot;</span><span class="s2">,</span>
                <span class="s1">wrap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">change_view</span><span class="s2">),</span>
                <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;%s_%s_change&quot; </span><span class="s2">% </span><span class="s1">info</span><span class="s2">,</span>
            <span class="s2">),</span>
            <span class="s5"># For backwards compatibility (was the change url before 1.9)</span>
            <span class="s1">path</span><span class="s2">(</span>
                <span class="s3">&quot;&lt;path:object_id&gt;/&quot;</span><span class="s2">,</span>
                <span class="s1">wrap</span><span class="s2">(</span>
                    <span class="s1">RedirectView</span><span class="s2">.</span><span class="s1">as_view</span><span class="s2">(</span>
                        <span class="s1">pattern_name</span><span class="s2">=</span><span class="s3">&quot;%s:%s_%s_change&quot;</span>
                        <span class="s2">% ((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">name</span><span class="s2">,) + </span><span class="s1">info</span><span class="s2">)</span>
                    <span class="s2">)</span>
                <span class="s2">),</span>
            <span class="s2">),</span>
        <span class="s2">]</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">urls</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_urls</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">media</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">extra </span><span class="s2">= </span><span class="s3">&quot;&quot; </span><span class="s0">if </span><span class="s1">settings</span><span class="s2">.</span><span class="s1">DEBUG </span><span class="s0">else </span><span class="s3">&quot;.min&quot;</span>
        <span class="s1">js </span><span class="s2">= [</span>
            <span class="s3">&quot;vendor/jquery/jquery%s.js&quot; </span><span class="s2">% </span><span class="s1">extra</span><span class="s2">,</span>
            <span class="s3">&quot;jquery.init.js&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;core.js&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;admin/RelatedObjectLookups.js&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;actions.js&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;urlify.js&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;prepopulate.js&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;vendor/xregexp/xregexp%s.js&quot; </span><span class="s2">% </span><span class="s1">extra</span><span class="s2">,</span>
        <span class="s2">]</span>
        <span class="s0">return </span><span class="s1">forms</span><span class="s2">.</span><span class="s1">Media</span><span class="s2">(</span><span class="s1">js</span><span class="s2">=[</span><span class="s3">&quot;admin/js/%s&quot; </span><span class="s2">% </span><span class="s1">url </span><span class="s0">for </span><span class="s1">url </span><span class="s0">in </span><span class="s1">js</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">get_model_perms</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return a dict of all perms for this model. This dict has the keys 
        ``add``, ``change``, ``delete``, and ``view`` mapping to the True/False 
        for each of those actions. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s2">{</span>
            <span class="s3">&quot;add&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_add_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">),</span>
            <span class="s3">&quot;change&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">),</span>
            <span class="s3">&quot;delete&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_delete_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">),</span>
            <span class="s3">&quot;view&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_view_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">),</span>
        <span class="s2">}</span>

    <span class="s0">def </span><span class="s1">_get_form_for_get_fields</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_form</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">fields</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_form</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">change</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return a Form class for use in the admin add view. This is used by 
        add_view and change_view. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s3">&quot;fields&quot; </span><span class="s0">in </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s1">fields </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s3">&quot;fields&quot;</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">fields </span><span class="s2">= </span><span class="s1">flatten_fieldsets</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_fieldsets</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">))</span>
        <span class="s1">excluded </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_exclude</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s1">exclude </span><span class="s2">= [] </span><span class="s0">if </span><span class="s1">excluded </span><span class="s0">is None else </span><span class="s1">list</span><span class="s2">(</span><span class="s1">excluded</span><span class="s2">)</span>
        <span class="s1">readonly_fields </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_readonly_fields</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s1">exclude</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">readonly_fields</span><span class="s2">)</span>
        <span class="s5"># Exclude all fields if it's a change form and the user doesn't have</span>
        <span class="s5"># the change permission.</span>
        <span class="s0">if </span><span class="s2">(</span>
            <span class="s1">change</span>
            <span class="s0">and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s3">&quot;user&quot;</span><span class="s2">)</span>
            <span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s2">):</span>
            <span class="s1">exclude</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">fields</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">excluded </span><span class="s0">is None and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">, </span><span class="s3">&quot;_meta&quot;</span><span class="s2">) </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">exclude</span><span class="s2">:</span>
            <span class="s5"># Take the custom ModelForm's Meta.exclude into account only if the</span>
            <span class="s5"># ModelAdmin doesn't define its own.</span>
            <span class="s1">exclude</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">exclude</span><span class="s2">)</span>
        <span class="s5"># if exclude is an empty list we pass None to be consistent with the</span>
        <span class="s5"># default on modelform_factory</span>
        <span class="s1">exclude </span><span class="s2">= </span><span class="s1">exclude </span><span class="s0">or None</span>

        <span class="s5"># Remove declared form fields which are in readonly_fields.</span>
        <span class="s1">new_attrs </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">.</span><span class="s1">fromkeys</span><span class="s2">(</span>
            <span class="s1">f </span><span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">readonly_fields </span><span class="s0">if </span><span class="s1">f </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">declared_fields</span>
        <span class="s2">)</span>
        <span class="s1">form </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">, (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">,), </span><span class="s1">new_attrs</span><span class="s2">)</span>

        <span class="s1">defaults </span><span class="s2">= {</span>
            <span class="s3">&quot;form&quot;</span><span class="s2">: </span><span class="s1">form</span><span class="s2">,</span>
            <span class="s3">&quot;fields&quot;</span><span class="s2">: </span><span class="s1">fields</span><span class="s2">,</span>
            <span class="s3">&quot;exclude&quot;</span><span class="s2">: </span><span class="s1">exclude</span><span class="s2">,</span>
            <span class="s3">&quot;formfield_callback&quot;</span><span class="s2">: </span><span class="s1">partial</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">formfield_for_dbfield</span><span class="s2">, </span><span class="s1">request</span><span class="s2">=</span><span class="s1">request</span><span class="s2">),</span>
            <span class="s2">**</span><span class="s1">kwargs</span><span class="s2">,</span>
        <span class="s2">}</span>

        <span class="s0">if </span><span class="s1">defaults</span><span class="s2">[</span><span class="s3">&quot;fields&quot;</span><span class="s2">] </span><span class="s0">is None and not </span><span class="s1">modelform_defines_fields</span><span class="s2">(</span>
            <span class="s1">defaults</span><span class="s2">[</span><span class="s3">&quot;form&quot;</span><span class="s2">]</span>
        <span class="s2">):</span>
            <span class="s1">defaults</span><span class="s2">[</span><span class="s3">&quot;fields&quot;</span><span class="s2">] = </span><span class="s1">forms</span><span class="s2">.</span><span class="s1">ALL_FIELDS</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">modelform_factory</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, **</span><span class="s1">defaults</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">FieldError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">FieldError</span><span class="s2">(</span>
                <span class="s3">&quot;%s. Check fields/fieldsets/exclude attributes of class %s.&quot;</span>
                <span class="s2">% (</span><span class="s1">e</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">)</span>
            <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_changelist</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return the ChangeList class for use on the changelist page. 
        &quot;&quot;&quot;</span>
        <span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">contrib</span><span class="s2">.</span><span class="s1">admin</span><span class="s2">.</span><span class="s1">views</span><span class="s2">.</span><span class="s1">main </span><span class="s0">import </span><span class="s1">ChangeList</span>

        <span class="s0">return </span><span class="s1">ChangeList</span>

    <span class="s0">def </span><span class="s1">get_changelist_instance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return a `ChangeList` instance based on `request`. May raise 
        `IncorrectLookupParameters`. 
        &quot;&quot;&quot;</span>
        <span class="s1">list_display </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_list_display</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
        <span class="s1">list_display_links </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_list_display_links</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">list_display</span><span class="s2">)</span>
        <span class="s5"># Add the action checkboxes if any actions are available.</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_actions</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
            <span class="s1">list_display </span><span class="s2">= [</span><span class="s3">&quot;action_checkbox&quot;</span><span class="s2">, *</span><span class="s1">list_display</span><span class="s2">]</span>
        <span class="s1">sortable_by </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_sortable_by</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
        <span class="s1">ChangeList </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_changelist</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">ChangeList</span><span class="s2">(</span>
            <span class="s1">request</span><span class="s2">,</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">,</span>
            <span class="s1">list_display</span><span class="s2">,</span>
            <span class="s1">list_display_links</span><span class="s2">,</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">get_list_filter</span><span class="s2">(</span><span class="s1">request</span><span class="s2">),</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">date_hierarchy</span><span class="s2">,</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">get_search_fields</span><span class="s2">(</span><span class="s1">request</span><span class="s2">),</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">get_list_select_related</span><span class="s2">(</span><span class="s1">request</span><span class="s2">),</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">list_per_page</span><span class="s2">,</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">list_max_show_all</span><span class="s2">,</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">list_editable</span><span class="s2">,</span>
            <span class="s1">self</span><span class="s2">,</span>
            <span class="s1">sortable_by</span><span class="s2">,</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">search_help_text</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_object</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">object_id</span><span class="s2">, </span><span class="s1">from_field</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return an instance matching the field and value provided, the primary 
        key is used if no field is provided. Return ``None`` if no match is 
        found or the object_id fails validation. 
        &quot;&quot;&quot;</span>
        <span class="s1">queryset </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_queryset</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
        <span class="s1">model </span><span class="s2">= </span><span class="s1">queryset</span><span class="s2">.</span><span class="s1">model</span>
        <span class="s1">field </span><span class="s2">= (</span>
            <span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">pk </span><span class="s0">if </span><span class="s1">from_field </span><span class="s0">is None else </span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">get_field</span><span class="s2">(</span><span class="s1">from_field</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">object_id </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">to_python</span><span class="s2">(</span><span class="s1">object_id</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">queryset</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(**{</span><span class="s1">field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">: </span><span class="s1">object_id</span><span class="s2">})</span>
        <span class="s0">except </span><span class="s2">(</span><span class="s1">model</span><span class="s2">.</span><span class="s1">DoesNotExist</span><span class="s2">, </span><span class="s1">ValidationError</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s0">return None</span>

    <span class="s0">def </span><span class="s1">get_changelist_form</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return a Form class for use in the Formset on the changelist page. 
        &quot;&quot;&quot;</span>
        <span class="s1">defaults </span><span class="s2">= {</span>
            <span class="s3">&quot;formfield_callback&quot;</span><span class="s2">: </span><span class="s1">partial</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">formfield_for_dbfield</span><span class="s2">, </span><span class="s1">request</span><span class="s2">=</span><span class="s1">request</span><span class="s2">),</span>
            <span class="s2">**</span><span class="s1">kwargs</span><span class="s2">,</span>
        <span class="s2">}</span>
        <span class="s0">if </span><span class="s1">defaults</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;fields&quot;</span><span class="s2">) </span><span class="s0">is None and not </span><span class="s1">modelform_defines_fields</span><span class="s2">(</span>
            <span class="s1">defaults</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;form&quot;</span><span class="s2">)</span>
        <span class="s2">):</span>
            <span class="s1">defaults</span><span class="s2">[</span><span class="s3">&quot;fields&quot;</span><span class="s2">] = </span><span class="s1">forms</span><span class="s2">.</span><span class="s1">ALL_FIELDS</span>

        <span class="s0">return </span><span class="s1">modelform_factory</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, **</span><span class="s1">defaults</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_changelist_formset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return a FormSet class for use on the changelist page if list_editable 
        is used. 
        &quot;&quot;&quot;</span>
        <span class="s1">defaults </span><span class="s2">= {</span>
            <span class="s3">&quot;formfield_callback&quot;</span><span class="s2">: </span><span class="s1">partial</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">formfield_for_dbfield</span><span class="s2">, </span><span class="s1">request</span><span class="s2">=</span><span class="s1">request</span><span class="s2">),</span>
            <span class="s2">**</span><span class="s1">kwargs</span><span class="s2">,</span>
        <span class="s2">}</span>
        <span class="s0">return </span><span class="s1">modelformset_factory</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">,</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">get_changelist_form</span><span class="s2">(</span><span class="s1">request</span><span class="s2">),</span>
            <span class="s1">extra</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
            <span class="s1">fields</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">list_editable</span><span class="s2">,</span>
            <span class="s2">**</span><span class="s1">defaults</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_formsets_with_inlines</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Yield formsets and the corresponding inlines. 
        &quot;&quot;&quot;</span>
        <span class="s0">for </span><span class="s1">inline </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_inline_instances</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
            <span class="s0">yield </span><span class="s1">inline</span><span class="s2">.</span><span class="s1">get_formset</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">), </span><span class="s1">inline</span>

    <span class="s0">def </span><span class="s1">get_paginator</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">queryset</span><span class="s2">, </span><span class="s1">per_page</span><span class="s2">, </span><span class="s1">orphans</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">allow_empty_first_page</span><span class="s2">=</span><span class="s0">True</span>
    <span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">paginator</span><span class="s2">(</span><span class="s1">queryset</span><span class="s2">, </span><span class="s1">per_page</span><span class="s2">, </span><span class="s1">orphans</span><span class="s2">, </span><span class="s1">allow_empty_first_page</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">log_addition</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">message</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Log that an object has been successfully added. 
 
        The default implementation creates an admin LogEntry object. 
        &quot;&quot;&quot;</span>
        <span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">contrib</span><span class="s2">.</span><span class="s1">admin</span><span class="s2">.</span><span class="s1">models </span><span class="s0">import </span><span class="s1">ADDITION</span><span class="s2">, </span><span class="s1">LogEntry</span>

        <span class="s0">return </span><span class="s1">LogEntry</span><span class="s2">.</span><span class="s1">objects</span><span class="s2">.</span><span class="s1">log_action</span><span class="s2">(</span>
            <span class="s1">user_id</span><span class="s2">=</span><span class="s1">request</span><span class="s2">.</span><span class="s1">user</span><span class="s2">.</span><span class="s1">pk</span><span class="s2">,</span>
            <span class="s1">content_type_id</span><span class="s2">=</span><span class="s1">get_content_type_for_model</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">).</span><span class="s1">pk</span><span class="s2">,</span>
            <span class="s1">object_id</span><span class="s2">=</span><span class="s1">obj</span><span class="s2">.</span><span class="s1">pk</span><span class="s2">,</span>
            <span class="s1">object_repr</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">),</span>
            <span class="s1">action_flag</span><span class="s2">=</span><span class="s1">ADDITION</span><span class="s2">,</span>
            <span class="s1">change_message</span><span class="s2">=</span><span class="s1">message</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">log_change</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">message</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Log that an object has been successfully changed. 
 
        The default implementation creates an admin LogEntry object. 
        &quot;&quot;&quot;</span>
        <span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">contrib</span><span class="s2">.</span><span class="s1">admin</span><span class="s2">.</span><span class="s1">models </span><span class="s0">import </span><span class="s1">CHANGE</span><span class="s2">, </span><span class="s1">LogEntry</span>

        <span class="s0">return </span><span class="s1">LogEntry</span><span class="s2">.</span><span class="s1">objects</span><span class="s2">.</span><span class="s1">log_action</span><span class="s2">(</span>
            <span class="s1">user_id</span><span class="s2">=</span><span class="s1">request</span><span class="s2">.</span><span class="s1">user</span><span class="s2">.</span><span class="s1">pk</span><span class="s2">,</span>
            <span class="s1">content_type_id</span><span class="s2">=</span><span class="s1">get_content_type_for_model</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">).</span><span class="s1">pk</span><span class="s2">,</span>
            <span class="s1">object_id</span><span class="s2">=</span><span class="s1">obj</span><span class="s2">.</span><span class="s1">pk</span><span class="s2">,</span>
            <span class="s1">object_repr</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">),</span>
            <span class="s1">action_flag</span><span class="s2">=</span><span class="s1">CHANGE</span><span class="s2">,</span>
            <span class="s1">change_message</span><span class="s2">=</span><span class="s1">message</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">log_deletion</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">object_repr</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Log that an object will be deleted. Note that this method must be 
        called before the deletion. 
 
        The default implementation creates an admin LogEntry object. 
        &quot;&quot;&quot;</span>
        <span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">contrib</span><span class="s2">.</span><span class="s1">admin</span><span class="s2">.</span><span class="s1">models </span><span class="s0">import </span><span class="s1">DELETION</span><span class="s2">, </span><span class="s1">LogEntry</span>

        <span class="s0">return </span><span class="s1">LogEntry</span><span class="s2">.</span><span class="s1">objects</span><span class="s2">.</span><span class="s1">log_action</span><span class="s2">(</span>
            <span class="s1">user_id</span><span class="s2">=</span><span class="s1">request</span><span class="s2">.</span><span class="s1">user</span><span class="s2">.</span><span class="s1">pk</span><span class="s2">,</span>
            <span class="s1">content_type_id</span><span class="s2">=</span><span class="s1">get_content_type_for_model</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">).</span><span class="s1">pk</span><span class="s2">,</span>
            <span class="s1">object_id</span><span class="s2">=</span><span class="s1">obj</span><span class="s2">.</span><span class="s1">pk</span><span class="s2">,</span>
            <span class="s1">object_repr</span><span class="s2">=</span><span class="s1">object_repr</span><span class="s2">,</span>
            <span class="s1">action_flag</span><span class="s2">=</span><span class="s1">DELETION</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">action_checkbox</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        A list_display column containing a checkbox widget. 
        &quot;&quot;&quot;</span>
        <span class="s1">attrs </span><span class="s2">= {</span>
            <span class="s3">&quot;class&quot;</span><span class="s2">: </span><span class="s3">&quot;action-select&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;aria-label&quot;</span><span class="s2">: </span><span class="s1">format_html</span><span class="s2">(</span><span class="s1">_</span><span class="s2">(</span><span class="s3">&quot;Select this object for an action - {}&quot;</span><span class="s2">), </span><span class="s1">obj</span><span class="s2">),</span>
        <span class="s2">}</span>
        <span class="s1">checkbox </span><span class="s2">= </span><span class="s1">forms</span><span class="s2">.</span><span class="s1">CheckboxInput</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">value</span><span class="s2">: </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">checkbox</span><span class="s2">.</span><span class="s1">render</span><span class="s2">(</span><span class="s1">helpers</span><span class="s2">.</span><span class="s1">ACTION_CHECKBOX_NAME</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">.</span><span class="s1">pk</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">_get_action_description</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s3">&quot;short_description&quot;</span><span class="s2">, </span><span class="s1">capfirst</span><span class="s2">(</span><span class="s1">name</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">&quot;_&quot;</span><span class="s2">, </span><span class="s3">&quot; &quot;</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">_get_base_actions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Return the list of actions, prior to any request-based filtering.&quot;&quot;&quot;</span>
        <span class="s1">actions </span><span class="s2">= []</span>
        <span class="s1">base_actions </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_action</span><span class="s2">(</span><span class="s1">action</span><span class="s2">) </span><span class="s0">for </span><span class="s1">action </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">actions </span><span class="s0">or </span><span class="s2">[])</span>
        <span class="s5"># get_action might have returned None, so filter any of those out.</span>
        <span class="s1">base_actions </span><span class="s2">= [</span><span class="s1">action </span><span class="s0">for </span><span class="s1">action </span><span class="s0">in </span><span class="s1">base_actions </span><span class="s0">if </span><span class="s1">action</span><span class="s2">]</span>
        <span class="s1">base_action_names </span><span class="s2">= {</span><span class="s1">name </span><span class="s0">for </span><span class="s1">_</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">base_actions</span><span class="s2">}</span>

        <span class="s5"># Gather actions from the admin site first</span>
        <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">func </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">actions</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">name </span><span class="s0">in </span><span class="s1">base_action_names</span><span class="s2">:</span>
                <span class="s0">continue</span>
            <span class="s1">description </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_action_description</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">actions</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">func</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">description</span><span class="s2">))</span>
        <span class="s5"># Add actions from this ModelAdmin.</span>
        <span class="s1">actions</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">base_actions</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">actions</span>

    <span class="s0">def </span><span class="s1">_filter_actions_by_permissions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">actions</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Filter out any actions that the user doesn't have access to.&quot;&quot;&quot;</span>
        <span class="s1">filtered_actions </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">action </span><span class="s0">in </span><span class="s1">actions</span><span class="s2">:</span>
            <span class="s1">callable </span><span class="s2">= </span><span class="s1">action</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
            <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">callable</span><span class="s2">, </span><span class="s3">&quot;allowed_permissions&quot;</span><span class="s2">):</span>
                <span class="s1">filtered_actions</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">action</span><span class="s2">)</span>
                <span class="s0">continue</span>
            <span class="s1">permission_checks </span><span class="s2">= (</span>
                <span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">&quot;has_%s_permission&quot; </span><span class="s2">% </span><span class="s1">permission</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">permission </span><span class="s0">in </span><span class="s1">callable</span><span class="s2">.</span><span class="s1">allowed_permissions</span>
            <span class="s2">)</span>
            <span class="s0">if </span><span class="s1">any</span><span class="s2">(</span><span class="s1">has_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">) </span><span class="s0">for </span><span class="s1">has_permission </span><span class="s0">in </span><span class="s1">permission_checks</span><span class="s2">):</span>
                <span class="s1">filtered_actions</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">action</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">filtered_actions</span>

    <span class="s0">def </span><span class="s1">get_actions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return a dictionary mapping the names of all actions for this 
        ModelAdmin to a tuple of (callable, name, description) for each action. 
        &quot;&quot;&quot;</span>
        <span class="s5"># If self.actions is set to None that means actions are disabled on</span>
        <span class="s5"># this page.</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">actions </span><span class="s0">is None or </span><span class="s1">IS_POPUP_VAR </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">GET</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s2">{}</span>
        <span class="s1">actions </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_filter_actions_by_permissions</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_base_actions</span><span class="s2">())</span>
        <span class="s0">return </span><span class="s2">{</span><span class="s1">name</span><span class="s2">: (</span><span class="s1">func</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">desc</span><span class="s2">) </span><span class="s0">for </span><span class="s1">func</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">desc </span><span class="s0">in </span><span class="s1">actions</span><span class="s2">}</span>

    <span class="s0">def </span><span class="s1">get_action_choices</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">default_choices</span><span class="s2">=</span><span class="s1">models</span><span class="s2">.</span><span class="s1">BLANK_CHOICE_DASH</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return a list of choices for use in a form object.  Each choice is a 
        tuple (name, description). 
        &quot;&quot;&quot;</span>
        <span class="s1">choices </span><span class="s2">= [] + </span><span class="s1">default_choices</span>
        <span class="s0">for </span><span class="s1">func</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">description </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_actions</span><span class="s2">(</span><span class="s1">request</span><span class="s2">).</span><span class="s1">values</span><span class="s2">():</span>
            <span class="s1">choice </span><span class="s2">= (</span><span class="s1">name</span><span class="s2">, </span><span class="s1">description </span><span class="s2">% </span><span class="s1">model_format_dict</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">))</span>
            <span class="s1">choices</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">choice</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">choices</span>

    <span class="s0">def </span><span class="s1">get_action</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">action</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return a given action from a parameter, which can either be a callable, 
        or the name of a method on the ModelAdmin.  Return is a tuple of 
        (callable, name, description). 
        &quot;&quot;&quot;</span>
        <span class="s5"># If the action is a callable, just use it.</span>
        <span class="s0">if </span><span class="s1">callable</span><span class="s2">(</span><span class="s1">action</span><span class="s2">):</span>
            <span class="s1">func </span><span class="s2">= </span><span class="s1">action</span>
            <span class="s1">action </span><span class="s2">= </span><span class="s1">action</span><span class="s2">.</span><span class="s1">__name__</span>

        <span class="s5"># Next, look for a method. Grab it off self.__class__ to get an unbound</span>
        <span class="s5"># method instead of a bound one; this ensures that the calling</span>
        <span class="s5"># conventions are the same for functions and methods.</span>
        <span class="s0">elif </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">, </span><span class="s1">action</span><span class="s2">):</span>
            <span class="s1">func </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">, </span><span class="s1">action</span><span class="s2">)</span>

        <span class="s5"># Finally, look for a named method on the admin site</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">func </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">get_action</span><span class="s2">(</span><span class="s1">action</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">KeyError</span><span class="s2">:</span>
                <span class="s0">return None</span>

        <span class="s1">description </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_action_description</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">action</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">func</span><span class="s2">, </span><span class="s1">action</span><span class="s2">, </span><span class="s1">description</span>

    <span class="s0">def </span><span class="s1">get_list_display</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return a sequence containing the fields to be displayed on the 
        changelist. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">list_display</span>

    <span class="s0">def </span><span class="s1">get_list_display_links</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">list_display</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return a sequence containing the fields to be displayed as links 
        on the changelist. The list_display parameter is the list of fields 
        returned by get_list_display(). 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">list_display_links</span>
            <span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">list_display_links </span><span class="s0">is None</span>
            <span class="s0">or not </span><span class="s1">list_display</span>
        <span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">list_display_links</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s5"># Use only the first item in list_display as link</span>
            <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">list_display</span><span class="s2">)[:</span><span class="s4">1</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">get_list_filter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return a sequence containing the fields to be displayed as filters in 
        the right sidebar of the changelist page. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">list_filter</span>

    <span class="s0">def </span><span class="s1">get_list_select_related</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return a list of fields to add to the select_related() part of the 
        changelist items query. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">list_select_related</span>

    <span class="s0">def </span><span class="s1">get_search_fields</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return a sequence containing the fields to be searched whenever 
        somebody submits a search query. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">search_fields</span>

    <span class="s0">def </span><span class="s1">get_search_results</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">queryset</span><span class="s2">, </span><span class="s1">search_term</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return a tuple containing a queryset to implement the search 
        and a boolean indicating if the results may contain duplicates. 
        &quot;&quot;&quot;</span>

        <span class="s5"># Apply keyword searches.</span>
        <span class="s0">def </span><span class="s1">construct_search</span><span class="s2">(</span><span class="s1">field_name</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">field_name</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;^&quot;</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s3">&quot;%s__istartswith&quot; </span><span class="s2">% </span><span class="s1">field_name</span><span class="s2">.</span><span class="s1">removeprefix</span><span class="s2">(</span><span class="s3">&quot;^&quot;</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">field_name</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;=&quot;</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s3">&quot;%s__iexact&quot; </span><span class="s2">% </span><span class="s1">field_name</span><span class="s2">.</span><span class="s1">removeprefix</span><span class="s2">(</span><span class="s3">&quot;=&quot;</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">field_name</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;@&quot;</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s3">&quot;%s__search&quot; </span><span class="s2">% </span><span class="s1">field_name</span><span class="s2">.</span><span class="s1">removeprefix</span><span class="s2">(</span><span class="s3">&quot;@&quot;</span><span class="s2">)</span>
            <span class="s5"># Use field_name if it includes a lookup.</span>
            <span class="s1">opts </span><span class="s2">= </span><span class="s1">queryset</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span>
            <span class="s1">lookup_fields </span><span class="s2">= </span><span class="s1">field_name</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s1">LOOKUP_SEP</span><span class="s2">)</span>
            <span class="s5"># Go through the fields, following all relations.</span>
            <span class="s1">prev_field </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s0">for </span><span class="s1">path_part </span><span class="s0">in </span><span class="s1">lookup_fields</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">path_part </span><span class="s2">== </span><span class="s3">&quot;pk&quot;</span><span class="s2">:</span>
                    <span class="s1">path_part </span><span class="s2">= </span><span class="s1">opts</span><span class="s2">.</span><span class="s1">pk</span><span class="s2">.</span><span class="s1">name</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">field </span><span class="s2">= </span><span class="s1">opts</span><span class="s2">.</span><span class="s1">get_field</span><span class="s2">(</span><span class="s1">path_part</span><span class="s2">)</span>
                <span class="s0">except </span><span class="s1">FieldDoesNotExist</span><span class="s2">:</span>
                    <span class="s5"># Use valid query lookups.</span>
                    <span class="s0">if </span><span class="s1">prev_field </span><span class="s0">and </span><span class="s1">prev_field</span><span class="s2">.</span><span class="s1">get_lookup</span><span class="s2">(</span><span class="s1">path_part</span><span class="s2">):</span>
                        <span class="s0">return </span><span class="s1">field_name</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">prev_field </span><span class="s2">= </span><span class="s1">field</span>
                    <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s3">&quot;path_infos&quot;</span><span class="s2">):</span>
                        <span class="s5"># Update opts to follow the relation.</span>
                        <span class="s1">opts </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">path_infos</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">].</span><span class="s1">to_opts</span>
            <span class="s5"># Otherwise, use the field with icontains.</span>
            <span class="s0">return </span><span class="s3">&quot;%s__icontains&quot; </span><span class="s2">% </span><span class="s1">field_name</span>

        <span class="s1">may_have_duplicates </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">search_fields </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_search_fields</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">search_fields </span><span class="s0">and </span><span class="s1">search_term</span><span class="s2">:</span>
            <span class="s1">orm_lookups </span><span class="s2">= [</span>
                <span class="s1">construct_search</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">search_field</span><span class="s2">)) </span><span class="s0">for </span><span class="s1">search_field </span><span class="s0">in </span><span class="s1">search_fields</span>
            <span class="s2">]</span>
            <span class="s1">term_queries </span><span class="s2">= []</span>
            <span class="s0">for </span><span class="s1">bit </span><span class="s0">in </span><span class="s1">smart_split</span><span class="s2">(</span><span class="s1">search_term</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">bit</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">((</span><span class="s3">'&quot;'</span><span class="s2">, </span><span class="s3">&quot;'&quot;</span><span class="s2">)) </span><span class="s0">and </span><span class="s1">bit</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s1">bit</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]:</span>
                    <span class="s1">bit </span><span class="s2">= </span><span class="s1">unescape_string_literal</span><span class="s2">(</span><span class="s1">bit</span><span class="s2">)</span>
                <span class="s1">or_queries </span><span class="s2">= </span><span class="s1">models</span><span class="s2">.</span><span class="s1">Q</span><span class="s2">.</span><span class="s1">create</span><span class="s2">(</span>
                    <span class="s2">[(</span><span class="s1">orm_lookup</span><span class="s2">, </span><span class="s1">bit</span><span class="s2">) </span><span class="s0">for </span><span class="s1">orm_lookup </span><span class="s0">in </span><span class="s1">orm_lookups</span><span class="s2">],</span>
                    <span class="s1">connector</span><span class="s2">=</span><span class="s1">models</span><span class="s2">.</span><span class="s1">Q</span><span class="s2">.</span><span class="s1">OR</span><span class="s2">,</span>
                <span class="s2">)</span>
                <span class="s1">term_queries</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">or_queries</span><span class="s2">)</span>
            <span class="s1">queryset </span><span class="s2">= </span><span class="s1">queryset</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">models</span><span class="s2">.</span><span class="s1">Q</span><span class="s2">.</span><span class="s1">create</span><span class="s2">(</span><span class="s1">term_queries</span><span class="s2">))</span>
            <span class="s1">may_have_duplicates </span><span class="s2">|= </span><span class="s1">any</span><span class="s2">(</span>
                <span class="s1">lookup_spawns_duplicates</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">, </span><span class="s1">search_spec</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">search_spec </span><span class="s0">in </span><span class="s1">orm_lookups</span>
            <span class="s2">)</span>
        <span class="s0">return </span><span class="s1">queryset</span><span class="s2">, </span><span class="s1">may_have_duplicates</span>

    <span class="s0">def </span><span class="s1">get_preserved_filters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return the preserved filters querystring. 
        &quot;&quot;&quot;</span>
        <span class="s1">match </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">resolver_match</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">preserve_filters </span><span class="s0">and </span><span class="s1">match</span><span class="s2">:</span>
            <span class="s1">current_url </span><span class="s2">= </span><span class="s3">&quot;%s:%s&quot; </span><span class="s2">% (</span><span class="s1">match</span><span class="s2">.</span><span class="s1">app_name</span><span class="s2">, </span><span class="s1">match</span><span class="s2">.</span><span class="s1">url_name</span><span class="s2">)</span>
            <span class="s1">changelist_url </span><span class="s2">= </span><span class="s3">&quot;admin:%s_%s_changelist&quot; </span><span class="s2">% (</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span><span class="s2">,</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">model_name</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s0">if </span><span class="s1">current_url </span><span class="s2">== </span><span class="s1">changelist_url</span><span class="s2">:</span>
                <span class="s1">preserved_filters </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">GET</span><span class="s2">.</span><span class="s1">urlencode</span><span class="s2">()</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">preserved_filters </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">GET</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;_changelist_filters&quot;</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">preserved_filters</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">urlencode</span><span class="s2">({</span><span class="s3">&quot;_changelist_filters&quot;</span><span class="s2">: </span><span class="s1">preserved_filters</span><span class="s2">})</span>
        <span class="s0">return </span><span class="s3">&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">construct_change_message</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">form</span><span class="s2">, </span><span class="s1">formsets</span><span class="s2">, </span><span class="s1">add</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Construct a JSON structure describing changes from a changed object. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">construct_change_message</span><span class="s2">(</span><span class="s1">form</span><span class="s2">, </span><span class="s1">formsets</span><span class="s2">, </span><span class="s1">add</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">message_user</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">message</span><span class="s2">, </span><span class="s1">level</span><span class="s2">=</span><span class="s1">messages</span><span class="s2">.</span><span class="s1">INFO</span><span class="s2">, </span><span class="s1">extra_tags</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">fail_silently</span><span class="s2">=</span><span class="s0">False</span>
    <span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Send a message to the user. The default implementation 
        posts a message using the django.contrib.messages backend. 
 
        Exposes almost the same API as messages.add_message(), but accepts the 
        positional arguments in a different order to maintain backwards 
        compatibility. For convenience, it accepts the `level` argument as 
        a string rather than the usual level number. 
        &quot;&quot;&quot;</span>
        <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">level</span><span class="s2">, </span><span class="s1">int</span><span class="s2">):</span>
            <span class="s5"># attempt to get the level if passed a string</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">level </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">messages</span><span class="s2">.</span><span class="s1">constants</span><span class="s2">, </span><span class="s1">level</span><span class="s2">.</span><span class="s1">upper</span><span class="s2">())</span>
            <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
                <span class="s1">levels </span><span class="s2">= </span><span class="s1">messages</span><span class="s2">.</span><span class="s1">constants</span><span class="s2">.</span><span class="s1">DEFAULT_TAGS</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()</span>
                <span class="s1">levels_repr </span><span class="s2">= </span><span class="s3">&quot;, &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">&quot;`%s`&quot; </span><span class="s2">% </span><span class="s1">level </span><span class="s0">for </span><span class="s1">level </span><span class="s0">in </span><span class="s1">levels</span><span class="s2">)</span>
                <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                    <span class="s3">&quot;Bad message level string: `%s`. Possible values are: %s&quot;</span>
                    <span class="s2">% (</span><span class="s1">level</span><span class="s2">, </span><span class="s1">levels_repr</span><span class="s2">)</span>
                <span class="s2">)</span>

        <span class="s1">messages</span><span class="s2">.</span><span class="s1">add_message</span><span class="s2">(</span>
            <span class="s1">request</span><span class="s2">, </span><span class="s1">level</span><span class="s2">, </span><span class="s1">message</span><span class="s2">, </span><span class="s1">extra_tags</span><span class="s2">=</span><span class="s1">extra_tags</span><span class="s2">, </span><span class="s1">fail_silently</span><span class="s2">=</span><span class="s1">fail_silently</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">save_form</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">form</span><span class="s2">, </span><span class="s1">change</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Given a ModelForm return an unsaved instance. ``change`` is True if 
        the object is being changed, and False if it's being added. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">form</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s1">commit</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">save_model</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">form</span><span class="s2">, </span><span class="s1">change</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Given a model instance save it to the database. 
        &quot;&quot;&quot;</span>
        <span class="s1">obj</span><span class="s2">.</span><span class="s1">save</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">delete_model</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Given a model instance delete it from the database. 
        &quot;&quot;&quot;</span>
        <span class="s1">obj</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">delete_queryset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">queryset</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Given a queryset, delete it from the database.&quot;&quot;&quot;</span>
        <span class="s1">queryset</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">save_formset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">form</span><span class="s2">, </span><span class="s1">formset</span><span class="s2">, </span><span class="s1">change</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Given an inline formset save it to the database. 
        &quot;&quot;&quot;</span>
        <span class="s1">formset</span><span class="s2">.</span><span class="s1">save</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">save_related</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">form</span><span class="s2">, </span><span class="s1">formsets</span><span class="s2">, </span><span class="s1">change</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Given the ``HttpRequest``, the parent ``ModelForm`` instance, the 
        list of inline formsets and a boolean value based on whether the 
        parent is being added or changed, save the related objects to the 
        database. Note that at this point save_form() and save_model() have 
        already been called. 
        &quot;&quot;&quot;</span>
        <span class="s1">form</span><span class="s2">.</span><span class="s1">save_m2m</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">formset </span><span class="s0">in </span><span class="s1">formsets</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">save_formset</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">form</span><span class="s2">, </span><span class="s1">formset</span><span class="s2">, </span><span class="s1">change</span><span class="s2">=</span><span class="s1">change</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">render_change_form</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">context</span><span class="s2">, </span><span class="s1">add</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">change</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">form_url</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span>
    <span class="s2">):</span>
        <span class="s1">app_label </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span>
        <span class="s1">preserved_filters </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_preserved_filters</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
        <span class="s1">form_url </span><span class="s2">= </span><span class="s1">add_preserved_filters</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;preserved_filters&quot;</span><span class="s2">: </span><span class="s1">preserved_filters</span><span class="s2">, </span><span class="s3">&quot;opts&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">}, </span><span class="s1">form_url</span>
        <span class="s2">)</span>
        <span class="s1">view_on_site_url </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_view_on_site_url</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s1">has_editable_inline_admin_formsets </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s0">for </span><span class="s1">inline </span><span class="s0">in </span><span class="s1">context</span><span class="s2">[</span><span class="s3">&quot;inline_admin_formsets&quot;</span><span class="s2">]:</span>
            <span class="s0">if </span><span class="s2">(</span>
                <span class="s1">inline</span><span class="s2">.</span><span class="s1">has_add_permission</span>
                <span class="s0">or </span><span class="s1">inline</span><span class="s2">.</span><span class="s1">has_change_permission</span>
                <span class="s0">or </span><span class="s1">inline</span><span class="s2">.</span><span class="s1">has_delete_permission</span>
            <span class="s2">):</span>
                <span class="s1">has_editable_inline_admin_formsets </span><span class="s2">= </span><span class="s0">True</span>
                <span class="s0">break</span>
        <span class="s1">context</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;add&quot;</span><span class="s2">: </span><span class="s1">add</span><span class="s2">,</span>
                <span class="s3">&quot;change&quot;</span><span class="s2">: </span><span class="s1">change</span><span class="s2">,</span>
                <span class="s3">&quot;has_view_permission&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_view_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">),</span>
                <span class="s3">&quot;has_add_permission&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_add_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">),</span>
                <span class="s3">&quot;has_change_permission&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">),</span>
                <span class="s3">&quot;has_delete_permission&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_delete_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">),</span>
                <span class="s3">&quot;has_editable_inline_admin_formsets&quot;</span><span class="s2">: (</span>
                    <span class="s1">has_editable_inline_admin_formsets</span>
                <span class="s2">),</span>
                <span class="s3">&quot;has_file_field&quot;</span><span class="s2">: </span><span class="s1">context</span><span class="s2">[</span><span class="s3">&quot;adminform&quot;</span><span class="s2">].</span><span class="s1">form</span><span class="s2">.</span><span class="s1">is_multipart</span><span class="s2">()</span>
                <span class="s0">or </span><span class="s1">any</span><span class="s2">(</span>
                    <span class="s1">admin_formset</span><span class="s2">.</span><span class="s1">formset</span><span class="s2">.</span><span class="s1">is_multipart</span><span class="s2">()</span>
                    <span class="s0">for </span><span class="s1">admin_formset </span><span class="s0">in </span><span class="s1">context</span><span class="s2">[</span><span class="s3">&quot;inline_admin_formsets&quot;</span><span class="s2">]</span>
                <span class="s2">),</span>
                <span class="s3">&quot;has_absolute_url&quot;</span><span class="s2">: </span><span class="s1">view_on_site_url </span><span class="s0">is not None</span><span class="s2">,</span>
                <span class="s3">&quot;absolute_url&quot;</span><span class="s2">: </span><span class="s1">view_on_site_url</span><span class="s2">,</span>
                <span class="s3">&quot;form_url&quot;</span><span class="s2">: </span><span class="s1">form_url</span><span class="s2">,</span>
                <span class="s3">&quot;opts&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">,</span>
                <span class="s3">&quot;content_type_id&quot;</span><span class="s2">: </span><span class="s1">get_content_type_for_model</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">).</span><span class="s1">pk</span><span class="s2">,</span>
                <span class="s3">&quot;save_as&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">save_as</span><span class="s2">,</span>
                <span class="s3">&quot;save_on_top&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">save_on_top</span><span class="s2">,</span>
                <span class="s3">&quot;to_field_var&quot;</span><span class="s2">: </span><span class="s1">TO_FIELD_VAR</span><span class="s2">,</span>
                <span class="s3">&quot;is_popup_var&quot;</span><span class="s2">: </span><span class="s1">IS_POPUP_VAR</span><span class="s2">,</span>
                <span class="s3">&quot;app_label&quot;</span><span class="s2">: </span><span class="s1">app_label</span><span class="s2">,</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s0">if </span><span class="s1">add </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">add_form_template </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">form_template </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">add_form_template</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">form_template </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">change_form_template</span>

        <span class="s1">request</span><span class="s2">.</span><span class="s1">current_app </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">name</span>

        <span class="s0">return </span><span class="s1">TemplateResponse</span><span class="s2">(</span>
            <span class="s1">request</span><span class="s2">,</span>
            <span class="s1">form_template</span>
            <span class="s0">or </span><span class="s2">[</span>
                <span class="s3">&quot;admin/%s/%s/change_form.html&quot; </span><span class="s2">% (</span><span class="s1">app_label</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">model_name</span><span class="s2">),</span>
                <span class="s3">&quot;admin/%s/change_form.html&quot; </span><span class="s2">% </span><span class="s1">app_label</span><span class="s2">,</span>
                <span class="s3">&quot;admin/change_form.html&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s1">context</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_get_preserved_qsl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">preserved_filters</span><span class="s2">):</span>
        <span class="s1">query_string </span><span class="s2">= </span><span class="s1">urlparse</span><span class="s2">(</span><span class="s1">request</span><span class="s2">.</span><span class="s1">build_absolute_uri</span><span class="s2">()).</span><span class="s1">query</span>
        <span class="s0">return </span><span class="s1">parse_qsl</span><span class="s2">(</span><span class="s1">query_string</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">preserved_filters</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">response_add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">post_url_continue</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Determine the HttpResponse for the add_view stage. 
        &quot;&quot;&quot;</span>
        <span class="s1">opts </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">_meta</span>
        <span class="s1">preserved_filters </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_preserved_filters</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
        <span class="s1">preserved_qsl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_preserved_qsl</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">preserved_filters</span><span class="s2">)</span>
        <span class="s1">obj_url </span><span class="s2">= </span><span class="s1">reverse</span><span class="s2">(</span>
            <span class="s3">&quot;admin:%s_%s_change&quot; </span><span class="s2">% (</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span><span class="s2">, </span><span class="s1">opts</span><span class="s2">.</span><span class="s1">model_name</span><span class="s2">),</span>
            <span class="s1">args</span><span class="s2">=(</span><span class="s1">quote</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">.</span><span class="s1">pk</span><span class="s2">),),</span>
            <span class="s1">current_app</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">name</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s5"># Add a link to the object's change form if the user can edit the obj.</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
            <span class="s1">obj_repr </span><span class="s2">= </span><span class="s1">format_html</span><span class="s2">(</span><span class="s3">'&lt;a href=&quot;{}&quot;&gt;{}&lt;/a&gt;'</span><span class="s2">, </span><span class="s1">urlquote</span><span class="s2">(</span><span class="s1">obj_url</span><span class="s2">), </span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">obj_repr </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s1">msg_dict </span><span class="s2">= {</span>
            <span class="s3">&quot;name&quot;</span><span class="s2">: </span><span class="s1">opts</span><span class="s2">.</span><span class="s1">verbose_name</span><span class="s2">,</span>
            <span class="s3">&quot;obj&quot;</span><span class="s2">: </span><span class="s1">obj_repr</span><span class="s2">,</span>
        <span class="s2">}</span>
        <span class="s5"># Here, we distinguish between different save types by checking for</span>
        <span class="s5"># the presence of keys in request.POST.</span>

        <span class="s0">if </span><span class="s1">IS_POPUP_VAR </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span><span class="s2">:</span>
            <span class="s1">to_field </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">TO_FIELD_VAR</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">to_field</span><span class="s2">:</span>
                <span class="s1">attr </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">to_field</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">attr </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">pk</span><span class="s2">.</span><span class="s1">attname</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">serializable_value</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">)</span>
            <span class="s1">popup_response_data </span><span class="s2">= </span><span class="s1">json</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span>
                <span class="s2">{</span>
                    <span class="s3">&quot;value&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">value</span><span class="s2">),</span>
                    <span class="s3">&quot;obj&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">),</span>
                <span class="s2">}</span>
            <span class="s2">)</span>
            <span class="s0">return </span><span class="s1">TemplateResponse</span><span class="s2">(</span>
                <span class="s1">request</span><span class="s2">,</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">popup_response_template</span>
                <span class="s0">or </span><span class="s2">[</span>
                    <span class="s3">&quot;admin/%s/%s/popup_response.html&quot;</span>
                    <span class="s2">% (</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span><span class="s2">, </span><span class="s1">opts</span><span class="s2">.</span><span class="s1">model_name</span><span class="s2">),</span>
                    <span class="s3">&quot;admin/%s/popup_response.html&quot; </span><span class="s2">% </span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span><span class="s2">,</span>
                    <span class="s3">&quot;admin/popup_response.html&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">{</span>
                    <span class="s3">&quot;popup_response_data&quot;</span><span class="s2">: </span><span class="s1">popup_response_data</span><span class="s2">,</span>
                <span class="s2">},</span>
            <span class="s2">)</span>

        <span class="s0">elif </span><span class="s3">&quot;_continue&quot; </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST </span><span class="s0">or </span><span class="s2">(</span>
            <span class="s5"># Redirecting after &quot;Save as new&quot;.</span>
            <span class="s3">&quot;_saveasnew&quot; </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span>
            <span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">save_as_continue</span>
            <span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s2">):</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s1">_</span><span class="s2">(</span><span class="s3">&quot;The {name} “{obj}” was added successfully.&quot;</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
                <span class="s1">msg </span><span class="s2">+= </span><span class="s3">&quot; &quot; </span><span class="s2">+ </span><span class="s1">_</span><span class="s2">(</span><span class="s3">&quot;You may edit it again below.&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">message_user</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">format_html</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">, **</span><span class="s1">msg_dict</span><span class="s2">), </span><span class="s1">messages</span><span class="s2">.</span><span class="s1">SUCCESS</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">post_url_continue </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s1">post_url_continue </span><span class="s2">= </span><span class="s1">obj_url</span>
            <span class="s1">post_url_continue </span><span class="s2">= </span><span class="s1">add_preserved_filters</span><span class="s2">(</span>
                <span class="s2">{</span>
                    <span class="s3">&quot;preserved_filters&quot;</span><span class="s2">: </span><span class="s1">preserved_filters</span><span class="s2">,</span>
                    <span class="s3">&quot;preserved_qsl&quot;</span><span class="s2">: </span><span class="s1">preserved_qsl</span><span class="s2">,</span>
                    <span class="s3">&quot;opts&quot;</span><span class="s2">: </span><span class="s1">opts</span><span class="s2">,</span>
                <span class="s2">},</span>
                <span class="s1">post_url_continue</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s0">return </span><span class="s1">HttpResponseRedirect</span><span class="s2">(</span><span class="s1">post_url_continue</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s3">&quot;_addanother&quot; </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s1">format_html</span><span class="s2">(</span>
                <span class="s1">_</span><span class="s2">(</span>
                    <span class="s3">&quot;The {name} “{obj}” was added successfully. You may add another &quot;</span>
                    <span class="s3">&quot;{name} below.&quot;</span>
                <span class="s2">),</span>
                <span class="s2">**</span><span class="s1">msg_dict</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">message_user</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">messages</span><span class="s2">.</span><span class="s1">SUCCESS</span><span class="s2">)</span>
            <span class="s1">redirect_url </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">path</span>
            <span class="s1">redirect_url </span><span class="s2">= </span><span class="s1">add_preserved_filters</span><span class="s2">(</span>
                <span class="s2">{</span>
                    <span class="s3">&quot;preserved_filters&quot;</span><span class="s2">: </span><span class="s1">preserved_filters</span><span class="s2">,</span>
                    <span class="s3">&quot;preserved_qsl&quot;</span><span class="s2">: </span><span class="s1">preserved_qsl</span><span class="s2">,</span>
                    <span class="s3">&quot;opts&quot;</span><span class="s2">: </span><span class="s1">opts</span><span class="s2">,</span>
                <span class="s2">},</span>
                <span class="s1">redirect_url</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s0">return </span><span class="s1">HttpResponseRedirect</span><span class="s2">(</span><span class="s1">redirect_url</span><span class="s2">)</span>

        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s1">format_html</span><span class="s2">(</span>
                <span class="s1">_</span><span class="s2">(</span><span class="s3">&quot;The {name} “{obj}” was added successfully.&quot;</span><span class="s2">), **</span><span class="s1">msg_dict</span>
            <span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">message_user</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">messages</span><span class="s2">.</span><span class="s1">SUCCESS</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">response_post_save_add</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">response_change</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Determine the HttpResponse for the change_view stage. 
        &quot;&quot;&quot;</span>

        <span class="s0">if </span><span class="s1">IS_POPUP_VAR </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span><span class="s2">:</span>
            <span class="s1">opts </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">_meta</span>
            <span class="s1">to_field </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">TO_FIELD_VAR</span><span class="s2">)</span>
            <span class="s1">attr </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">to_field</span><span class="s2">) </span><span class="s0">if </span><span class="s1">to_field </span><span class="s0">else </span><span class="s1">opts</span><span class="s2">.</span><span class="s1">pk</span><span class="s2">.</span><span class="s1">attname</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">resolver_match</span><span class="s2">.</span><span class="s1">kwargs</span><span class="s2">[</span><span class="s3">&quot;object_id&quot;</span><span class="s2">]</span>
            <span class="s1">new_value </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">serializable_value</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">)</span>
            <span class="s1">popup_response_data </span><span class="s2">= </span><span class="s1">json</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span>
                <span class="s2">{</span>
                    <span class="s3">&quot;action&quot;</span><span class="s2">: </span><span class="s3">&quot;change&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;value&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">value</span><span class="s2">),</span>
                    <span class="s3">&quot;obj&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">),</span>
                    <span class="s3">&quot;new_value&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">new_value</span><span class="s2">),</span>
                <span class="s2">}</span>
            <span class="s2">)</span>
            <span class="s0">return </span><span class="s1">TemplateResponse</span><span class="s2">(</span>
                <span class="s1">request</span><span class="s2">,</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">popup_response_template</span>
                <span class="s0">or </span><span class="s2">[</span>
                    <span class="s3">&quot;admin/%s/%s/popup_response.html&quot;</span>
                    <span class="s2">% (</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span><span class="s2">, </span><span class="s1">opts</span><span class="s2">.</span><span class="s1">model_name</span><span class="s2">),</span>
                    <span class="s3">&quot;admin/%s/popup_response.html&quot; </span><span class="s2">% </span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span><span class="s2">,</span>
                    <span class="s3">&quot;admin/popup_response.html&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">{</span>
                    <span class="s3">&quot;popup_response_data&quot;</span><span class="s2">: </span><span class="s1">popup_response_data</span><span class="s2">,</span>
                <span class="s2">},</span>
            <span class="s2">)</span>

        <span class="s1">opts </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span>
        <span class="s1">preserved_filters </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_preserved_filters</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
        <span class="s1">preserved_qsl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_preserved_qsl</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">preserved_filters</span><span class="s2">)</span>

        <span class="s1">msg_dict </span><span class="s2">= {</span>
            <span class="s3">&quot;name&quot;</span><span class="s2">: </span><span class="s1">opts</span><span class="s2">.</span><span class="s1">verbose_name</span><span class="s2">,</span>
            <span class="s3">&quot;obj&quot;</span><span class="s2">: </span><span class="s1">format_html</span><span class="s2">(</span><span class="s3">'&lt;a href=&quot;{}&quot;&gt;{}&lt;/a&gt;'</span><span class="s2">, </span><span class="s1">urlquote</span><span class="s2">(</span><span class="s1">request</span><span class="s2">.</span><span class="s1">path</span><span class="s2">), </span><span class="s1">obj</span><span class="s2">),</span>
        <span class="s2">}</span>
        <span class="s0">if </span><span class="s3">&quot;_continue&quot; </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s1">format_html</span><span class="s2">(</span>
                <span class="s1">_</span><span class="s2">(</span>
                    <span class="s3">&quot;The {name} “{obj}” was changed successfully. You may edit it &quot;</span>
                    <span class="s3">&quot;again below.&quot;</span>
                <span class="s2">),</span>
                <span class="s2">**</span><span class="s1">msg_dict</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">message_user</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">messages</span><span class="s2">.</span><span class="s1">SUCCESS</span><span class="s2">)</span>
            <span class="s1">redirect_url </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">path</span>
            <span class="s1">redirect_url </span><span class="s2">= </span><span class="s1">add_preserved_filters</span><span class="s2">(</span>
                <span class="s2">{</span>
                    <span class="s3">&quot;preserved_filters&quot;</span><span class="s2">: </span><span class="s1">preserved_filters</span><span class="s2">,</span>
                    <span class="s3">&quot;preserved_qsl&quot;</span><span class="s2">: </span><span class="s1">preserved_qsl</span><span class="s2">,</span>
                    <span class="s3">&quot;opts&quot;</span><span class="s2">: </span><span class="s1">opts</span><span class="s2">,</span>
                <span class="s2">},</span>
                <span class="s1">redirect_url</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s0">return </span><span class="s1">HttpResponseRedirect</span><span class="s2">(</span><span class="s1">redirect_url</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s3">&quot;_saveasnew&quot; </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s1">format_html</span><span class="s2">(</span>
                <span class="s1">_</span><span class="s2">(</span>
                    <span class="s3">&quot;The {name} “{obj}” was added successfully. You may edit it again &quot;</span>
                    <span class="s3">&quot;below.&quot;</span>
                <span class="s2">),</span>
                <span class="s2">**</span><span class="s1">msg_dict</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">message_user</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">messages</span><span class="s2">.</span><span class="s1">SUCCESS</span><span class="s2">)</span>
            <span class="s1">redirect_url </span><span class="s2">= </span><span class="s1">reverse</span><span class="s2">(</span>
                <span class="s3">&quot;admin:%s_%s_change&quot; </span><span class="s2">% (</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span><span class="s2">, </span><span class="s1">opts</span><span class="s2">.</span><span class="s1">model_name</span><span class="s2">),</span>
                <span class="s1">args</span><span class="s2">=(</span><span class="s1">obj</span><span class="s2">.</span><span class="s1">pk</span><span class="s2">,),</span>
                <span class="s1">current_app</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">name</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">redirect_url </span><span class="s2">= </span><span class="s1">add_preserved_filters</span><span class="s2">(</span>
                <span class="s2">{</span><span class="s3">&quot;preserved_filters&quot;</span><span class="s2">: </span><span class="s1">preserved_filters</span><span class="s2">, </span><span class="s3">&quot;opts&quot;</span><span class="s2">: </span><span class="s1">opts</span><span class="s2">}, </span><span class="s1">redirect_url</span>
            <span class="s2">)</span>
            <span class="s0">return </span><span class="s1">HttpResponseRedirect</span><span class="s2">(</span><span class="s1">redirect_url</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s3">&quot;_addanother&quot; </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s1">format_html</span><span class="s2">(</span>
                <span class="s1">_</span><span class="s2">(</span>
                    <span class="s3">&quot;The {name} “{obj}” was changed successfully. You may add another &quot;</span>
                    <span class="s3">&quot;{name} below.&quot;</span>
                <span class="s2">),</span>
                <span class="s2">**</span><span class="s1">msg_dict</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">message_user</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">messages</span><span class="s2">.</span><span class="s1">SUCCESS</span><span class="s2">)</span>
            <span class="s1">redirect_url </span><span class="s2">= </span><span class="s1">reverse</span><span class="s2">(</span>
                <span class="s3">&quot;admin:%s_%s_add&quot; </span><span class="s2">% (</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span><span class="s2">, </span><span class="s1">opts</span><span class="s2">.</span><span class="s1">model_name</span><span class="s2">),</span>
                <span class="s1">current_app</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">name</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">redirect_url </span><span class="s2">= </span><span class="s1">add_preserved_filters</span><span class="s2">(</span>
                <span class="s2">{</span>
                    <span class="s3">&quot;preserved_filters&quot;</span><span class="s2">: </span><span class="s1">preserved_filters</span><span class="s2">,</span>
                    <span class="s3">&quot;preserved_qsl&quot;</span><span class="s2">: </span><span class="s1">preserved_qsl</span><span class="s2">,</span>
                    <span class="s3">&quot;opts&quot;</span><span class="s2">: </span><span class="s1">opts</span><span class="s2">,</span>
                <span class="s2">},</span>
                <span class="s1">redirect_url</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s0">return </span><span class="s1">HttpResponseRedirect</span><span class="s2">(</span><span class="s1">redirect_url</span><span class="s2">)</span>

        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s1">format_html</span><span class="s2">(</span>
                <span class="s1">_</span><span class="s2">(</span><span class="s3">&quot;The {name} “{obj}” was changed successfully.&quot;</span><span class="s2">), **</span><span class="s1">msg_dict</span>
            <span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">message_user</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">messages</span><span class="s2">.</span><span class="s1">SUCCESS</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">response_post_save_change</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_response_post_save</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_view_or_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
            <span class="s1">post_url </span><span class="s2">= </span><span class="s1">reverse</span><span class="s2">(</span>
                <span class="s3">&quot;admin:%s_%s_changelist&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">model_name</span><span class="s2">),</span>
                <span class="s1">current_app</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">name</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">preserved_filters </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_preserved_filters</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
            <span class="s1">post_url </span><span class="s2">= </span><span class="s1">add_preserved_filters</span><span class="s2">(</span>
                <span class="s2">{</span><span class="s3">&quot;preserved_filters&quot;</span><span class="s2">: </span><span class="s1">preserved_filters</span><span class="s2">, </span><span class="s3">&quot;opts&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">}, </span><span class="s1">post_url</span>
            <span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">post_url </span><span class="s2">= </span><span class="s1">reverse</span><span class="s2">(</span><span class="s3">&quot;admin:index&quot;</span><span class="s2">, </span><span class="s1">current_app</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">HttpResponseRedirect</span><span class="s2">(</span><span class="s1">post_url</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">response_post_save_add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Figure out where to redirect after the 'Save' button has been pressed 
        when adding a new object. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_response_post_save</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">response_post_save_change</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Figure out where to redirect after the 'Save' button has been pressed 
        when editing an existing object. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_response_post_save</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">response_action</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">queryset</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Handle an admin action. This is called if a request is POSTed to the 
        changelist; it returns an HttpResponse if the action was handled, and 
        None otherwise. 
        &quot;&quot;&quot;</span>

        <span class="s5"># There can be multiple action forms on the page (at the top</span>
        <span class="s5"># and bottom of the change list, for example). Get the action</span>
        <span class="s5"># whose button was pushed.</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">action_index </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
        <span class="s0">except </span><span class="s1">ValueError</span><span class="s2">:</span>
            <span class="s1">action_index </span><span class="s2">= </span><span class="s4">0</span>

        <span class="s5"># Construct the action form.</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">data</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">helpers</span><span class="s2">.</span><span class="s1">ACTION_CHECKBOX_NAME</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">data</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

        <span class="s5"># Use the action whose button was pushed</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">data</span><span class="s2">.</span><span class="s1">update</span><span class="s2">({</span><span class="s3">&quot;action&quot;</span><span class="s2">: </span><span class="s1">data</span><span class="s2">.</span><span class="s1">getlist</span><span class="s2">(</span><span class="s3">&quot;action&quot;</span><span class="s2">)[</span><span class="s1">action_index</span><span class="s2">]})</span>
        <span class="s0">except </span><span class="s1">IndexError</span><span class="s2">:</span>
            <span class="s5"># If we didn't get an action from the chosen form that's invalid</span>
            <span class="s5"># POST data, so by deleting action it'll fail the validation check</span>
            <span class="s5"># below. So no need to do anything here</span>
            <span class="s0">pass</span>

        <span class="s1">action_form </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">action_form</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">auto_id</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">action_form</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">[</span><span class="s3">&quot;action&quot;</span><span class="s2">].</span><span class="s1">choices </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_action_choices</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>

        <span class="s5"># If the form's valid we can handle the action.</span>
        <span class="s0">if </span><span class="s1">action_form</span><span class="s2">.</span><span class="s1">is_valid</span><span class="s2">():</span>
            <span class="s1">action </span><span class="s2">= </span><span class="s1">action_form</span><span class="s2">.</span><span class="s1">cleaned_data</span><span class="s2">[</span><span class="s3">&quot;action&quot;</span><span class="s2">]</span>
            <span class="s1">select_across </span><span class="s2">= </span><span class="s1">action_form</span><span class="s2">.</span><span class="s1">cleaned_data</span><span class="s2">[</span><span class="s3">&quot;select_across&quot;</span><span class="s2">]</span>
            <span class="s1">func </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_actions</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)[</span><span class="s1">action</span><span class="s2">][</span><span class="s4">0</span><span class="s2">]</span>

            <span class="s5"># Get the list of selected PKs. If nothing's selected, we can't</span>
            <span class="s5"># perform an action on it, so bail. Except we want to perform</span>
            <span class="s5"># the action explicitly on all objects.</span>
            <span class="s1">selected </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span><span class="s2">.</span><span class="s1">getlist</span><span class="s2">(</span><span class="s1">helpers</span><span class="s2">.</span><span class="s1">ACTION_CHECKBOX_NAME</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">selected </span><span class="s0">and not </span><span class="s1">select_across</span><span class="s2">:</span>
                <span class="s5"># Reminder that something needs to be selected or nothing will happen</span>
                <span class="s1">msg </span><span class="s2">= </span><span class="s1">_</span><span class="s2">(</span>
                    <span class="s3">&quot;Items must be selected in order to perform &quot;</span>
                    <span class="s3">&quot;actions on them. No items have been changed.&quot;</span>
                <span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">message_user</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">messages</span><span class="s2">.</span><span class="s1">WARNING</span><span class="s2">)</span>
                <span class="s0">return None</span>

            <span class="s0">if not </span><span class="s1">select_across</span><span class="s2">:</span>
                <span class="s5"># Perform the action only on the selected objects</span>
                <span class="s1">queryset </span><span class="s2">= </span><span class="s1">queryset</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">pk__in</span><span class="s2">=</span><span class="s1">selected</span><span class="s2">)</span>

            <span class="s1">response </span><span class="s2">= </span><span class="s1">func</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">queryset</span><span class="s2">)</span>

            <span class="s5"># Actions may return an HttpResponse-like object, which will be</span>
            <span class="s5"># used as the response from the POST. If not, we'll be a good</span>
            <span class="s5"># little HTTP citizen and redirect back to the changelist page.</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">response</span><span class="s2">, </span><span class="s1">HttpResponseBase</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">response</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">HttpResponseRedirect</span><span class="s2">(</span><span class="s1">request</span><span class="s2">.</span><span class="s1">get_full_path</span><span class="s2">())</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s1">_</span><span class="s2">(</span><span class="s3">&quot;No action selected.&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">message_user</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">messages</span><span class="s2">.</span><span class="s1">WARNING</span><span class="s2">)</span>
            <span class="s0">return None</span>

    <span class="s0">def </span><span class="s1">response_delete</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj_display</span><span class="s2">, </span><span class="s1">obj_id</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Determine the HttpResponse for the delete_view stage. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">IS_POPUP_VAR </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span><span class="s2">:</span>
            <span class="s1">popup_response_data </span><span class="s2">= </span><span class="s1">json</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span>
                <span class="s2">{</span>
                    <span class="s3">&quot;action&quot;</span><span class="s2">: </span><span class="s3">&quot;delete&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;value&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">obj_id</span><span class="s2">),</span>
                <span class="s2">}</span>
            <span class="s2">)</span>
            <span class="s0">return </span><span class="s1">TemplateResponse</span><span class="s2">(</span>
                <span class="s1">request</span><span class="s2">,</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">popup_response_template</span>
                <span class="s0">or </span><span class="s2">[</span>
                    <span class="s3">&quot;admin/%s/%s/popup_response.html&quot;</span>
                    <span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">model_name</span><span class="s2">),</span>
                    <span class="s3">&quot;admin/%s/popup_response.html&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span><span class="s2">,</span>
                    <span class="s3">&quot;admin/popup_response.html&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">{</span>
                    <span class="s3">&quot;popup_response_data&quot;</span><span class="s2">: </span><span class="s1">popup_response_data</span><span class="s2">,</span>
                <span class="s2">},</span>
            <span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">message_user</span><span class="s2">(</span>
            <span class="s1">request</span><span class="s2">,</span>
            <span class="s1">_</span><span class="s2">(</span><span class="s3">&quot;The %(name)s “%(obj)s” was deleted successfully.&quot;</span><span class="s2">)</span>
            <span class="s2">% {</span>
                <span class="s3">&quot;name&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">verbose_name</span><span class="s2">,</span>
                <span class="s3">&quot;obj&quot;</span><span class="s2">: </span><span class="s1">obj_display</span><span class="s2">,</span>
            <span class="s2">},</span>
            <span class="s1">messages</span><span class="s2">.</span><span class="s1">SUCCESS</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s0">None</span><span class="s2">):</span>
            <span class="s1">post_url </span><span class="s2">= </span><span class="s1">reverse</span><span class="s2">(</span>
                <span class="s3">&quot;admin:%s_%s_changelist&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">model_name</span><span class="s2">),</span>
                <span class="s1">current_app</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">name</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">preserved_filters </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_preserved_filters</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
            <span class="s1">post_url </span><span class="s2">= </span><span class="s1">add_preserved_filters</span><span class="s2">(</span>
                <span class="s2">{</span><span class="s3">&quot;preserved_filters&quot;</span><span class="s2">: </span><span class="s1">preserved_filters</span><span class="s2">, </span><span class="s3">&quot;opts&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">}, </span><span class="s1">post_url</span>
            <span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">post_url </span><span class="s2">= </span><span class="s1">reverse</span><span class="s2">(</span><span class="s3">&quot;admin:index&quot;</span><span class="s2">, </span><span class="s1">current_app</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">HttpResponseRedirect</span><span class="s2">(</span><span class="s1">post_url</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">render_delete_form</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">context</span><span class="s2">):</span>
        <span class="s1">app_label </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span>

        <span class="s1">request</span><span class="s2">.</span><span class="s1">current_app </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">name</span>
        <span class="s1">context</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span>
            <span class="s1">to_field_var</span><span class="s2">=</span><span class="s1">TO_FIELD_VAR</span><span class="s2">,</span>
            <span class="s1">is_popup_var</span><span class="s2">=</span><span class="s1">IS_POPUP_VAR</span><span class="s2">,</span>
            <span class="s1">media</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">media</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s0">return </span><span class="s1">TemplateResponse</span><span class="s2">(</span>
            <span class="s1">request</span><span class="s2">,</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">delete_confirmation_template</span>
            <span class="s0">or </span><span class="s2">[</span>
                <span class="s3">&quot;admin/{}/{}/delete_confirmation.html&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span>
                    <span class="s1">app_label</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">model_name</span>
                <span class="s2">),</span>
                <span class="s3">&quot;admin/{}/delete_confirmation.html&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">app_label</span><span class="s2">),</span>
                <span class="s3">&quot;admin/delete_confirmation.html&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s1">context</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_inline_formsets</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">formsets</span><span class="s2">, </span><span class="s1">inline_instances</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s5"># Edit permissions on parent model are required for editable inlines.</span>
        <span class="s1">can_edit_parent </span><span class="s2">= (</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">has_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">obj</span>
            <span class="s0">else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_add_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s1">inline_admin_formsets </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">inline</span><span class="s2">, </span><span class="s1">formset </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">inline_instances</span><span class="s2">, </span><span class="s1">formsets</span><span class="s2">):</span>
            <span class="s1">fieldsets </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">inline</span><span class="s2">.</span><span class="s1">get_fieldsets</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">))</span>
            <span class="s1">readonly </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">inline</span><span class="s2">.</span><span class="s1">get_readonly_fields</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">))</span>
            <span class="s0">if </span><span class="s1">can_edit_parent</span><span class="s2">:</span>
                <span class="s1">has_add_permission </span><span class="s2">= </span><span class="s1">inline</span><span class="s2">.</span><span class="s1">has_add_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>
                <span class="s1">has_change_permission </span><span class="s2">= </span><span class="s1">inline</span><span class="s2">.</span><span class="s1">has_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>
                <span class="s1">has_delete_permission </span><span class="s2">= </span><span class="s1">inline</span><span class="s2">.</span><span class="s1">has_delete_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s5"># Disable all edit-permissions, and override formset settings.</span>
                <span class="s1">has_add_permission </span><span class="s2">= </span><span class="s1">has_change_permission </span><span class="s2">= </span><span class="s1">has_delete_permission </span><span class="s2">= (</span>
                    <span class="s0">False</span>
                <span class="s2">)</span>
                <span class="s1">formset</span><span class="s2">.</span><span class="s1">extra </span><span class="s2">= </span><span class="s1">formset</span><span class="s2">.</span><span class="s1">max_num </span><span class="s2">= </span><span class="s4">0</span>
            <span class="s1">has_view_permission </span><span class="s2">= </span><span class="s1">inline</span><span class="s2">.</span><span class="s1">has_view_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>
            <span class="s1">prepopulated </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">inline</span><span class="s2">.</span><span class="s1">get_prepopulated_fields</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">))</span>
            <span class="s1">inline_admin_formset </span><span class="s2">= </span><span class="s1">helpers</span><span class="s2">.</span><span class="s1">InlineAdminFormSet</span><span class="s2">(</span>
                <span class="s1">inline</span><span class="s2">,</span>
                <span class="s1">formset</span><span class="s2">,</span>
                <span class="s1">fieldsets</span><span class="s2">,</span>
                <span class="s1">prepopulated</span><span class="s2">,</span>
                <span class="s1">readonly</span><span class="s2">,</span>
                <span class="s1">model_admin</span><span class="s2">=</span><span class="s1">self</span><span class="s2">,</span>
                <span class="s1">has_add_permission</span><span class="s2">=</span><span class="s1">has_add_permission</span><span class="s2">,</span>
                <span class="s1">has_change_permission</span><span class="s2">=</span><span class="s1">has_change_permission</span><span class="s2">,</span>
                <span class="s1">has_delete_permission</span><span class="s2">=</span><span class="s1">has_delete_permission</span><span class="s2">,</span>
                <span class="s1">has_view_permission</span><span class="s2">=</span><span class="s1">has_view_permission</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">inline_admin_formsets</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">inline_admin_formset</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">inline_admin_formsets</span>

    <span class="s0">def </span><span class="s1">get_changeform_initial_data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Get the initial form data from the request's GET params. 
        &quot;&quot;&quot;</span>
        <span class="s1">initial </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">request</span><span class="s2">.</span><span class="s1">GET</span><span class="s2">.</span><span class="s1">items</span><span class="s2">())</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">initial</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">f </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">get_field</span><span class="s2">(</span><span class="s1">k</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">FieldDoesNotExist</span><span class="s2">:</span>
                <span class="s0">continue</span>
            <span class="s5"># We have to special-case M2Ms as a list of comma-separated PKs.</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">models</span><span class="s2">.</span><span class="s1">ManyToManyField</span><span class="s2">):</span>
                <span class="s1">initial</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] = </span><span class="s1">initial</span><span class="s2">[</span><span class="s1">k</span><span class="s2">].</span><span class="s1">split</span><span class="s2">(</span><span class="s3">&quot;,&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">initial</span>

    <span class="s0">def </span><span class="s1">_get_obj_does_not_exist_redirect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">opts</span><span class="s2">, </span><span class="s1">object_id</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Create a message informing the user that the object doesn't exist 
        and return a redirect to the admin index page. 
        &quot;&quot;&quot;</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s1">_</span><span class="s2">(</span><span class="s3">&quot;%(name)s with ID “%(key)s” doesn’t exist. Perhaps it was deleted?&quot;</span><span class="s2">) % {</span>
            <span class="s3">&quot;name&quot;</span><span class="s2">: </span><span class="s1">opts</span><span class="s2">.</span><span class="s1">verbose_name</span><span class="s2">,</span>
            <span class="s3">&quot;key&quot;</span><span class="s2">: </span><span class="s1">unquote</span><span class="s2">(</span><span class="s1">object_id</span><span class="s2">),</span>
        <span class="s2">}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">message_user</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">messages</span><span class="s2">.</span><span class="s1">WARNING</span><span class="s2">)</span>
        <span class="s1">url </span><span class="s2">= </span><span class="s1">reverse</span><span class="s2">(</span><span class="s3">&quot;admin:index&quot;</span><span class="s2">, </span><span class="s1">current_app</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">HttpResponseRedirect</span><span class="s2">(</span><span class="s1">url</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">csrf_protect_m</span>
    <span class="s0">def </span><span class="s1">changeform_view</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">object_id</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">form_url</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">extra_context</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">transaction</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">(</span><span class="s1">using</span><span class="s2">=</span><span class="s1">router</span><span class="s2">.</span><span class="s1">db_for_write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">)):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_changeform_view</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">object_id</span><span class="s2">, </span><span class="s1">form_url</span><span class="s2">, </span><span class="s1">extra_context</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_changeform_view</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">object_id</span><span class="s2">, </span><span class="s1">form_url</span><span class="s2">, </span><span class="s1">extra_context</span><span class="s2">):</span>
        <span class="s1">to_field </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">TO_FIELD_VAR</span><span class="s2">, </span><span class="s1">request</span><span class="s2">.</span><span class="s1">GET</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">TO_FIELD_VAR</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">to_field </span><span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">to_field_allowed</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">to_field</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">DisallowedModelAdminToField</span><span class="s2">(</span>
                <span class="s3">&quot;The field %s cannot be referenced.&quot; </span><span class="s2">% </span><span class="s1">to_field</span>
            <span class="s2">)</span>

        <span class="s0">if </span><span class="s1">request</span><span class="s2">.</span><span class="s1">method </span><span class="s2">== </span><span class="s3">&quot;POST&quot; </span><span class="s0">and </span><span class="s3">&quot;_saveasnew&quot; </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span><span class="s2">:</span>
            <span class="s1">object_id </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s1">add </span><span class="s2">= </span><span class="s1">object_id </span><span class="s0">is None</span>

        <span class="s0">if </span><span class="s1">add</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_add_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
                <span class="s0">raise </span><span class="s1">PermissionDenied</span>
            <span class="s1">obj </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">obj </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_object</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">unquote</span><span class="s2">(</span><span class="s1">object_id</span><span class="s2">), </span><span class="s1">to_field</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">request</span><span class="s2">.</span><span class="s1">method </span><span class="s2">== </span><span class="s3">&quot;POST&quot;</span><span class="s2">:</span>
                <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
                    <span class="s0">raise </span><span class="s1">PermissionDenied</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_view_or_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
                    <span class="s0">raise </span><span class="s1">PermissionDenied</span>

            <span class="s0">if </span><span class="s1">obj </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_obj_does_not_exist_redirect</span><span class="s2">(</span>
                    <span class="s1">request</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">, </span><span class="s1">object_id</span>
                <span class="s2">)</span>

        <span class="s1">fieldsets </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_fieldsets</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s1">ModelForm </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_form</span><span class="s2">(</span>
            <span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">change</span><span class="s2">=</span><span class="s0">not </span><span class="s1">add</span><span class="s2">, </span><span class="s1">fields</span><span class="s2">=</span><span class="s1">flatten_fieldsets</span><span class="s2">(</span><span class="s1">fieldsets</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s0">if </span><span class="s1">request</span><span class="s2">.</span><span class="s1">method </span><span class="s2">== </span><span class="s3">&quot;POST&quot;</span><span class="s2">:</span>
            <span class="s1">form </span><span class="s2">= </span><span class="s1">ModelForm</span><span class="s2">(</span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span><span class="s2">, </span><span class="s1">request</span><span class="s2">.</span><span class="s1">FILES</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">=</span><span class="s1">obj</span><span class="s2">)</span>
            <span class="s1">formsets</span><span class="s2">, </span><span class="s1">inline_instances </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_formsets</span><span class="s2">(</span>
                <span class="s1">request</span><span class="s2">,</span>
                <span class="s1">form</span><span class="s2">.</span><span class="s1">instance</span><span class="s2">,</span>
                <span class="s1">change</span><span class="s2">=</span><span class="s0">not </span><span class="s1">add</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">form_validated </span><span class="s2">= </span><span class="s1">form</span><span class="s2">.</span><span class="s1">is_valid</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">form_validated</span><span class="s2">:</span>
                <span class="s1">new_object </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">save_form</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">form</span><span class="s2">, </span><span class="s1">change</span><span class="s2">=</span><span class="s0">not </span><span class="s1">add</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">new_object </span><span class="s2">= </span><span class="s1">form</span><span class="s2">.</span><span class="s1">instance</span>
            <span class="s0">if </span><span class="s1">all_valid</span><span class="s2">(</span><span class="s1">formsets</span><span class="s2">) </span><span class="s0">and </span><span class="s1">form_validated</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">save_model</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">new_object</span><span class="s2">, </span><span class="s1">form</span><span class="s2">, </span><span class="s0">not </span><span class="s1">add</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">save_related</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">form</span><span class="s2">, </span><span class="s1">formsets</span><span class="s2">, </span><span class="s0">not </span><span class="s1">add</span><span class="s2">)</span>
                <span class="s1">change_message </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">construct_change_message</span><span class="s2">(</span>
                    <span class="s1">request</span><span class="s2">, </span><span class="s1">form</span><span class="s2">, </span><span class="s1">formsets</span><span class="s2">, </span><span class="s1">add</span>
                <span class="s2">)</span>
                <span class="s0">if </span><span class="s1">add</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">log_addition</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">new_object</span><span class="s2">, </span><span class="s1">change_message</span><span class="s2">)</span>
                    <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">response_add</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">new_object</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">log_change</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">new_object</span><span class="s2">, </span><span class="s1">change_message</span><span class="s2">)</span>
                    <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">response_change</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">new_object</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">form_validated </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">add</span><span class="s2">:</span>
                <span class="s1">initial </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_changeform_initial_data</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
                <span class="s1">form </span><span class="s2">= </span><span class="s1">ModelForm</span><span class="s2">(</span><span class="s1">initial</span><span class="s2">=</span><span class="s1">initial</span><span class="s2">)</span>
                <span class="s1">formsets</span><span class="s2">, </span><span class="s1">inline_instances </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_formsets</span><span class="s2">(</span>
                    <span class="s1">request</span><span class="s2">, </span><span class="s1">form</span><span class="s2">.</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">change</span><span class="s2">=</span><span class="s0">False</span>
                <span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">form </span><span class="s2">= </span><span class="s1">ModelForm</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">=</span><span class="s1">obj</span><span class="s2">)</span>
                <span class="s1">formsets</span><span class="s2">, </span><span class="s1">inline_instances </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_formsets</span><span class="s2">(</span>
                    <span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">change</span><span class="s2">=</span><span class="s0">True</span>
                <span class="s2">)</span>

        <span class="s0">if not </span><span class="s1">add </span><span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
            <span class="s1">readonly_fields </span><span class="s2">= </span><span class="s1">flatten_fieldsets</span><span class="s2">(</span><span class="s1">fieldsets</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">readonly_fields </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_readonly_fields</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s1">admin_form </span><span class="s2">= </span><span class="s1">helpers</span><span class="s2">.</span><span class="s1">AdminForm</span><span class="s2">(</span>
            <span class="s1">form</span><span class="s2">,</span>
            <span class="s1">list</span><span class="s2">(</span><span class="s1">fieldsets</span><span class="s2">),</span>
            <span class="s5"># Clear prepopulated fields on a view-only form to avoid a crash.</span>
            <span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">get_prepopulated_fields</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">add </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>
                <span class="s0">else </span><span class="s2">{}</span>
            <span class="s2">),</span>
            <span class="s1">readonly_fields</span><span class="s2">,</span>
            <span class="s1">model_admin</span><span class="s2">=</span><span class="s1">self</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">media </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">media </span><span class="s2">+ </span><span class="s1">admin_form</span><span class="s2">.</span><span class="s1">media</span>

        <span class="s1">inline_formsets </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_inline_formsets</span><span class="s2">(</span>
            <span class="s1">request</span><span class="s2">, </span><span class="s1">formsets</span><span class="s2">, </span><span class="s1">inline_instances</span><span class="s2">, </span><span class="s1">obj</span>
        <span class="s2">)</span>
        <span class="s0">for </span><span class="s1">inline_formset </span><span class="s0">in </span><span class="s1">inline_formsets</span><span class="s2">:</span>
            <span class="s1">media </span><span class="s2">+= </span><span class="s1">inline_formset</span><span class="s2">.</span><span class="s1">media</span>

        <span class="s0">if </span><span class="s1">add</span><span class="s2">:</span>
            <span class="s1">title </span><span class="s2">= </span><span class="s1">_</span><span class="s2">(</span><span class="s3">&quot;Add %s&quot;</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
            <span class="s1">title </span><span class="s2">= </span><span class="s1">_</span><span class="s2">(</span><span class="s3">&quot;Change %s&quot;</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">title </span><span class="s2">= </span><span class="s1">_</span><span class="s2">(</span><span class="s3">&quot;View %s&quot;</span><span class="s2">)</span>
        <span class="s1">context </span><span class="s2">= {</span>
            <span class="s2">**</span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">each_context</span><span class="s2">(</span><span class="s1">request</span><span class="s2">),</span>
            <span class="s3">&quot;title&quot;</span><span class="s2">: </span><span class="s1">title </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">verbose_name</span><span class="s2">,</span>
            <span class="s3">&quot;subtitle&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">) </span><span class="s0">if </span><span class="s1">obj </span><span class="s0">else None</span><span class="s2">,</span>
            <span class="s3">&quot;adminform&quot;</span><span class="s2">: </span><span class="s1">admin_form</span><span class="s2">,</span>
            <span class="s3">&quot;object_id&quot;</span><span class="s2">: </span><span class="s1">object_id</span><span class="s2">,</span>
            <span class="s3">&quot;original&quot;</span><span class="s2">: </span><span class="s1">obj</span><span class="s2">,</span>
            <span class="s3">&quot;is_popup&quot;</span><span class="s2">: </span><span class="s1">IS_POPUP_VAR </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST </span><span class="s0">or </span><span class="s1">IS_POPUP_VAR </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">GET</span><span class="s2">,</span>
            <span class="s3">&quot;to_field&quot;</span><span class="s2">: </span><span class="s1">to_field</span><span class="s2">,</span>
            <span class="s3">&quot;media&quot;</span><span class="s2">: </span><span class="s1">media</span><span class="s2">,</span>
            <span class="s3">&quot;inline_admin_formsets&quot;</span><span class="s2">: </span><span class="s1">inline_formsets</span><span class="s2">,</span>
            <span class="s3">&quot;errors&quot;</span><span class="s2">: </span><span class="s1">helpers</span><span class="s2">.</span><span class="s1">AdminErrorList</span><span class="s2">(</span><span class="s1">form</span><span class="s2">, </span><span class="s1">formsets</span><span class="s2">),</span>
            <span class="s3">&quot;preserved_filters&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_preserved_filters</span><span class="s2">(</span><span class="s1">request</span><span class="s2">),</span>
        <span class="s2">}</span>

        <span class="s5"># Hide the &quot;Save&quot; and &quot;Save and continue&quot; buttons if &quot;Save as New&quot; was</span>
        <span class="s5"># previously chosen to prevent the interface from getting confusing.</span>
        <span class="s0">if </span><span class="s2">(</span>
            <span class="s1">request</span><span class="s2">.</span><span class="s1">method </span><span class="s2">== </span><span class="s3">&quot;POST&quot;</span>
            <span class="s0">and not </span><span class="s1">form_validated</span>
            <span class="s0">and </span><span class="s3">&quot;_saveasnew&quot; </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span>
        <span class="s2">):</span>
            <span class="s1">context</span><span class="s2">[</span><span class="s3">&quot;show_save&quot;</span><span class="s2">] = </span><span class="s0">False</span>
            <span class="s1">context</span><span class="s2">[</span><span class="s3">&quot;show_save_and_continue&quot;</span><span class="s2">] = </span><span class="s0">False</span>
            <span class="s5"># Use the change template instead of the add template.</span>
            <span class="s1">add </span><span class="s2">= </span><span class="s0">False</span>

        <span class="s1">context</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">extra_context </span><span class="s0">or </span><span class="s2">{})</span>

        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">render_change_form</span><span class="s2">(</span>
            <span class="s1">request</span><span class="s2">, </span><span class="s1">context</span><span class="s2">, </span><span class="s1">add</span><span class="s2">=</span><span class="s1">add</span><span class="s2">, </span><span class="s1">change</span><span class="s2">=</span><span class="s0">not </span><span class="s1">add</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">form_url</span><span class="s2">=</span><span class="s1">form_url</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">add_view</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">form_url</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">extra_context</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">changeform_view</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">form_url</span><span class="s2">, </span><span class="s1">extra_context</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">change_view</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">object_id</span><span class="s2">, </span><span class="s1">form_url</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">extra_context</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">changeform_view</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">object_id</span><span class="s2">, </span><span class="s1">form_url</span><span class="s2">, </span><span class="s1">extra_context</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_get_edited_object_pks</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Return POST data values of list_editable primary keys.&quot;&quot;&quot;</span>
        <span class="s1">pk_pattern </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span>
            <span class="s3">r&quot;{}-\d+-{}$&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">prefix</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">pk</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">value </span><span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span><span class="s2">.</span><span class="s1">items</span><span class="s2">() </span><span class="s0">if </span><span class="s1">pk_pattern</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)]</span>

    <span class="s0">def </span><span class="s1">_get_list_editable_queryset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Based on POST data, return a queryset of the objects that were edited 
        via list_editable. 
        &quot;&quot;&quot;</span>
        <span class="s1">object_pks </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_edited_object_pks</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">)</span>
        <span class="s1">queryset </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_queryset</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
        <span class="s1">validate </span><span class="s2">= </span><span class="s1">queryset</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">pk</span><span class="s2">.</span><span class="s1">to_python</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">pk </span><span class="s0">in </span><span class="s1">object_pks</span><span class="s2">:</span>
                <span class="s1">validate</span><span class="s2">(</span><span class="s1">pk</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">ValidationError</span><span class="s2">:</span>
            <span class="s5"># Disable the optimization if the POST data was tampered with.</span>
            <span class="s0">return </span><span class="s1">queryset</span>
        <span class="s0">return </span><span class="s1">queryset</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">pk__in</span><span class="s2">=</span><span class="s1">object_pks</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">csrf_protect_m</span>
    <span class="s0">def </span><span class="s1">changelist_view</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">extra_context</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        The 'change list' admin view for this model. 
        &quot;&quot;&quot;</span>
        <span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">contrib</span><span class="s2">.</span><span class="s1">admin</span><span class="s2">.</span><span class="s1">views</span><span class="s2">.</span><span class="s1">main </span><span class="s0">import </span><span class="s1">ERROR_FLAG</span>

        <span class="s1">app_label </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_view_or_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">PermissionDenied</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">cl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_changelist_instance</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">IncorrectLookupParameters</span><span class="s2">:</span>
            <span class="s5"># Wacky lookup parameters were given, so redirect to the main</span>
            <span class="s5"># changelist page, without parameters, and pass an 'invalid=1'</span>
            <span class="s5"># parameter via the query string. If wacky parameters were given</span>
            <span class="s5"># and the 'invalid=1' parameter was already in the query string,</span>
            <span class="s5"># something is screwed up with the database, so display an error</span>
            <span class="s5"># page.</span>
            <span class="s0">if </span><span class="s1">ERROR_FLAG </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">GET</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">SimpleTemplateResponse</span><span class="s2">(</span>
                    <span class="s3">&quot;admin/invalid_setup.html&quot;</span><span class="s2">,</span>
                    <span class="s2">{</span>
                        <span class="s3">&quot;title&quot;</span><span class="s2">: </span><span class="s1">_</span><span class="s2">(</span><span class="s3">&quot;Database error&quot;</span><span class="s2">),</span>
                    <span class="s2">},</span>
                <span class="s2">)</span>
            <span class="s0">return </span><span class="s1">HttpResponseRedirect</span><span class="s2">(</span><span class="s1">request</span><span class="s2">.</span><span class="s1">path </span><span class="s2">+ </span><span class="s3">&quot;?&quot; </span><span class="s2">+ </span><span class="s1">ERROR_FLAG </span><span class="s2">+ </span><span class="s3">&quot;=1&quot;</span><span class="s2">)</span>

        <span class="s5"># If the request was POSTed, this might be a bulk action or a bulk</span>
        <span class="s5"># edit. Try to look up an action or confirmation first, but if this</span>
        <span class="s5"># isn't an action the POST will fall through to the bulk edit check,</span>
        <span class="s5"># below.</span>
        <span class="s1">action_failed </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">selected </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span><span class="s2">.</span><span class="s1">getlist</span><span class="s2">(</span><span class="s1">helpers</span><span class="s2">.</span><span class="s1">ACTION_CHECKBOX_NAME</span><span class="s2">)</span>

        <span class="s1">actions </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_actions</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
        <span class="s5"># Actions with no confirmation</span>
        <span class="s0">if </span><span class="s2">(</span>
            <span class="s1">actions</span>
            <span class="s0">and </span><span class="s1">request</span><span class="s2">.</span><span class="s1">method </span><span class="s2">== </span><span class="s3">&quot;POST&quot;</span>
            <span class="s0">and </span><span class="s3">&quot;index&quot; </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span>
            <span class="s0">and </span><span class="s3">&quot;_save&quot; </span><span class="s0">not in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span>
        <span class="s2">):</span>
            <span class="s0">if </span><span class="s1">selected</span><span class="s2">:</span>
                <span class="s1">response </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">response_action</span><span class="s2">(</span>
                    <span class="s1">request</span><span class="s2">, </span><span class="s1">queryset</span><span class="s2">=</span><span class="s1">cl</span><span class="s2">.</span><span class="s1">get_queryset</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
                <span class="s2">)</span>
                <span class="s0">if </span><span class="s1">response</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">response</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">action_failed </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">msg </span><span class="s2">= </span><span class="s1">_</span><span class="s2">(</span>
                    <span class="s3">&quot;Items must be selected in order to perform &quot;</span>
                    <span class="s3">&quot;actions on them. No items have been changed.&quot;</span>
                <span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">message_user</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">messages</span><span class="s2">.</span><span class="s1">WARNING</span><span class="s2">)</span>
                <span class="s1">action_failed </span><span class="s2">= </span><span class="s0">True</span>

        <span class="s5"># Actions with confirmation</span>
        <span class="s0">if </span><span class="s2">(</span>
            <span class="s1">actions</span>
            <span class="s0">and </span><span class="s1">request</span><span class="s2">.</span><span class="s1">method </span><span class="s2">== </span><span class="s3">&quot;POST&quot;</span>
            <span class="s0">and </span><span class="s1">helpers</span><span class="s2">.</span><span class="s1">ACTION_CHECKBOX_NAME </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span>
            <span class="s0">and </span><span class="s3">&quot;index&quot; </span><span class="s0">not in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span>
            <span class="s0">and </span><span class="s3">&quot;_save&quot; </span><span class="s0">not in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span>
        <span class="s2">):</span>
            <span class="s0">if </span><span class="s1">selected</span><span class="s2">:</span>
                <span class="s1">response </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">response_action</span><span class="s2">(</span>
                    <span class="s1">request</span><span class="s2">, </span><span class="s1">queryset</span><span class="s2">=</span><span class="s1">cl</span><span class="s2">.</span><span class="s1">get_queryset</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
                <span class="s2">)</span>
                <span class="s0">if </span><span class="s1">response</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">response</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">action_failed </span><span class="s2">= </span><span class="s0">True</span>

        <span class="s0">if </span><span class="s1">action_failed</span><span class="s2">:</span>
            <span class="s5"># Redirect back to the changelist page to avoid resubmitting the</span>
            <span class="s5"># form if the user refreshes the browser or uses the &quot;No, take</span>
            <span class="s5"># me back&quot; button on the action confirmation page.</span>
            <span class="s0">return </span><span class="s1">HttpResponseRedirect</span><span class="s2">(</span><span class="s1">request</span><span class="s2">.</span><span class="s1">get_full_path</span><span class="s2">())</span>

        <span class="s5"># If we're allowing changelist editing, we need to construct a formset</span>
        <span class="s5"># for the changelist given all the fields to be edited. Then we'll</span>
        <span class="s5"># use the formset to validate/process POSTed data.</span>
        <span class="s1">formset </span><span class="s2">= </span><span class="s1">cl</span><span class="s2">.</span><span class="s1">formset </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s5"># Handle POSTed bulk-edit data.</span>
        <span class="s0">if </span><span class="s1">request</span><span class="s2">.</span><span class="s1">method </span><span class="s2">== </span><span class="s3">&quot;POST&quot; </span><span class="s0">and </span><span class="s1">cl</span><span class="s2">.</span><span class="s1">list_editable </span><span class="s0">and </span><span class="s3">&quot;_save&quot; </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
                <span class="s0">raise </span><span class="s1">PermissionDenied</span>
            <span class="s1">FormSet </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_changelist_formset</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
            <span class="s1">modified_objects </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_list_editable_queryset</span><span class="s2">(</span>
                <span class="s1">request</span><span class="s2">, </span><span class="s1">FormSet</span><span class="s2">.</span><span class="s1">get_default_prefix</span><span class="s2">()</span>
            <span class="s2">)</span>
            <span class="s1">formset </span><span class="s2">= </span><span class="s1">cl</span><span class="s2">.</span><span class="s1">formset </span><span class="s2">= </span><span class="s1">FormSet</span><span class="s2">(</span>
                <span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span><span class="s2">, </span><span class="s1">request</span><span class="s2">.</span><span class="s1">FILES</span><span class="s2">, </span><span class="s1">queryset</span><span class="s2">=</span><span class="s1">modified_objects</span>
            <span class="s2">)</span>
            <span class="s0">if </span><span class="s1">formset</span><span class="s2">.</span><span class="s1">is_valid</span><span class="s2">():</span>
                <span class="s1">changecount </span><span class="s2">= </span><span class="s4">0</span>
                <span class="s0">with </span><span class="s1">transaction</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">(</span><span class="s1">using</span><span class="s2">=</span><span class="s1">router</span><span class="s2">.</span><span class="s1">db_for_write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">)):</span>
                    <span class="s0">for </span><span class="s1">form </span><span class="s0">in </span><span class="s1">formset</span><span class="s2">.</span><span class="s1">forms</span><span class="s2">:</span>
                        <span class="s0">if </span><span class="s1">form</span><span class="s2">.</span><span class="s1">has_changed</span><span class="s2">():</span>
                            <span class="s1">obj </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">save_form</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">form</span><span class="s2">, </span><span class="s1">change</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">save_model</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">form</span><span class="s2">, </span><span class="s1">change</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">save_related</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">form</span><span class="s2">, </span><span class="s1">formsets</span><span class="s2">=[], </span><span class="s1">change</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
                            <span class="s1">change_msg </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">construct_change_message</span><span class="s2">(</span>
                                <span class="s1">request</span><span class="s2">, </span><span class="s1">form</span><span class="s2">, </span><span class="s0">None</span>
                            <span class="s2">)</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">log_change</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">change_msg</span><span class="s2">)</span>
                            <span class="s1">changecount </span><span class="s2">+= </span><span class="s4">1</span>
                <span class="s0">if </span><span class="s1">changecount</span><span class="s2">:</span>
                    <span class="s1">msg </span><span class="s2">= </span><span class="s1">ngettext</span><span class="s2">(</span>
                        <span class="s3">&quot;%(count)s %(name)s was changed successfully.&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;%(count)s %(name)s were changed successfully.&quot;</span><span class="s2">,</span>
                        <span class="s1">changecount</span><span class="s2">,</span>
                    <span class="s2">) % {</span>
                        <span class="s3">&quot;count&quot;</span><span class="s2">: </span><span class="s1">changecount</span><span class="s2">,</span>
                        <span class="s3">&quot;name&quot;</span><span class="s2">: </span><span class="s1">model_ngettext</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">, </span><span class="s1">changecount</span><span class="s2">),</span>
                    <span class="s2">}</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">message_user</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">messages</span><span class="s2">.</span><span class="s1">SUCCESS</span><span class="s2">)</span>

                <span class="s0">return </span><span class="s1">HttpResponseRedirect</span><span class="s2">(</span><span class="s1">request</span><span class="s2">.</span><span class="s1">get_full_path</span><span class="s2">())</span>

        <span class="s5"># Handle GET -- construct a formset for display.</span>
        <span class="s0">elif </span><span class="s1">cl</span><span class="s2">.</span><span class="s1">list_editable </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
            <span class="s1">FormSet </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_changelist_formset</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
            <span class="s1">formset </span><span class="s2">= </span><span class="s1">cl</span><span class="s2">.</span><span class="s1">formset </span><span class="s2">= </span><span class="s1">FormSet</span><span class="s2">(</span><span class="s1">queryset</span><span class="s2">=</span><span class="s1">cl</span><span class="s2">.</span><span class="s1">result_list</span><span class="s2">)</span>

        <span class="s5"># Build the list of media to be used by the formset.</span>
        <span class="s0">if </span><span class="s1">formset</span><span class="s2">:</span>
            <span class="s1">media </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">media </span><span class="s2">+ </span><span class="s1">formset</span><span class="s2">.</span><span class="s1">media</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">media </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">media</span>

        <span class="s5"># Build the action form and populate it with available actions.</span>
        <span class="s0">if </span><span class="s1">actions</span><span class="s2">:</span>
            <span class="s1">action_form </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">action_form</span><span class="s2">(</span><span class="s1">auto_id</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
            <span class="s1">action_form</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">[</span><span class="s3">&quot;action&quot;</span><span class="s2">].</span><span class="s1">choices </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_action_choices</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
            <span class="s1">media </span><span class="s2">+= </span><span class="s1">action_form</span><span class="s2">.</span><span class="s1">media</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">action_form </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s1">selection_note_all </span><span class="s2">= </span><span class="s1">ngettext</span><span class="s2">(</span>
            <span class="s3">&quot;%(total_count)s selected&quot;</span><span class="s2">, </span><span class="s3">&quot;All %(total_count)s selected&quot;</span><span class="s2">, </span><span class="s1">cl</span><span class="s2">.</span><span class="s1">result_count</span>
        <span class="s2">)</span>

        <span class="s1">context </span><span class="s2">= {</span>
            <span class="s2">**</span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">each_context</span><span class="s2">(</span><span class="s1">request</span><span class="s2">),</span>
            <span class="s3">&quot;module_name&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">verbose_name_plural</span><span class="s2">),</span>
            <span class="s3">&quot;selection_note&quot;</span><span class="s2">: </span><span class="s1">_</span><span class="s2">(</span><span class="s3">&quot;0 of %(cnt)s selected&quot;</span><span class="s2">) % {</span><span class="s3">&quot;cnt&quot;</span><span class="s2">: </span><span class="s1">len</span><span class="s2">(</span><span class="s1">cl</span><span class="s2">.</span><span class="s1">result_list</span><span class="s2">)},</span>
            <span class="s3">&quot;selection_note_all&quot;</span><span class="s2">: </span><span class="s1">selection_note_all </span><span class="s2">% {</span><span class="s3">&quot;total_count&quot;</span><span class="s2">: </span><span class="s1">cl</span><span class="s2">.</span><span class="s1">result_count</span><span class="s2">},</span>
            <span class="s3">&quot;title&quot;</span><span class="s2">: </span><span class="s1">cl</span><span class="s2">.</span><span class="s1">title</span><span class="s2">,</span>
            <span class="s3">&quot;subtitle&quot;</span><span class="s2">: </span><span class="s0">None</span><span class="s2">,</span>
            <span class="s3">&quot;is_popup&quot;</span><span class="s2">: </span><span class="s1">cl</span><span class="s2">.</span><span class="s1">is_popup</span><span class="s2">,</span>
            <span class="s3">&quot;to_field&quot;</span><span class="s2">: </span><span class="s1">cl</span><span class="s2">.</span><span class="s1">to_field</span><span class="s2">,</span>
            <span class="s3">&quot;cl&quot;</span><span class="s2">: </span><span class="s1">cl</span><span class="s2">,</span>
            <span class="s3">&quot;media&quot;</span><span class="s2">: </span><span class="s1">media</span><span class="s2">,</span>
            <span class="s3">&quot;has_add_permission&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_add_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">),</span>
            <span class="s3">&quot;opts&quot;</span><span class="s2">: </span><span class="s1">cl</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">,</span>
            <span class="s3">&quot;action_form&quot;</span><span class="s2">: </span><span class="s1">action_form</span><span class="s2">,</span>
            <span class="s3">&quot;actions_on_top&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">actions_on_top</span><span class="s2">,</span>
            <span class="s3">&quot;actions_on_bottom&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">actions_on_bottom</span><span class="s2">,</span>
            <span class="s3">&quot;actions_selection_counter&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">actions_selection_counter</span><span class="s2">,</span>
            <span class="s3">&quot;preserved_filters&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_preserved_filters</span><span class="s2">(</span><span class="s1">request</span><span class="s2">),</span>
            <span class="s2">**(</span><span class="s1">extra_context </span><span class="s0">or </span><span class="s2">{}),</span>
        <span class="s2">}</span>

        <span class="s1">request</span><span class="s2">.</span><span class="s1">current_app </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">name</span>

        <span class="s0">return </span><span class="s1">TemplateResponse</span><span class="s2">(</span>
            <span class="s1">request</span><span class="s2">,</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">change_list_template</span>
            <span class="s0">or </span><span class="s2">[</span>
                <span class="s3">&quot;admin/%s/%s/change_list.html&quot; </span><span class="s2">% (</span><span class="s1">app_label</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">model_name</span><span class="s2">),</span>
                <span class="s3">&quot;admin/%s/change_list.html&quot; </span><span class="s2">% </span><span class="s1">app_label</span><span class="s2">,</span>
                <span class="s3">&quot;admin/change_list.html&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s1">context</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_deleted_objects</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">objs</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Hook for customizing the delete process for the delete view and the 
        &quot;delete selected&quot; action. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">get_deleted_objects</span><span class="s2">(</span><span class="s1">objs</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">csrf_protect_m</span>
    <span class="s0">def </span><span class="s1">delete_view</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">object_id</span><span class="s2">, </span><span class="s1">extra_context</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">transaction</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">(</span><span class="s1">using</span><span class="s2">=</span><span class="s1">router</span><span class="s2">.</span><span class="s1">db_for_write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">)):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_delete_view</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">object_id</span><span class="s2">, </span><span class="s1">extra_context</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_delete_view</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">object_id</span><span class="s2">, </span><span class="s1">extra_context</span><span class="s2">):</span>
        <span class="s6">&quot;The 'delete' admin view for this model.&quot;</span>
        <span class="s1">app_label </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span>

        <span class="s1">to_field </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">TO_FIELD_VAR</span><span class="s2">, </span><span class="s1">request</span><span class="s2">.</span><span class="s1">GET</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">TO_FIELD_VAR</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">to_field </span><span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">to_field_allowed</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">to_field</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">DisallowedModelAdminToField</span><span class="s2">(</span>
                <span class="s3">&quot;The field %s cannot be referenced.&quot; </span><span class="s2">% </span><span class="s1">to_field</span>
            <span class="s2">)</span>

        <span class="s1">obj </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_object</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">unquote</span><span class="s2">(</span><span class="s1">object_id</span><span class="s2">), </span><span class="s1">to_field</span><span class="s2">)</span>

        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_delete_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">PermissionDenied</span>

        <span class="s0">if </span><span class="s1">obj </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_obj_does_not_exist_redirect</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">, </span><span class="s1">object_id</span><span class="s2">)</span>

        <span class="s5"># Populate deleted_objects, a data structure of all related objects that</span>
        <span class="s5"># will also be deleted.</span>
        <span class="s2">(</span>
            <span class="s1">deleted_objects</span><span class="s2">,</span>
            <span class="s1">model_count</span><span class="s2">,</span>
            <span class="s1">perms_needed</span><span class="s2">,</span>
            <span class="s1">protected</span><span class="s2">,</span>
        <span class="s2">) = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_deleted_objects</span><span class="s2">([</span><span class="s1">obj</span><span class="s2">], </span><span class="s1">request</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST </span><span class="s0">and not </span><span class="s1">protected</span><span class="s2">:  </span><span class="s5"># The user has confirmed the deletion.</span>
            <span class="s0">if </span><span class="s1">perms_needed</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">PermissionDenied</span>
            <span class="s1">obj_display </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
            <span class="s1">attr </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">to_field</span><span class="s2">) </span><span class="s0">if </span><span class="s1">to_field </span><span class="s0">else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">pk</span><span class="s2">.</span><span class="s1">attname</span>
            <span class="s1">obj_id </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">serializable_value</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">log_deletion</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">obj_display</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">delete_model</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>

            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">response_delete</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj_display</span><span class="s2">, </span><span class="s1">obj_id</span><span class="s2">)</span>

        <span class="s1">object_name </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">verbose_name</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">perms_needed </span><span class="s0">or </span><span class="s1">protected</span><span class="s2">:</span>
            <span class="s1">title </span><span class="s2">= </span><span class="s1">_</span><span class="s2">(</span><span class="s3">&quot;Cannot delete %(name)s&quot;</span><span class="s2">) % {</span><span class="s3">&quot;name&quot;</span><span class="s2">: </span><span class="s1">object_name</span><span class="s2">}</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">title </span><span class="s2">= </span><span class="s1">_</span><span class="s2">(</span><span class="s3">&quot;Are you sure?&quot;</span><span class="s2">)</span>

        <span class="s1">context </span><span class="s2">= {</span>
            <span class="s2">**</span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">each_context</span><span class="s2">(</span><span class="s1">request</span><span class="s2">),</span>
            <span class="s3">&quot;title&quot;</span><span class="s2">: </span><span class="s1">title</span><span class="s2">,</span>
            <span class="s3">&quot;subtitle&quot;</span><span class="s2">: </span><span class="s0">None</span><span class="s2">,</span>
            <span class="s3">&quot;object_name&quot;</span><span class="s2">: </span><span class="s1">object_name</span><span class="s2">,</span>
            <span class="s3">&quot;object&quot;</span><span class="s2">: </span><span class="s1">obj</span><span class="s2">,</span>
            <span class="s3">&quot;deleted_objects&quot;</span><span class="s2">: </span><span class="s1">deleted_objects</span><span class="s2">,</span>
            <span class="s3">&quot;model_count&quot;</span><span class="s2">: </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">model_count</span><span class="s2">).</span><span class="s1">items</span><span class="s2">(),</span>
            <span class="s3">&quot;perms_lacking&quot;</span><span class="s2">: </span><span class="s1">perms_needed</span><span class="s2">,</span>
            <span class="s3">&quot;protected&quot;</span><span class="s2">: </span><span class="s1">protected</span><span class="s2">,</span>
            <span class="s3">&quot;opts&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">,</span>
            <span class="s3">&quot;app_label&quot;</span><span class="s2">: </span><span class="s1">app_label</span><span class="s2">,</span>
            <span class="s3">&quot;preserved_filters&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_preserved_filters</span><span class="s2">(</span><span class="s1">request</span><span class="s2">),</span>
            <span class="s3">&quot;is_popup&quot;</span><span class="s2">: </span><span class="s1">IS_POPUP_VAR </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST </span><span class="s0">or </span><span class="s1">IS_POPUP_VAR </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">GET</span><span class="s2">,</span>
            <span class="s3">&quot;to_field&quot;</span><span class="s2">: </span><span class="s1">to_field</span><span class="s2">,</span>
            <span class="s2">**(</span><span class="s1">extra_context </span><span class="s0">or </span><span class="s2">{}),</span>
        <span class="s2">}</span>

        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">render_delete_form</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">context</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">history_view</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">object_id</span><span class="s2">, </span><span class="s1">extra_context</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s6">&quot;The 'history' admin view for this model.&quot;</span>
        <span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">contrib</span><span class="s2">.</span><span class="s1">admin</span><span class="s2">.</span><span class="s1">models </span><span class="s0">import </span><span class="s1">LogEntry</span>
        <span class="s0">from </span><span class="s1">django</span><span class="s2">.</span><span class="s1">contrib</span><span class="s2">.</span><span class="s1">admin</span><span class="s2">.</span><span class="s1">views</span><span class="s2">.</span><span class="s1">main </span><span class="s0">import </span><span class="s1">PAGE_VAR</span>

        <span class="s5"># First check if the user can see this history.</span>
        <span class="s1">model </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span>
        <span class="s1">obj </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_object</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">unquote</span><span class="s2">(</span><span class="s1">object_id</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">obj </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_obj_does_not_exist_redirect</span><span class="s2">(</span>
                <span class="s1">request</span><span class="s2">, </span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">, </span><span class="s1">object_id</span>
            <span class="s2">)</span>

        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_view_or_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">PermissionDenied</span>

        <span class="s5"># Then get the history for this object.</span>
        <span class="s1">app_label </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span>
        <span class="s1">action_list </span><span class="s2">= (</span>
            <span class="s1">LogEntry</span><span class="s2">.</span><span class="s1">objects</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span>
                <span class="s1">object_id</span><span class="s2">=</span><span class="s1">unquote</span><span class="s2">(</span><span class="s1">object_id</span><span class="s2">),</span>
                <span class="s1">content_type</span><span class="s2">=</span><span class="s1">get_content_type_for_model</span><span class="s2">(</span><span class="s1">model</span><span class="s2">),</span>
            <span class="s2">)</span>
            <span class="s2">.</span><span class="s1">select_related</span><span class="s2">()</span>
            <span class="s2">.</span><span class="s1">order_by</span><span class="s2">(</span><span class="s3">&quot;action_time&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>

        <span class="s1">paginator </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_paginator</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">action_list</span><span class="s2">, </span><span class="s4">100</span><span class="s2">)</span>
        <span class="s1">page_number </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">GET</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">PAGE_VAR</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">page_obj </span><span class="s2">= </span><span class="s1">paginator</span><span class="s2">.</span><span class="s1">get_page</span><span class="s2">(</span><span class="s1">page_number</span><span class="s2">)</span>
        <span class="s1">page_range </span><span class="s2">= </span><span class="s1">paginator</span><span class="s2">.</span><span class="s1">get_elided_page_range</span><span class="s2">(</span><span class="s1">page_obj</span><span class="s2">.</span><span class="s1">number</span><span class="s2">)</span>

        <span class="s1">context </span><span class="s2">= {</span>
            <span class="s2">**</span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">each_context</span><span class="s2">(</span><span class="s1">request</span><span class="s2">),</span>
            <span class="s3">&quot;title&quot;</span><span class="s2">: </span><span class="s1">_</span><span class="s2">(</span><span class="s3">&quot;Change history: %s&quot;</span><span class="s2">) % </span><span class="s1">obj</span><span class="s2">,</span>
            <span class="s3">&quot;subtitle&quot;</span><span class="s2">: </span><span class="s0">None</span><span class="s2">,</span>
            <span class="s3">&quot;action_list&quot;</span><span class="s2">: </span><span class="s1">page_obj</span><span class="s2">,</span>
            <span class="s3">&quot;page_range&quot;</span><span class="s2">: </span><span class="s1">page_range</span><span class="s2">,</span>
            <span class="s3">&quot;page_var&quot;</span><span class="s2">: </span><span class="s1">PAGE_VAR</span><span class="s2">,</span>
            <span class="s3">&quot;pagination_required&quot;</span><span class="s2">: </span><span class="s1">paginator</span><span class="s2">.</span><span class="s1">count </span><span class="s2">&gt; </span><span class="s4">100</span><span class="s2">,</span>
            <span class="s3">&quot;module_name&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">capfirst</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">verbose_name_plural</span><span class="s2">)),</span>
            <span class="s3">&quot;object&quot;</span><span class="s2">: </span><span class="s1">obj</span><span class="s2">,</span>
            <span class="s3">&quot;opts&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">,</span>
            <span class="s3">&quot;preserved_filters&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_preserved_filters</span><span class="s2">(</span><span class="s1">request</span><span class="s2">),</span>
            <span class="s2">**(</span><span class="s1">extra_context </span><span class="s0">or </span><span class="s2">{}),</span>
        <span class="s2">}</span>

        <span class="s1">request</span><span class="s2">.</span><span class="s1">current_app </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">name</span>

        <span class="s0">return </span><span class="s1">TemplateResponse</span><span class="s2">(</span>
            <span class="s1">request</span><span class="s2">,</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">object_history_template</span>
            <span class="s0">or </span><span class="s2">[</span>
                <span class="s3">&quot;admin/%s/%s/object_history.html&quot; </span><span class="s2">% (</span><span class="s1">app_label</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">model_name</span><span class="s2">),</span>
                <span class="s3">&quot;admin/%s/object_history.html&quot; </span><span class="s2">% </span><span class="s1">app_label</span><span class="s2">,</span>
                <span class="s3">&quot;admin/object_history.html&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s1">context</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_formset_kwargs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">inline</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">):</span>
        <span class="s1">formset_params </span><span class="s2">= {</span>
            <span class="s3">&quot;instance&quot;</span><span class="s2">: </span><span class="s1">obj</span><span class="s2">,</span>
            <span class="s3">&quot;prefix&quot;</span><span class="s2">: </span><span class="s1">prefix</span><span class="s2">,</span>
            <span class="s3">&quot;queryset&quot;</span><span class="s2">: </span><span class="s1">inline</span><span class="s2">.</span><span class="s1">get_queryset</span><span class="s2">(</span><span class="s1">request</span><span class="s2">),</span>
        <span class="s2">}</span>
        <span class="s0">if </span><span class="s1">request</span><span class="s2">.</span><span class="s1">method </span><span class="s2">== </span><span class="s3">&quot;POST&quot;</span><span class="s2">:</span>
            <span class="s1">formset_params</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span>
                <span class="s2">{</span>
                    <span class="s3">&quot;data&quot;</span><span class="s2">: </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(),</span>
                    <span class="s3">&quot;files&quot;</span><span class="s2">: </span><span class="s1">request</span><span class="s2">.</span><span class="s1">FILES</span><span class="s2">,</span>
                    <span class="s3">&quot;save_as_new&quot;</span><span class="s2">: </span><span class="s3">&quot;_saveasnew&quot; </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span><span class="s2">,</span>
                <span class="s2">}</span>
            <span class="s2">)</span>
        <span class="s0">return </span><span class="s1">formset_params</span>

    <span class="s0">def </span><span class="s1">_create_formsets</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">change</span><span class="s2">):</span>
        <span class="s6">&quot;Helper function to generate formsets for add/change_view.&quot;</span>
        <span class="s1">formsets </span><span class="s2">= []</span>
        <span class="s1">inline_instances </span><span class="s2">= []</span>
        <span class="s1">prefixes </span><span class="s2">= {}</span>
        <span class="s1">get_formsets_args </span><span class="s2">= [</span><span class="s1">request</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">change</span><span class="s2">:</span>
            <span class="s1">get_formsets_args</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">FormSet</span><span class="s2">, </span><span class="s1">inline </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_formsets_with_inlines</span><span class="s2">(*</span><span class="s1">get_formsets_args</span><span class="s2">):</span>
            <span class="s1">prefix </span><span class="s2">= </span><span class="s1">FormSet</span><span class="s2">.</span><span class="s1">get_default_prefix</span><span class="s2">()</span>
            <span class="s1">prefixes</span><span class="s2">[</span><span class="s1">prefix</span><span class="s2">] = </span><span class="s1">prefixes</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">prefix</span><span class="s2">, </span><span class="s4">0</span><span class="s2">) + </span><span class="s4">1</span>
            <span class="s0">if </span><span class="s1">prefixes</span><span class="s2">[</span><span class="s1">prefix</span><span class="s2">] != </span><span class="s4">1 </span><span class="s0">or not </span><span class="s1">prefix</span><span class="s2">:</span>
                <span class="s1">prefix </span><span class="s2">= </span><span class="s3">&quot;%s-%s&quot; </span><span class="s2">% (</span><span class="s1">prefix</span><span class="s2">, </span><span class="s1">prefixes</span><span class="s2">[</span><span class="s1">prefix</span><span class="s2">])</span>
            <span class="s1">formset_params </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_formset_kwargs</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">inline</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">)</span>
            <span class="s1">formset </span><span class="s2">= </span><span class="s1">FormSet</span><span class="s2">(**</span><span class="s1">formset_params</span><span class="s2">)</span>

            <span class="s0">def </span><span class="s1">user_deleted_form</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">formset</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">inline</span><span class="s2">):</span>
                <span class="s6">&quot;&quot;&quot;Return whether or not the user deleted the form.&quot;&quot;&quot;</span>
                <span class="s0">return </span><span class="s2">(</span>
                    <span class="s1">inline</span><span class="s2">.</span><span class="s1">has_delete_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>
                    <span class="s0">and </span><span class="s3">&quot;{}-{}-DELETE&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">formset</span><span class="s2">.</span><span class="s1">prefix</span><span class="s2">, </span><span class="s1">index</span><span class="s2">) </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">POST</span>
                <span class="s2">)</span>

            <span class="s5"># Bypass validation of each view-only inline form (since the form's</span>
            <span class="s5"># data won't be in request.POST), unless the form was deleted.</span>
            <span class="s0">if not </span><span class="s1">inline</span><span class="s2">.</span><span class="s1">has_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj </span><span class="s0">if </span><span class="s1">change </span><span class="s0">else None</span><span class="s2">):</span>
                <span class="s0">for </span><span class="s1">index</span><span class="s2">, </span><span class="s1">form </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">formset</span><span class="s2">.</span><span class="s1">initial_forms</span><span class="s2">):</span>
                    <span class="s0">if </span><span class="s1">user_deleted_form</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">formset</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">inline</span><span class="s2">):</span>
                        <span class="s0">continue</span>
                    <span class="s1">form</span><span class="s2">.</span><span class="s1">_errors </span><span class="s2">= {}</span>
                    <span class="s1">form</span><span class="s2">.</span><span class="s1">cleaned_data </span><span class="s2">= </span><span class="s1">form</span><span class="s2">.</span><span class="s1">initial</span>
            <span class="s1">formsets</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">formset</span><span class="s2">)</span>
            <span class="s1">inline_instances</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">inline</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">formsets</span><span class="s2">, </span><span class="s1">inline_instances</span>


<span class="s0">class </span><span class="s1">InlineModelAdmin</span><span class="s2">(</span><span class="s1">BaseModelAdmin</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Options for inline editing of ``model`` instances. 
 
    Provide ``fk_name`` to specify the attribute name of the ``ForeignKey`` 
    from ``model`` to its parent. This is required if ``model`` has more than 
    one ``ForeignKey`` to its parent. 
    &quot;&quot;&quot;</span>

    <span class="s1">model </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">fk_name </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">formset </span><span class="s2">= </span><span class="s1">BaseInlineFormSet</span>
    <span class="s1">extra </span><span class="s2">= </span><span class="s4">3</span>
    <span class="s1">min_num </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">max_num </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">template </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">verbose_name </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">verbose_name_plural </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">can_delete </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">show_change_link </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">checks_class </span><span class="s2">= </span><span class="s1">InlineModelAdminChecks</span>
    <span class="s1">classes </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">parent_model</span><span class="s2">, </span><span class="s1">admin_site</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">admin_site </span><span class="s2">= </span><span class="s1">admin_site</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">parent_model </span><span class="s2">= </span><span class="s1">parent_model</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">opts </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">has_registered_model </span><span class="s2">= </span><span class="s1">admin_site</span><span class="s2">.</span><span class="s1">is_registered</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">)</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">verbose_name_plural </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">verbose_name </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">verbose_name_plural </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">verbose_name_plural</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">verbose_name_plural </span><span class="s2">= </span><span class="s1">format_lazy</span><span class="s2">(</span><span class="s3">&quot;{}s&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">verbose_name</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">verbose_name </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">verbose_name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">verbose_name</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">media</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">extra </span><span class="s2">= </span><span class="s3">&quot;&quot; </span><span class="s0">if </span><span class="s1">settings</span><span class="s2">.</span><span class="s1">DEBUG </span><span class="s0">else </span><span class="s3">&quot;.min&quot;</span>
        <span class="s1">js </span><span class="s2">= [</span><span class="s3">&quot;vendor/jquery/jquery%s.js&quot; </span><span class="s2">% </span><span class="s1">extra</span><span class="s2">, </span><span class="s3">&quot;jquery.init.js&quot;</span><span class="s2">, </span><span class="s3">&quot;inlines.js&quot;</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filter_vertical </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filter_horizontal</span><span class="s2">:</span>
            <span class="s1">js</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span><span class="s3">&quot;SelectBox.js&quot;</span><span class="s2">, </span><span class="s3">&quot;SelectFilter2.js&quot;</span><span class="s2">])</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">classes </span><span class="s0">and </span><span class="s3">&quot;collapse&quot; </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">classes</span><span class="s2">:</span>
            <span class="s1">js</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">&quot;collapse.js&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">forms</span><span class="s2">.</span><span class="s1">Media</span><span class="s2">(</span><span class="s1">js</span><span class="s2">=[</span><span class="s3">&quot;admin/js/%s&quot; </span><span class="s2">% </span><span class="s1">url </span><span class="s0">for </span><span class="s1">url </span><span class="s0">in </span><span class="s1">js</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">get_extra</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Hook for customizing the number of extra inline forms.&quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">extra</span>

    <span class="s0">def </span><span class="s1">get_min_num</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Hook for customizing the min number of inline forms.&quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">min_num</span>

    <span class="s0">def </span><span class="s1">get_max_num</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Hook for customizing the max number of extra inline forms.&quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_num</span>

    <span class="s0">def </span><span class="s1">get_formset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Return a BaseInlineFormSet class for use in admin add/change views.&quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s3">&quot;fields&quot; </span><span class="s0">in </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s1">fields </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s3">&quot;fields&quot;</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">fields </span><span class="s2">= </span><span class="s1">flatten_fieldsets</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_fieldsets</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">))</span>
        <span class="s1">excluded </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_exclude</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s1">exclude </span><span class="s2">= [] </span><span class="s0">if </span><span class="s1">excluded </span><span class="s0">is None else </span><span class="s1">list</span><span class="s2">(</span><span class="s1">excluded</span><span class="s2">)</span>
        <span class="s1">exclude</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_readonly_fields</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">excluded </span><span class="s0">is None and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">, </span><span class="s3">&quot;_meta&quot;</span><span class="s2">) </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">exclude</span><span class="s2">:</span>
            <span class="s5"># Take the custom ModelForm's Meta.exclude into account only if the</span>
            <span class="s5"># InlineModelAdmin doesn't define its own.</span>
            <span class="s1">exclude</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">exclude</span><span class="s2">)</span>
        <span class="s5"># If exclude is an empty list we use None, since that's the actual</span>
        <span class="s5"># default.</span>
        <span class="s1">exclude </span><span class="s2">= </span><span class="s1">exclude </span><span class="s0">or None</span>
        <span class="s1">can_delete </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">can_delete </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_delete_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s1">defaults </span><span class="s2">= {</span>
            <span class="s3">&quot;form&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">form</span><span class="s2">,</span>
            <span class="s3">&quot;formset&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">formset</span><span class="s2">,</span>
            <span class="s3">&quot;fk_name&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fk_name</span><span class="s2">,</span>
            <span class="s3">&quot;fields&quot;</span><span class="s2">: </span><span class="s1">fields</span><span class="s2">,</span>
            <span class="s3">&quot;exclude&quot;</span><span class="s2">: </span><span class="s1">exclude</span><span class="s2">,</span>
            <span class="s3">&quot;formfield_callback&quot;</span><span class="s2">: </span><span class="s1">partial</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">formfield_for_dbfield</span><span class="s2">, </span><span class="s1">request</span><span class="s2">=</span><span class="s1">request</span><span class="s2">),</span>
            <span class="s3">&quot;extra&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_extra</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">),</span>
            <span class="s3">&quot;min_num&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_min_num</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">),</span>
            <span class="s3">&quot;max_num&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_max_num</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">),</span>
            <span class="s3">&quot;can_delete&quot;</span><span class="s2">: </span><span class="s1">can_delete</span><span class="s2">,</span>
            <span class="s2">**</span><span class="s1">kwargs</span><span class="s2">,</span>
        <span class="s2">}</span>

        <span class="s1">base_model_form </span><span class="s2">= </span><span class="s1">defaults</span><span class="s2">[</span><span class="s3">&quot;form&quot;</span><span class="s2">]</span>
        <span class="s1">can_change </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">) </span><span class="s0">if </span><span class="s1">request </span><span class="s0">else True</span>
        <span class="s1">can_add </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_add_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">) </span><span class="s0">if </span><span class="s1">request </span><span class="s0">else True</span>

        <span class="s0">class </span><span class="s1">DeleteProtectedModelForm</span><span class="s2">(</span><span class="s1">base_model_form</span><span class="s2">):</span>
            <span class="s0">def </span><span class="s1">hand_clean_DELETE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                <span class="s6">&quot;&quot;&quot; 
                We don't validate the 'DELETE' field itself because on 
                templates it's not rendered using the field information, but 
                just using a generic &quot;deletion_field&quot; of the InlineModelAdmin. 
                &quot;&quot;&quot;</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cleaned_data</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">DELETION_FIELD_NAME</span><span class="s2">, </span><span class="s0">False</span><span class="s2">):</span>
                    <span class="s1">using </span><span class="s2">= </span><span class="s1">router</span><span class="s2">.</span><span class="s1">db_for_write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">model</span><span class="s2">)</span>
                    <span class="s1">collector </span><span class="s2">= </span><span class="s1">NestedObjects</span><span class="s2">(</span><span class="s1">using</span><span class="s2">=</span><span class="s1">using</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">instance</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">adding</span><span class="s2">:</span>
                        <span class="s0">return</span>
                    <span class="s1">collector</span><span class="s2">.</span><span class="s1">collect</span><span class="s2">([</span><span class="s1">self</span><span class="s2">.</span><span class="s1">instance</span><span class="s2">])</span>
                    <span class="s0">if </span><span class="s1">collector</span><span class="s2">.</span><span class="s1">protected</span><span class="s2">:</span>
                        <span class="s1">objs </span><span class="s2">= []</span>
                        <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">collector</span><span class="s2">.</span><span class="s1">protected</span><span class="s2">:</span>
                            <span class="s1">objs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
                                <span class="s5"># Translators: Model verbose name and instance</span>
                                <span class="s5"># representation, suitable to be an item in a</span>
                                <span class="s5"># list.</span>
                                <span class="s1">_</span><span class="s2">(</span><span class="s3">&quot;%(class_name)s %(instance)s&quot;</span><span class="s2">)</span>
                                <span class="s2">% {</span><span class="s3">&quot;class_name&quot;</span><span class="s2">: </span><span class="s1">p</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">verbose_name</span><span class="s2">, </span><span class="s3">&quot;instance&quot;</span><span class="s2">: </span><span class="s1">p</span><span class="s2">}</span>
                            <span class="s2">)</span>
                        <span class="s1">params </span><span class="s2">= {</span>
                            <span class="s3">&quot;class_name&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">verbose_name</span><span class="s2">,</span>
                            <span class="s3">&quot;instance&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">instance</span><span class="s2">,</span>
                            <span class="s3">&quot;related_objects&quot;</span><span class="s2">: </span><span class="s1">get_text_list</span><span class="s2">(</span><span class="s1">objs</span><span class="s2">, </span><span class="s1">_</span><span class="s2">(</span><span class="s3">&quot;and&quot;</span><span class="s2">)),</span>
                        <span class="s2">}</span>
                        <span class="s1">msg </span><span class="s2">= </span><span class="s1">_</span><span class="s2">(</span>
                            <span class="s3">&quot;Deleting %(class_name)s %(instance)s would require &quot;</span>
                            <span class="s3">&quot;deleting the following protected related objects: &quot;</span>
                            <span class="s3">&quot;%(related_objects)s&quot;</span>
                        <span class="s2">)</span>
                        <span class="s0">raise </span><span class="s1">ValidationError</span><span class="s2">(</span>
                            <span class="s1">msg</span><span class="s2">, </span><span class="s1">code</span><span class="s2">=</span><span class="s3">&quot;deleting_protected&quot;</span><span class="s2">, </span><span class="s1">params</span><span class="s2">=</span><span class="s1">params</span>
                        <span class="s2">)</span>

            <span class="s0">def </span><span class="s1">is_valid</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                <span class="s1">result </span><span class="s2">= </span><span class="s1">super</span><span class="s2">().</span><span class="s1">is_valid</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">hand_clean_DELETE</span><span class="s2">()</span>
                <span class="s0">return </span><span class="s1">result</span>

            <span class="s0">def </span><span class="s1">has_changed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                <span class="s5"># Protect against unauthorized edits.</span>
                <span class="s0">if not </span><span class="s1">can_change </span><span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">instance</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">adding</span><span class="s2">:</span>
                    <span class="s0">return False</span>
                <span class="s0">if not </span><span class="s1">can_add </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">instance</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">adding</span><span class="s2">:</span>
                    <span class="s0">return False</span>
                <span class="s0">return </span><span class="s1">super</span><span class="s2">().</span><span class="s1">has_changed</span><span class="s2">()</span>

        <span class="s1">defaults</span><span class="s2">[</span><span class="s3">&quot;form&quot;</span><span class="s2">] = </span><span class="s1">DeleteProtectedModelForm</span>

        <span class="s0">if </span><span class="s1">defaults</span><span class="s2">[</span><span class="s3">&quot;fields&quot;</span><span class="s2">] </span><span class="s0">is None and not </span><span class="s1">modelform_defines_fields</span><span class="s2">(</span>
            <span class="s1">defaults</span><span class="s2">[</span><span class="s3">&quot;form&quot;</span><span class="s2">]</span>
        <span class="s2">):</span>
            <span class="s1">defaults</span><span class="s2">[</span><span class="s3">&quot;fields&quot;</span><span class="s2">] = </span><span class="s1">forms</span><span class="s2">.</span><span class="s1">ALL_FIELDS</span>

        <span class="s0">return </span><span class="s1">inlineformset_factory</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">parent_model</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, **</span><span class="s1">defaults</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_get_form_for_get_fields</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_formset</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">fields</span><span class="s2">=</span><span class="s0">None</span><span class="s2">).</span><span class="s1">form</span>

    <span class="s0">def </span><span class="s1">get_queryset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
        <span class="s1">queryset </span><span class="s2">= </span><span class="s1">super</span><span class="s2">().</span><span class="s1">get_queryset</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_view_or_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
            <span class="s1">queryset </span><span class="s2">= </span><span class="s1">queryset</span><span class="s2">.</span><span class="s1">none</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">queryset</span>

    <span class="s0">def </span><span class="s1">_has_any_perms_for_target_model</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">perms</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        This method is called only when the ModelAdmin's model is for an 
        ManyToManyField's implicit through model (if self.opts.auto_created). 
        Return True if the user has any of the given permissions ('add', 
        'change', etc.) for the model that points to the through model. 
        &quot;&quot;&quot;</span>
        <span class="s1">opts </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span>
        <span class="s5"># Find the target model of an auto-created many-to-many relationship.</span>
        <span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">opts</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">field</span><span class="s2">.</span><span class="s1">remote_field </span><span class="s0">and </span><span class="s1">field</span><span class="s2">.</span><span class="s1">remote_field</span><span class="s2">.</span><span class="s1">model </span><span class="s2">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parent_model</span><span class="s2">:</span>
                <span class="s1">opts </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">remote_field</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span>
                <span class="s0">break</span>
        <span class="s0">return </span><span class="s1">any</span><span class="s2">(</span>
            <span class="s1">request</span><span class="s2">.</span><span class="s1">user</span><span class="s2">.</span><span class="s1">has_perm</span><span class="s2">(</span>
                <span class="s3">&quot;%s.%s&quot; </span><span class="s2">% (</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">app_label</span><span class="s2">, </span><span class="s1">get_permission_codename</span><span class="s2">(</span><span class="s1">perm</span><span class="s2">, </span><span class="s1">opts</span><span class="s2">))</span>
            <span class="s2">)</span>
            <span class="s0">for </span><span class="s1">perm </span><span class="s0">in </span><span class="s1">perms</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">has_add_permission</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">auto_created</span><span class="s2">:</span>
            <span class="s5"># Auto-created intermediate models don't have their own</span>
            <span class="s5"># permissions. The user needs to have the change permission for the</span>
            <span class="s5"># related model in order to be able to do anything with the</span>
            <span class="s5"># intermediate model.</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_has_any_perms_for_target_model</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, [</span><span class="s3">&quot;change&quot;</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s1">super</span><span class="s2">().</span><span class="s1">has_add_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">has_change_permission</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">auto_created</span><span class="s2">:</span>
            <span class="s5"># Same comment as has_add_permission().</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_has_any_perms_for_target_model</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, [</span><span class="s3">&quot;change&quot;</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s1">super</span><span class="s2">().</span><span class="s1">has_change_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">has_delete_permission</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">auto_created</span><span class="s2">:</span>
            <span class="s5"># Same comment as has_add_permission().</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_has_any_perms_for_target_model</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, [</span><span class="s3">&quot;change&quot;</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s1">super</span><span class="s2">().</span><span class="s1">has_delete_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">has_view_permission</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">auto_created</span><span class="s2">:</span>
            <span class="s5"># Same comment as has_add_permission(). The 'change' permission</span>
            <span class="s5"># also implies the 'view' permission.</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_has_any_perms_for_target_model</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, [</span><span class="s3">&quot;view&quot;</span><span class="s2">, </span><span class="s3">&quot;change&quot;</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s1">super</span><span class="s2">().</span><span class="s1">has_view_permission</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">StackedInline</span><span class="s2">(</span><span class="s1">InlineModelAdmin</span><span class="s2">):</span>
    <span class="s1">template </span><span class="s2">= </span><span class="s3">&quot;admin/edit_inline/stacked.html&quot;</span>


<span class="s0">class </span><span class="s1">TabularInline</span><span class="s2">(</span><span class="s1">InlineModelAdmin</span><span class="s2">):</span>
    <span class="s1">template </span><span class="s2">= </span><span class="s3">&quot;admin/edit_inline/tabular.html&quot;</span>
</pre>
</body>
</html>