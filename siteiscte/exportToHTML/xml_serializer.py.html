<html>
<head>
<title>xml_serializer.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
xml_serializer.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
XML serializer. 
&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">json</span>
<span class="s2">from </span><span class="s1">xml</span><span class="s3">.</span><span class="s1">dom </span><span class="s2">import </span><span class="s1">pulldom</span>
<span class="s2">from </span><span class="s1">xml</span><span class="s3">.</span><span class="s1">sax </span><span class="s2">import </span><span class="s1">handler</span>
<span class="s2">from </span><span class="s1">xml</span><span class="s3">.</span><span class="s1">sax</span><span class="s3">.</span><span class="s1">expatreader </span><span class="s2">import </span><span class="s1">ExpatParser </span><span class="s2">as </span><span class="s1">_ExpatParser</span>

<span class="s2">from </span><span class="s1">django</span><span class="s3">.</span><span class="s1">apps </span><span class="s2">import </span><span class="s1">apps</span>
<span class="s2">from </span><span class="s1">django</span><span class="s3">.</span><span class="s1">conf </span><span class="s2">import </span><span class="s1">settings</span>
<span class="s2">from </span><span class="s1">django</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">exceptions </span><span class="s2">import </span><span class="s1">ObjectDoesNotExist</span>
<span class="s2">from </span><span class="s1">django</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">serializers </span><span class="s2">import </span><span class="s1">base</span>
<span class="s2">from </span><span class="s1">django</span><span class="s3">.</span><span class="s1">db </span><span class="s2">import </span><span class="s1">DEFAULT_DB_ALIAS</span><span class="s3">, </span><span class="s1">models</span>
<span class="s2">from </span><span class="s1">django</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">xmlutils </span><span class="s2">import </span><span class="s1">SimplerXMLGenerator</span><span class="s3">, </span><span class="s1">UnserializableContentError</span>


<span class="s2">class </span><span class="s1">Serializer</span><span class="s3">(</span><span class="s1">base</span><span class="s3">.</span><span class="s1">Serializer</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Serialize a QuerySet to XML.&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">indent</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">level</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">options</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;indent&quot;</span><span class="s3">) </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">ignorableWhitespace</span><span class="s3">(</span>
                <span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot; </span><span class="s3">+ </span><span class="s4">&quot; &quot; </span><span class="s3">* </span><span class="s1">self</span><span class="s3">.</span><span class="s1">options</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;indent&quot;</span><span class="s3">) * </span><span class="s1">level</span>
            <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">start_serialization</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Start serialization -- open the XML document and the root element. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">xml </span><span class="s3">= </span><span class="s1">SimplerXMLGenerator</span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">stream</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">options</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;encoding&quot;</span><span class="s3">, </span><span class="s1">settings</span><span class="s3">.</span><span class="s1">DEFAULT_CHARSET</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">startDocument</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">startElement</span><span class="s3">(</span><span class="s4">&quot;django-objects&quot;</span><span class="s3">, {</span><span class="s4">&quot;version&quot;</span><span class="s3">: </span><span class="s4">&quot;1.0&quot;</span><span class="s3">})</span>

    <span class="s2">def </span><span class="s1">end_serialization</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        End serialization -- end the document. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">indent</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">endElement</span><span class="s3">(</span><span class="s4">&quot;django-objects&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">endDocument</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">start_object</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Called as each object is handled. 
        &quot;&quot;&quot;</span>
        <span class="s2">if not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s4">&quot;_meta&quot;</span><span class="s3">):</span>
            <span class="s2">raise </span><span class="s1">base</span><span class="s3">.</span><span class="s1">SerializationError</span><span class="s3">(</span>
                <span class="s4">&quot;Non-model object (%s) encountered during serialization&quot; </span><span class="s3">% </span><span class="s1">type</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>
            <span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">indent</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">attrs </span><span class="s3">= {</span><span class="s4">&quot;model&quot;</span><span class="s3">: </span><span class="s1">str</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">.</span><span class="s1">_meta</span><span class="s3">)}</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">use_natural_primary_keys </span><span class="s2">or not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s4">&quot;natural_key&quot;</span><span class="s3">):</span>
            <span class="s1">obj_pk </span><span class="s3">= </span><span class="s1">obj</span><span class="s3">.</span><span class="s1">pk</span>
            <span class="s2">if </span><span class="s1">obj_pk </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s1">attrs</span><span class="s3">[</span><span class="s4">&quot;pk&quot;</span><span class="s3">] = </span><span class="s1">str</span><span class="s3">(</span><span class="s1">obj_pk</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">startElement</span><span class="s3">(</span><span class="s4">&quot;object&quot;</span><span class="s3">, </span><span class="s1">attrs</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">end_object</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Called after handling all fields for an object. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">indent</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">endElement</span><span class="s3">(</span><span class="s4">&quot;object&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">handle_field</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">field</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Handle each field on an object (except for ForeignKeys and 
        ManyToManyFields). 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">indent</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">startElement</span><span class="s3">(</span>
            <span class="s4">&quot;field&quot;</span><span class="s3">,</span>
            <span class="s3">{</span>
                <span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">field</span><span class="s3">.</span><span class="s1">name</span><span class="s3">,</span>
                <span class="s4">&quot;type&quot;</span><span class="s3">: </span><span class="s1">field</span><span class="s3">.</span><span class="s1">get_internal_type</span><span class="s3">(),</span>
            <span class="s3">},</span>
        <span class="s3">)</span>

        <span class="s6"># Get a &quot;string version&quot; of the object's data.</span>
        <span class="s2">if </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">field</span><span class="s3">.</span><span class="s1">name</span><span class="s3">) </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">value </span><span class="s3">= </span><span class="s1">field</span><span class="s3">.</span><span class="s1">value_to_string</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">field</span><span class="s3">.</span><span class="s1">get_internal_type</span><span class="s3">() == </span><span class="s4">&quot;JSONField&quot;</span><span class="s3">:</span>
                <span class="s6"># Dump value since JSONField.value_to_string() doesn't output</span>
                <span class="s6"># strings.</span>
                <span class="s1">value </span><span class="s3">= </span><span class="s1">json</span><span class="s3">.</span><span class="s1">dumps</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">cls</span><span class="s3">=</span><span class="s1">field</span><span class="s3">.</span><span class="s1">encoder</span><span class="s3">)</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">characters</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">UnserializableContentError</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
                    <span class="s4">&quot;%s.%s (pk:%s) contains unserializable characters&quot;</span>
                    <span class="s3">% (</span><span class="s1">obj</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">.</span><span class="s1">__name__</span><span class="s3">, </span><span class="s1">field</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">.</span><span class="s1">pk</span><span class="s3">)</span>
                <span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">addQuickElement</span><span class="s3">(</span><span class="s4">&quot;None&quot;</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">endElement</span><span class="s3">(</span><span class="s4">&quot;field&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">handle_fk_field</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">field</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Handle a ForeignKey (they need to be treated slightly 
        differently from regular fields). 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_start_relational_field</span><span class="s3">(</span><span class="s1">field</span><span class="s3">)</span>
        <span class="s1">related_att </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">field</span><span class="s3">.</span><span class="s1">get_attname</span><span class="s3">())</span>
        <span class="s2">if </span><span class="s1">related_att </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">use_natural_foreign_keys </span><span class="s2">and </span><span class="s1">hasattr</span><span class="s3">(</span>
                <span class="s1">field</span><span class="s3">.</span><span class="s1">remote_field</span><span class="s3">.</span><span class="s1">model</span><span class="s3">, </span><span class="s4">&quot;natural_key&quot;</span>
            <span class="s3">):</span>
                <span class="s1">related </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">field</span><span class="s3">.</span><span class="s1">name</span><span class="s3">)</span>
                <span class="s6"># If related object has a natural key, use it</span>
                <span class="s1">related </span><span class="s3">= </span><span class="s1">related</span><span class="s3">.</span><span class="s1">natural_key</span><span class="s3">()</span>
                <span class="s6"># Iterable natural keys are rolled out as subelements</span>
                <span class="s2">for </span><span class="s1">key_value </span><span class="s2">in </span><span class="s1">related</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">startElement</span><span class="s3">(</span><span class="s4">&quot;natural&quot;</span><span class="s3">, {})</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">characters</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">key_value</span><span class="s3">))</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">endElement</span><span class="s3">(</span><span class="s4">&quot;natural&quot;</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">characters</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">related_att</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">addQuickElement</span><span class="s3">(</span><span class="s4">&quot;None&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">endElement</span><span class="s3">(</span><span class="s4">&quot;field&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">handle_m2m_field</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">field</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Handle a ManyToManyField. Related objects are only serialized as 
        references to the object's PK (i.e. the related *data* is not dumped, 
        just the relation). 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">field</span><span class="s3">.</span><span class="s1">remote_field</span><span class="s3">.</span><span class="s1">through</span><span class="s3">.</span><span class="s1">_meta</span><span class="s3">.</span><span class="s1">auto_created</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_start_relational_field</span><span class="s3">(</span><span class="s1">field</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">use_natural_foreign_keys </span><span class="s2">and </span><span class="s1">hasattr</span><span class="s3">(</span>
                <span class="s1">field</span><span class="s3">.</span><span class="s1">remote_field</span><span class="s3">.</span><span class="s1">model</span><span class="s3">, </span><span class="s4">&quot;natural_key&quot;</span>
            <span class="s3">):</span>
                <span class="s6"># If the objects in the m2m have a natural key, use it</span>
                <span class="s2">def </span><span class="s1">handle_m2m</span><span class="s3">(</span><span class="s1">value</span><span class="s3">):</span>
                    <span class="s1">natural </span><span class="s3">= </span><span class="s1">value</span><span class="s3">.</span><span class="s1">natural_key</span><span class="s3">()</span>
                    <span class="s6"># Iterable natural keys are rolled out as subelements</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">startElement</span><span class="s3">(</span><span class="s4">&quot;object&quot;</span><span class="s3">, {})</span>
                    <span class="s2">for </span><span class="s1">key_value </span><span class="s2">in </span><span class="s1">natural</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">startElement</span><span class="s3">(</span><span class="s4">&quot;natural&quot;</span><span class="s3">, {})</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">characters</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">key_value</span><span class="s3">))</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">endElement</span><span class="s3">(</span><span class="s4">&quot;natural&quot;</span><span class="s3">)</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">endElement</span><span class="s3">(</span><span class="s4">&quot;object&quot;</span><span class="s3">)</span>

                <span class="s2">def </span><span class="s1">queryset_iterator</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">field</span><span class="s3">):</span>
                    <span class="s2">return </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">field</span><span class="s3">.</span><span class="s1">name</span><span class="s3">).</span><span class="s1">iterator</span><span class="s3">()</span>

            <span class="s2">else</span><span class="s3">:</span>

                <span class="s2">def </span><span class="s1">handle_m2m</span><span class="s3">(</span><span class="s1">value</span><span class="s3">):</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">addQuickElement</span><span class="s3">(</span><span class="s4">&quot;object&quot;</span><span class="s3">, </span><span class="s1">attrs</span><span class="s3">={</span><span class="s4">&quot;pk&quot;</span><span class="s3">: </span><span class="s1">str</span><span class="s3">(</span><span class="s1">value</span><span class="s3">.</span><span class="s1">pk</span><span class="s3">)})</span>

                <span class="s2">def </span><span class="s1">queryset_iterator</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">field</span><span class="s3">):</span>
                    <span class="s2">return </span><span class="s3">(</span>
                        <span class="s1">getattr</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">field</span><span class="s3">.</span><span class="s1">name</span><span class="s3">)</span>
                        <span class="s3">.</span><span class="s1">select_related</span><span class="s3">(</span><span class="s2">None</span><span class="s3">)</span>
                        <span class="s3">.</span><span class="s1">only</span><span class="s3">(</span><span class="s4">&quot;pk&quot;</span><span class="s3">)</span>
                        <span class="s3">.</span><span class="s1">iterator</span><span class="s3">()</span>
                    <span class="s3">)</span>

            <span class="s1">m2m_iter </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s4">&quot;_prefetched_objects_cache&quot;</span><span class="s3">, {}).</span><span class="s1">get</span><span class="s3">(</span>
                <span class="s1">field</span><span class="s3">.</span><span class="s1">name</span><span class="s3">,</span>
                <span class="s1">queryset_iterator</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">field</span><span class="s3">),</span>
            <span class="s3">)</span>
            <span class="s2">for </span><span class="s1">relobj </span><span class="s2">in </span><span class="s1">m2m_iter</span><span class="s3">:</span>
                <span class="s1">handle_m2m</span><span class="s3">(</span><span class="s1">relobj</span><span class="s3">)</span>

            <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">endElement</span><span class="s3">(</span><span class="s4">&quot;field&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_start_relational_field</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">field</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Output the &lt;field&gt; element for relational fields.&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">indent</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">xml</span><span class="s3">.</span><span class="s1">startElement</span><span class="s3">(</span>
            <span class="s4">&quot;field&quot;</span><span class="s3">,</span>
            <span class="s3">{</span>
                <span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">field</span><span class="s3">.</span><span class="s1">name</span><span class="s3">,</span>
                <span class="s4">&quot;rel&quot;</span><span class="s3">: </span><span class="s1">field</span><span class="s3">.</span><span class="s1">remote_field</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">.</span><span class="s1">__name__</span><span class="s3">,</span>
                <span class="s4">&quot;to&quot;</span><span class="s3">: </span><span class="s1">str</span><span class="s3">(</span><span class="s1">field</span><span class="s3">.</span><span class="s1">remote_field</span><span class="s3">.</span><span class="s1">model</span><span class="s3">.</span><span class="s1">_meta</span><span class="s3">),</span>
            <span class="s3">},</span>
        <span class="s3">)</span>


<span class="s2">class </span><span class="s1">Deserializer</span><span class="s3">(</span><span class="s1">base</span><span class="s3">.</span><span class="s1">Deserializer</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Deserialize XML.&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">stream_or_string</span><span class="s3">,</span>
        <span class="s3">*,</span>
        <span class="s1">using</span><span class="s3">=</span><span class="s1">DEFAULT_DB_ALIAS</span><span class="s3">,</span>
        <span class="s1">ignorenonexistent</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s3">**</span><span class="s1">options</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">stream_or_string</span><span class="s3">, **</span><span class="s1">options</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">handle_forward_references </span><span class="s3">= </span><span class="s1">options</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s4">&quot;handle_forward_references&quot;</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">event_stream </span><span class="s3">= </span><span class="s1">pulldom</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">stream</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_make_parser</span><span class="s3">())</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">db </span><span class="s3">= </span><span class="s1">using</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">ignore </span><span class="s3">= </span><span class="s1">ignorenonexistent</span>

    <span class="s2">def </span><span class="s1">_make_parser</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Create a hardened XML parser (no custom/external entities).&quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">DefusedExpatParser</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">__next__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">event</span><span class="s3">, </span><span class="s1">node </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">event_stream</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">event </span><span class="s3">== </span><span class="s4">&quot;START_ELEMENT&quot; </span><span class="s2">and </span><span class="s1">node</span><span class="s3">.</span><span class="s1">nodeName </span><span class="s3">== </span><span class="s4">&quot;object&quot;</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">event_stream</span><span class="s3">.</span><span class="s1">expandNode</span><span class="s3">(</span><span class="s1">node</span><span class="s3">)</span>
                <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_object</span><span class="s3">(</span><span class="s1">node</span><span class="s3">)</span>
        <span class="s2">raise </span><span class="s1">StopIteration</span>

    <span class="s2">def </span><span class="s1">_handle_object</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">node</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Convert an &lt;object&gt; node to a DeserializedObject.&quot;&quot;&quot;</span>
        <span class="s6"># Look up the model using the model loading mechanism. If this fails,</span>
        <span class="s6"># bail.</span>
        <span class="s1">Model </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_model_from_node</span><span class="s3">(</span><span class="s1">node</span><span class="s3">, </span><span class="s4">&quot;model&quot;</span><span class="s3">)</span>

        <span class="s6"># Start building a data dictionary from the object.</span>
        <span class="s1">data </span><span class="s3">= {}</span>
        <span class="s2">if </span><span class="s1">node</span><span class="s3">.</span><span class="s1">hasAttribute</span><span class="s3">(</span><span class="s4">&quot;pk&quot;</span><span class="s3">):</span>
            <span class="s1">data</span><span class="s3">[</span><span class="s1">Model</span><span class="s3">.</span><span class="s1">_meta</span><span class="s3">.</span><span class="s1">pk</span><span class="s3">.</span><span class="s1">attname</span><span class="s3">] = </span><span class="s1">Model</span><span class="s3">.</span><span class="s1">_meta</span><span class="s3">.</span><span class="s1">pk</span><span class="s3">.</span><span class="s1">to_python</span><span class="s3">(</span>
                <span class="s1">node</span><span class="s3">.</span><span class="s1">getAttribute</span><span class="s3">(</span><span class="s4">&quot;pk&quot;</span><span class="s3">)</span>
            <span class="s3">)</span>

        <span class="s6"># Also start building a dict of m2m data (this is saved as</span>
        <span class="s6"># {m2m_accessor_attribute : [list_of_related_objects]})</span>
        <span class="s1">m2m_data </span><span class="s3">= {}</span>
        <span class="s1">deferred_fields </span><span class="s3">= {}</span>

        <span class="s1">field_names </span><span class="s3">= {</span><span class="s1">f</span><span class="s3">.</span><span class="s1">name </span><span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">Model</span><span class="s3">.</span><span class="s1">_meta</span><span class="s3">.</span><span class="s1">get_fields</span><span class="s3">()}</span>
        <span class="s6"># Deserialize each field.</span>
        <span class="s2">for </span><span class="s1">field_node </span><span class="s2">in </span><span class="s1">node</span><span class="s3">.</span><span class="s1">getElementsByTagName</span><span class="s3">(</span><span class="s4">&quot;field&quot;</span><span class="s3">):</span>
            <span class="s6"># If the field is missing the name attribute, bail (are you</span>
            <span class="s6"># sensing a pattern here?)</span>
            <span class="s1">field_name </span><span class="s3">= </span><span class="s1">field_node</span><span class="s3">.</span><span class="s1">getAttribute</span><span class="s3">(</span><span class="s4">&quot;name&quot;</span><span class="s3">)</span>
            <span class="s2">if not </span><span class="s1">field_name</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">base</span><span class="s3">.</span><span class="s1">DeserializationError</span><span class="s3">(</span>
                    <span class="s4">&quot;&lt;field&gt; node is missing the 'name' attribute&quot;</span>
                <span class="s3">)</span>

            <span class="s6"># Get the field from the Model. This will raise a</span>
            <span class="s6"># FieldDoesNotExist if, well, the field doesn't exist, which will</span>
            <span class="s6"># be propagated correctly unless ignorenonexistent=True is used.</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">ignore </span><span class="s2">and </span><span class="s1">field_name </span><span class="s2">not in </span><span class="s1">field_names</span><span class="s3">:</span>
                <span class="s2">continue</span>
            <span class="s1">field </span><span class="s3">= </span><span class="s1">Model</span><span class="s3">.</span><span class="s1">_meta</span><span class="s3">.</span><span class="s1">get_field</span><span class="s3">(</span><span class="s1">field_name</span><span class="s3">)</span>

            <span class="s6"># As is usually the case, relation fields get the special treatment.</span>
            <span class="s2">if </span><span class="s1">field</span><span class="s3">.</span><span class="s1">remote_field </span><span class="s2">and </span><span class="s1">isinstance</span><span class="s3">(</span>
                <span class="s1">field</span><span class="s3">.</span><span class="s1">remote_field</span><span class="s3">, </span><span class="s1">models</span><span class="s3">.</span><span class="s1">ManyToManyRel</span>
            <span class="s3">):</span>
                <span class="s1">value </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_m2m_field_node</span><span class="s3">(</span><span class="s1">field_node</span><span class="s3">, </span><span class="s1">field</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">value </span><span class="s3">== </span><span class="s1">base</span><span class="s3">.</span><span class="s1">DEFER_FIELD</span><span class="s3">:</span>
                    <span class="s1">deferred_fields</span><span class="s3">[</span><span class="s1">field</span><span class="s3">] = [</span>
                        <span class="s3">[</span>
                            <span class="s1">getInnerText</span><span class="s3">(</span><span class="s1">nat_node</span><span class="s3">).</span><span class="s1">strip</span><span class="s3">()</span>
                            <span class="s2">for </span><span class="s1">nat_node </span><span class="s2">in </span><span class="s1">obj_node</span><span class="s3">.</span><span class="s1">getElementsByTagName</span><span class="s3">(</span><span class="s4">&quot;natural&quot;</span><span class="s3">)</span>
                        <span class="s3">]</span>
                        <span class="s2">for </span><span class="s1">obj_node </span><span class="s2">in </span><span class="s1">field_node</span><span class="s3">.</span><span class="s1">getElementsByTagName</span><span class="s3">(</span><span class="s4">&quot;object&quot;</span><span class="s3">)</span>
                    <span class="s3">]</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">m2m_data</span><span class="s3">[</span><span class="s1">field</span><span class="s3">.</span><span class="s1">name</span><span class="s3">] = </span><span class="s1">value</span>
            <span class="s2">elif </span><span class="s1">field</span><span class="s3">.</span><span class="s1">remote_field </span><span class="s2">and </span><span class="s1">isinstance</span><span class="s3">(</span>
                <span class="s1">field</span><span class="s3">.</span><span class="s1">remote_field</span><span class="s3">, </span><span class="s1">models</span><span class="s3">.</span><span class="s1">ManyToOneRel</span>
            <span class="s3">):</span>
                <span class="s1">value </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_fk_field_node</span><span class="s3">(</span><span class="s1">field_node</span><span class="s3">, </span><span class="s1">field</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">value </span><span class="s3">== </span><span class="s1">base</span><span class="s3">.</span><span class="s1">DEFER_FIELD</span><span class="s3">:</span>
                    <span class="s1">deferred_fields</span><span class="s3">[</span><span class="s1">field</span><span class="s3">] = [</span>
                        <span class="s1">getInnerText</span><span class="s3">(</span><span class="s1">k</span><span class="s3">).</span><span class="s1">strip</span><span class="s3">()</span>
                        <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">field_node</span><span class="s3">.</span><span class="s1">getElementsByTagName</span><span class="s3">(</span><span class="s4">&quot;natural&quot;</span><span class="s3">)</span>
                    <span class="s3">]</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">data</span><span class="s3">[</span><span class="s1">field</span><span class="s3">.</span><span class="s1">attname</span><span class="s3">] = </span><span class="s1">value</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">field_node</span><span class="s3">.</span><span class="s1">getElementsByTagName</span><span class="s3">(</span><span class="s4">&quot;None&quot;</span><span class="s3">):</span>
                    <span class="s1">value </span><span class="s3">= </span><span class="s2">None</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">value </span><span class="s3">= </span><span class="s1">field</span><span class="s3">.</span><span class="s1">to_python</span><span class="s3">(</span><span class="s1">getInnerText</span><span class="s3">(</span><span class="s1">field_node</span><span class="s3">).</span><span class="s1">strip</span><span class="s3">())</span>
                    <span class="s6"># Load value since JSONField.to_python() outputs strings.</span>
                    <span class="s2">if </span><span class="s1">field</span><span class="s3">.</span><span class="s1">get_internal_type</span><span class="s3">() == </span><span class="s4">&quot;JSONField&quot;</span><span class="s3">:</span>
                        <span class="s1">value </span><span class="s3">= </span><span class="s1">json</span><span class="s3">.</span><span class="s1">loads</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">cls</span><span class="s3">=</span><span class="s1">field</span><span class="s3">.</span><span class="s1">decoder</span><span class="s3">)</span>
                <span class="s1">data</span><span class="s3">[</span><span class="s1">field</span><span class="s3">.</span><span class="s1">name</span><span class="s3">] = </span><span class="s1">value</span>

        <span class="s1">obj </span><span class="s3">= </span><span class="s1">base</span><span class="s3">.</span><span class="s1">build_instance</span><span class="s3">(</span><span class="s1">Model</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>

        <span class="s6"># Return a DeserializedObject so that the m2m data has a place to live.</span>
        <span class="s2">return </span><span class="s1">base</span><span class="s3">.</span><span class="s1">DeserializedObject</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">m2m_data</span><span class="s3">, </span><span class="s1">deferred_fields</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_handle_fk_field_node</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">node</span><span class="s3">, </span><span class="s1">field</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Handle a &lt;field&gt; node for a ForeignKey 
        &quot;&quot;&quot;</span>
        <span class="s6"># Check if there is a child node named 'None', returning None if so.</span>
        <span class="s2">if </span><span class="s1">node</span><span class="s3">.</span><span class="s1">getElementsByTagName</span><span class="s3">(</span><span class="s4">&quot;None&quot;</span><span class="s3">):</span>
            <span class="s2">return None</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">model </span><span class="s3">= </span><span class="s1">field</span><span class="s3">.</span><span class="s1">remote_field</span><span class="s3">.</span><span class="s1">model</span>
            <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">model</span><span class="s3">.</span><span class="s1">_default_manager</span><span class="s3">, </span><span class="s4">&quot;get_by_natural_key&quot;</span><span class="s3">):</span>
                <span class="s1">keys </span><span class="s3">= </span><span class="s1">node</span><span class="s3">.</span><span class="s1">getElementsByTagName</span><span class="s3">(</span><span class="s4">&quot;natural&quot;</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">keys</span><span class="s3">:</span>
                    <span class="s6"># If there are 'natural' subelements, it must be a natural key</span>
                    <span class="s1">field_value </span><span class="s3">= [</span><span class="s1">getInnerText</span><span class="s3">(</span><span class="s1">k</span><span class="s3">).</span><span class="s1">strip</span><span class="s3">() </span><span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">keys</span><span class="s3">]</span>
                    <span class="s2">try</span><span class="s3">:</span>
                        <span class="s1">obj </span><span class="s3">= </span><span class="s1">model</span><span class="s3">.</span><span class="s1">_default_manager</span><span class="s3">.</span><span class="s1">db_manager</span><span class="s3">(</span>
                            <span class="s1">self</span><span class="s3">.</span><span class="s1">db</span>
                        <span class="s3">).</span><span class="s1">get_by_natural_key</span><span class="s3">(*</span><span class="s1">field_value</span><span class="s3">)</span>
                    <span class="s2">except </span><span class="s1">ObjectDoesNotExist</span><span class="s3">:</span>
                        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">handle_forward_references</span><span class="s3">:</span>
                            <span class="s2">return </span><span class="s1">base</span><span class="s3">.</span><span class="s1">DEFER_FIELD</span>
                        <span class="s2">else</span><span class="s3">:</span>
                            <span class="s2">raise</span>
                    <span class="s1">obj_pk </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">field</span><span class="s3">.</span><span class="s1">remote_field</span><span class="s3">.</span><span class="s1">field_name</span><span class="s3">)</span>
                    <span class="s6"># If this is a natural foreign key to an object that</span>
                    <span class="s6"># has a FK/O2O as the foreign key, use the FK value</span>
                    <span class="s2">if </span><span class="s1">field</span><span class="s3">.</span><span class="s1">remote_field</span><span class="s3">.</span><span class="s1">model</span><span class="s3">.</span><span class="s1">_meta</span><span class="s3">.</span><span class="s1">pk</span><span class="s3">.</span><span class="s1">remote_field</span><span class="s3">:</span>
                        <span class="s1">obj_pk </span><span class="s3">= </span><span class="s1">obj_pk</span><span class="s3">.</span><span class="s1">pk</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s6"># Otherwise, treat like a normal PK</span>
                    <span class="s1">field_value </span><span class="s3">= </span><span class="s1">getInnerText</span><span class="s3">(</span><span class="s1">node</span><span class="s3">).</span><span class="s1">strip</span><span class="s3">()</span>
                    <span class="s1">obj_pk </span><span class="s3">= </span><span class="s1">model</span><span class="s3">.</span><span class="s1">_meta</span><span class="s3">.</span><span class="s1">get_field</span><span class="s3">(</span>
                        <span class="s1">field</span><span class="s3">.</span><span class="s1">remote_field</span><span class="s3">.</span><span class="s1">field_name</span>
                    <span class="s3">).</span><span class="s1">to_python</span><span class="s3">(</span><span class="s1">field_value</span><span class="s3">)</span>
                <span class="s2">return </span><span class="s1">obj_pk</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">field_value </span><span class="s3">= </span><span class="s1">getInnerText</span><span class="s3">(</span><span class="s1">node</span><span class="s3">).</span><span class="s1">strip</span><span class="s3">()</span>
                <span class="s2">return </span><span class="s1">model</span><span class="s3">.</span><span class="s1">_meta</span><span class="s3">.</span><span class="s1">get_field</span><span class="s3">(</span><span class="s1">field</span><span class="s3">.</span><span class="s1">remote_field</span><span class="s3">.</span><span class="s1">field_name</span><span class="s3">).</span><span class="s1">to_python</span><span class="s3">(</span>
                    <span class="s1">field_value</span>
                <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_handle_m2m_field_node</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">node</span><span class="s3">, </span><span class="s1">field</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Handle a &lt;field&gt; node for a ManyToManyField. 
        &quot;&quot;&quot;</span>
        <span class="s1">model </span><span class="s3">= </span><span class="s1">field</span><span class="s3">.</span><span class="s1">remote_field</span><span class="s3">.</span><span class="s1">model</span>
        <span class="s1">default_manager </span><span class="s3">= </span><span class="s1">model</span><span class="s3">.</span><span class="s1">_default_manager</span>
        <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">default_manager</span><span class="s3">, </span><span class="s4">&quot;get_by_natural_key&quot;</span><span class="s3">):</span>

            <span class="s2">def </span><span class="s1">m2m_convert</span><span class="s3">(</span><span class="s1">n</span><span class="s3">):</span>
                <span class="s1">keys </span><span class="s3">= </span><span class="s1">n</span><span class="s3">.</span><span class="s1">getElementsByTagName</span><span class="s3">(</span><span class="s4">&quot;natural&quot;</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">keys</span><span class="s3">:</span>
                    <span class="s6"># If there are 'natural' subelements, it must be a natural key</span>
                    <span class="s1">field_value </span><span class="s3">= [</span><span class="s1">getInnerText</span><span class="s3">(</span><span class="s1">k</span><span class="s3">).</span><span class="s1">strip</span><span class="s3">() </span><span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">keys</span><span class="s3">]</span>
                    <span class="s1">obj_pk </span><span class="s3">= (</span>
                        <span class="s1">default_manager</span><span class="s3">.</span><span class="s1">db_manager</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>
                        <span class="s3">.</span><span class="s1">get_by_natural_key</span><span class="s3">(*</span><span class="s1">field_value</span><span class="s3">)</span>
                        <span class="s3">.</span><span class="s1">pk</span>
                    <span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s6"># Otherwise, treat like a normal PK value.</span>
                    <span class="s1">obj_pk </span><span class="s3">= </span><span class="s1">model</span><span class="s3">.</span><span class="s1">_meta</span><span class="s3">.</span><span class="s1">pk</span><span class="s3">.</span><span class="s1">to_python</span><span class="s3">(</span><span class="s1">n</span><span class="s3">.</span><span class="s1">getAttribute</span><span class="s3">(</span><span class="s4">&quot;pk&quot;</span><span class="s3">))</span>
                <span class="s2">return </span><span class="s1">obj_pk</span>

        <span class="s2">else</span><span class="s3">:</span>

            <span class="s2">def </span><span class="s1">m2m_convert</span><span class="s3">(</span><span class="s1">n</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s1">model</span><span class="s3">.</span><span class="s1">_meta</span><span class="s3">.</span><span class="s1">pk</span><span class="s3">.</span><span class="s1">to_python</span><span class="s3">(</span><span class="s1">n</span><span class="s3">.</span><span class="s1">getAttribute</span><span class="s3">(</span><span class="s4">&quot;pk&quot;</span><span class="s3">))</span>

        <span class="s1">values </span><span class="s3">= []</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">c </span><span class="s2">in </span><span class="s1">node</span><span class="s3">.</span><span class="s1">getElementsByTagName</span><span class="s3">(</span><span class="s4">&quot;object&quot;</span><span class="s3">):</span>
                <span class="s1">values</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">m2m_convert</span><span class="s3">(</span><span class="s1">c</span><span class="s3">))</span>
        <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s1">ObjectDoesNotExist</span><span class="s3">) </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">handle_forward_references</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">base</span><span class="s3">.</span><span class="s1">DEFER_FIELD</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">base</span><span class="s3">.</span><span class="s1">M2MDeserializationError</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s1">c</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">values</span>

    <span class="s2">def </span><span class="s1">_get_model_from_node</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">node</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Look up a model from a &lt;object model=...&gt; or a &lt;field rel=... to=...&gt; 
        node. 
        &quot;&quot;&quot;</span>
        <span class="s1">model_identifier </span><span class="s3">= </span><span class="s1">node</span><span class="s3">.</span><span class="s1">getAttribute</span><span class="s3">(</span><span class="s1">attr</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">model_identifier</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">base</span><span class="s3">.</span><span class="s1">DeserializationError</span><span class="s3">(</span>
                <span class="s4">&quot;&lt;%s&gt; node is missing the required '%s' attribute&quot;</span>
                <span class="s3">% (</span><span class="s1">node</span><span class="s3">.</span><span class="s1">nodeName</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">)</span>
            <span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">apps</span><span class="s3">.</span><span class="s1">get_model</span><span class="s3">(</span><span class="s1">model_identifier</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s3">(</span><span class="s1">LookupError</span><span class="s3">, </span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s2">raise </span><span class="s1">base</span><span class="s3">.</span><span class="s1">DeserializationError</span><span class="s3">(</span>
                <span class="s4">&quot;&lt;%s&gt; node has invalid model identifier: '%s'&quot;</span>
                <span class="s3">% (</span><span class="s1">node</span><span class="s3">.</span><span class="s1">nodeName</span><span class="s3">, </span><span class="s1">model_identifier</span><span class="s3">)</span>
            <span class="s3">)</span>


<span class="s2">def </span><span class="s1">getInnerText</span><span class="s3">(</span><span class="s1">node</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Get all the inner text of a DOM node (recursively).&quot;&quot;&quot;</span>
    <span class="s6"># inspired by https://mail.python.org/pipermail/xml-sig/2005-March/011022.html</span>
    <span class="s1">inner_text </span><span class="s3">= []</span>
    <span class="s2">for </span><span class="s1">child </span><span class="s2">in </span><span class="s1">node</span><span class="s3">.</span><span class="s1">childNodes</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s3">(</span>
            <span class="s1">child</span><span class="s3">.</span><span class="s1">nodeType </span><span class="s3">== </span><span class="s1">child</span><span class="s3">.</span><span class="s1">TEXT_NODE</span>
            <span class="s2">or </span><span class="s1">child</span><span class="s3">.</span><span class="s1">nodeType </span><span class="s3">== </span><span class="s1">child</span><span class="s3">.</span><span class="s1">CDATA_SECTION_NODE</span>
        <span class="s3">):</span>
            <span class="s1">inner_text</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">child</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">child</span><span class="s3">.</span><span class="s1">nodeType </span><span class="s3">== </span><span class="s1">child</span><span class="s3">.</span><span class="s1">ELEMENT_NODE</span><span class="s3">:</span>
            <span class="s1">inner_text</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">getInnerText</span><span class="s3">(</span><span class="s1">child</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">pass</span>
    <span class="s2">return </span><span class="s4">&quot;&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">inner_text</span><span class="s3">)</span>


<span class="s6"># Below code based on Christian Heimes' defusedxml</span>


<span class="s2">class </span><span class="s1">DefusedExpatParser</span><span class="s3">(</span><span class="s1">_ExpatParser</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    An expat parser hardened against XML bomb attacks. 
 
    Forbid DTDs, external entity references 
    &quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setFeature</span><span class="s3">(</span><span class="s1">handler</span><span class="s3">.</span><span class="s1">feature_external_ges</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setFeature</span><span class="s3">(</span><span class="s1">handler</span><span class="s3">.</span><span class="s1">feature_external_pes</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">start_doctype_decl</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">sysid</span><span class="s3">, </span><span class="s1">pubid</span><span class="s3">, </span><span class="s1">has_internal_subset</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">DTDForbidden</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">sysid</span><span class="s3">, </span><span class="s1">pubid</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">entity_decl</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">is_parameter_entity</span><span class="s3">, </span><span class="s1">value</span><span class="s3">, </span><span class="s1">base</span><span class="s3">, </span><span class="s1">sysid</span><span class="s3">, </span><span class="s1">pubid</span><span class="s3">, </span><span class="s1">notation_name</span>
    <span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">EntitiesForbidden</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">value</span><span class="s3">, </span><span class="s1">base</span><span class="s3">, </span><span class="s1">sysid</span><span class="s3">, </span><span class="s1">pubid</span><span class="s3">, </span><span class="s1">notation_name</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">unparsed_entity_decl</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">base</span><span class="s3">, </span><span class="s1">sysid</span><span class="s3">, </span><span class="s1">pubid</span><span class="s3">, </span><span class="s1">notation_name</span><span class="s3">):</span>
        <span class="s6"># expat 1.2</span>
        <span class="s2">raise </span><span class="s1">EntitiesForbidden</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s1">base</span><span class="s3">, </span><span class="s1">sysid</span><span class="s3">, </span><span class="s1">pubid</span><span class="s3">, </span><span class="s1">notation_name</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">external_entity_ref_handler</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">context</span><span class="s3">, </span><span class="s1">base</span><span class="s3">, </span><span class="s1">sysid</span><span class="s3">, </span><span class="s1">pubid</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">ExternalReferenceForbidden</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">base</span><span class="s3">, </span><span class="s1">sysid</span><span class="s3">, </span><span class="s1">pubid</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">reset</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">_ExpatParser</span><span class="s3">.</span><span class="s1">reset</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
        <span class="s1">parser </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_parser</span>
        <span class="s1">parser</span><span class="s3">.</span><span class="s1">StartDoctypeDeclHandler </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">start_doctype_decl</span>
        <span class="s1">parser</span><span class="s3">.</span><span class="s1">EntityDeclHandler </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">entity_decl</span>
        <span class="s1">parser</span><span class="s3">.</span><span class="s1">UnparsedEntityDeclHandler </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">unparsed_entity_decl</span>
        <span class="s1">parser</span><span class="s3">.</span><span class="s1">ExternalEntityRefHandler </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">external_entity_ref_handler</span>


<span class="s2">class </span><span class="s1">DefusedXmlException</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Base exception.&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__repr__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">str</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">DTDForbidden</span><span class="s3">(</span><span class="s1">DefusedXmlException</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Document type definition is forbidden.&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">sysid</span><span class="s3">, </span><span class="s1">pubid</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">sysid </span><span class="s3">= </span><span class="s1">sysid</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">pubid </span><span class="s3">= </span><span class="s1">pubid</span>

    <span class="s2">def </span><span class="s1">__str__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">tpl </span><span class="s3">= </span><span class="s4">&quot;DTDForbidden(name='{}', system_id={!r}, public_id={!r})&quot;</span>
        <span class="s2">return </span><span class="s1">tpl</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sysid</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pubid</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">EntitiesForbidden</span><span class="s3">(</span><span class="s1">DefusedXmlException</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Entity definition is forbidden.&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">value</span><span class="s3">, </span><span class="s1">base</span><span class="s3">, </span><span class="s1">sysid</span><span class="s3">, </span><span class="s1">pubid</span><span class="s3">, </span><span class="s1">notation_name</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">value </span><span class="s3">= </span><span class="s1">value</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">base </span><span class="s3">= </span><span class="s1">base</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">sysid </span><span class="s3">= </span><span class="s1">sysid</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">pubid </span><span class="s3">= </span><span class="s1">pubid</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">notation_name </span><span class="s3">= </span><span class="s1">notation_name</span>

    <span class="s2">def </span><span class="s1">__str__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">tpl </span><span class="s3">= </span><span class="s4">&quot;EntitiesForbidden(name='{}', system_id={!r}, public_id={!r})&quot;</span>
        <span class="s2">return </span><span class="s1">tpl</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sysid</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pubid</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">ExternalReferenceForbidden</span><span class="s3">(</span><span class="s1">DefusedXmlException</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Resolving an external reference is forbidden.&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">context</span><span class="s3">, </span><span class="s1">base</span><span class="s3">, </span><span class="s1">sysid</span><span class="s3">, </span><span class="s1">pubid</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">context </span><span class="s3">= </span><span class="s1">context</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">base </span><span class="s3">= </span><span class="s1">base</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">sysid </span><span class="s3">= </span><span class="s1">sysid</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">pubid </span><span class="s3">= </span><span class="s1">pubid</span>

    <span class="s2">def </span><span class="s1">__str__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">tpl </span><span class="s3">= </span><span class="s4">&quot;ExternalReferenceForbidden(system_id='{}', public_id={})&quot;</span>
        <span class="s2">return </span><span class="s1">tpl</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">sysid</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pubid</span><span class="s3">)</span>
</pre>
</body>
</html>